{
  "$id": "https://workbench.ai/schema/CanonicalArchitectureV1.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "CanonicalArchitectureV1",
  "type": "object",
  "additionalProperties": false,
  "required": ["type", "version", "sections"],
  "properties": {
    "type": {
      "const": "canonical_architecture"
    },
    "version": {
      "const": 1
    },
    "sections": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "summary",
        "diagram",
        "components",
        "data_model",
        "key_decisions",
        "non_functional_requirements",
        "deployment",
        "tech_stack_summary",
        "roadmap_implications",
        "risks_and_mitigations",
        "out_of_scope"
      ],
      "properties": {
        "summary": { "$ref": "#/$defs/section" },
        "diagram": { "$ref": "#/$defs/section" },
        "components": { "$ref": "#/$defs/section" },
        "data_model": { "$ref": "#/$defs/section" },
        "key_decisions": { "$ref": "#/$defs/section" },
        "non_functional_requirements": { "$ref": "#/$defs/section" },
        "deployment": { "$ref": "#/$defs/section" },
        "tech_stack_summary": { "$ref": "#/$defs/section" },
        "roadmap_implications": { "$ref": "#/$defs/section" },
        "risks_and_mitigations": { "$ref": "#/$defs/section" },
        "out_of_scope": { "$ref": "#/$defs/section" }
      }
    }
  },
  "$defs": {
    "section": {
      "type": "object",
      "additionalProperties": false,
      "required": ["blocks"],
      "properties": {
        "blocks": {
          "type": "array",
          "minItems": 1,
          "$comment": "Block ID uniqueness within this array is enforced at application level (Pydantic validator).",
          "items": { "$ref": "#/$defs/block" }
        }
      }
    },
    "block": {
      "type": "object",
      "required": ["id", "type"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": {
          "type": "string",
          "enum": [
            "paragraph",
            "heading",
            "code",
            "list_item",
            "component",
            "entity",
            "decision",
            "risk",
            "table",
            "key_value"
          ]
        }
      },
      "allOf": [
        { "$ref": "#/$defs/blockByType" }
      ]
    },
    "blockByType": {
      "oneOf": [
        {
          "properties": {
            "type": { "const": "paragraph" },
            "content": { "type": "string", "minLength": 1 }
          },
          "required": ["content"],
          "additionalProperties": false
        },
        {
          "properties": {
            "type": { "const": "heading" },
            "level": { "type": "integer", "minimum": 1, "maximum": 6 },
            "content": { "type": "string", "minLength": 1 }
          },
          "required": ["level", "content"],
          "additionalProperties": false
        },
        {
          "properties": {
            "type": { "const": "code" },
            "language": { "type": "string", "minLength": 1 },
            "content": { "type": "string", "minLength": 1 }
          },
          "required": ["language", "content"],
          "additionalProperties": false
        },
        {
          "properties": {
            "type": { "const": "list_item" },
            "content": { "type": "string", "minLength": 1 }
          },
          "required": ["content"],
          "additionalProperties": false
        },
        {
          "properties": {
            "type": { "const": "component" },
            "data": {
              "type": "object",
              "additionalProperties": false,
              "required": ["name", "layer", "tech", "responsibilities", "rationale"],
              "properties": {
                "name": { "type": "string", "minLength": 1 },
                "layer": { "type": "string", "minLength": 1 },
                "tech": { "type": "string", "minLength": 1 },
                "responsibilities": {
                  "type": "array",
                  "minItems": 1,
                  "items": { "type": "string", "minLength": 1 }
                },
                "rationale": { "type": "string", "minLength": 1 }
              }
            }
          },
          "required": ["data"],
          "additionalProperties": false
        },
        {
          "properties": {
            "type": { "const": "entity" },
            "data": {
              "type": "object",
              "additionalProperties": false,
              "required": ["name", "fields"],
              "properties": {
                "name": { "type": "string", "minLength": 1 },
                "fields": {
                  "type": "array",
                  "minItems": 1,
                  "items": { "type": "string", "minLength": 1 }
                },
                "relationships": {
                  "type": "array",
                  "items": { "type": "string", "minLength": 1 }
                },
                "indexes": {
                  "type": "array",
                  "items": { "type": "string", "minLength": 1 }
                }
              }
            }
          },
          "required": ["data"],
          "additionalProperties": false
        },
        {
          "properties": {
            "type": { "const": "decision" },
            "data": {
              "type": "object",
              "additionalProperties": false,
              "required": ["title", "decision", "alternatives", "rationale", "tradeoff"],
              "properties": {
                "title": { "type": "string", "minLength": 1 },
                "decision": { "type": "string", "minLength": 1 },
                "alternatives": {
                  "type": "array",
                  "minItems": 1,
                  "items": { "type": "string", "minLength": 1 }
                },
                "rationale": {
                  "type": "array",
                  "minItems": 1,
                  "items": { "type": "string", "minLength": 1 }
                },
                "tradeoff": { "type": "string", "minLength": 1 }
              }
            }
          },
          "required": ["data"],
          "additionalProperties": false
        },
        {
          "properties": {
            "type": { "const": "risk" },
            "data": {
              "type": "object",
              "additionalProperties": false,
              "required": ["risk", "likelihood", "impact", "description", "mitigation"],
              "properties": {
                "risk": { "type": "string", "minLength": 1 },
                "likelihood": { "enum": ["Low", "Medium", "High"] },
                "impact": { "enum": ["Low", "Medium", "High"] },
                "description": { "type": "string", "minLength": 1 },
                "mitigation": {
                  "type": "array",
                  "minItems": 1,
                  "items": { "type": "string", "minLength": 1 }
                }
              }
            }
          },
          "required": ["data"],
          "additionalProperties": false
        },
        {
          "properties": {
            "type": { "const": "table" },
            "data": {
              "type": "object",
              "additionalProperties": false,
              "required": ["headers", "rows"],
              "properties": {
                "headers": {
                  "type": "array",
                  "minItems": 1,
                  "items": { "type": "string", "minLength": 1 }
                },
                "rows": {
                  "type": "array",
                  "items": {
                    "type": "array",
                    "items": { "type": "string" }
                  },
                  "$comment": "Application-level validator must ensure each row length equals headers.length."
                }
              }
            }
          },
          "required": ["data"],
          "additionalProperties": false
        },
        {
          "properties": {
            "type": { "const": "key_value" },
            "data": {
              "type": "object",
              "additionalProperties": { "type": "string" },
              "minProperties": 1
            }
          },
          "required": ["data"],
          "additionalProperties": false
        }
      ]
    }
  }
}