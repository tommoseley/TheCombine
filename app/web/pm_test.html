<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM Mentor Test - Release 1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        /* Main Layout - Three Panes */
        .layout {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            height: 100vh;
            gap: 0;
        }

        /* Left Pane */
        .left-pane {
            background: #2c3e50;
            color: white;
            padding: 24px;
            overflow-y: auto;
        }

        .left-pane h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #3498db;
        }

        .left-pane .subtitle {
            font-size: 14px;
            color: #bdc3c7;
            margin-bottom: 24px;
        }

        .caution-box {
            background: #e74c3c;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .caution-box h3 {
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .caution-box p {
            font-size: 13px;
            line-height: 1.5;
            opacity: 0.9;
        }

        .info-section {
            margin-bottom: 24px;
        }

        .info-section h3 {
            font-size: 14px;
            color: #3498db;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-section p {
            font-size: 13px;
            line-height: 1.6;
            color: #ecf0f1;
            margin-bottom: 8px;
        }

        /* Right Pane */
        .right-pane {
            background: #34495e;
            color: white;
            padding: 24px;
            overflow-y: auto;
        }

        .right-pane h2 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #3498db;
        }

        .model-selector {
            margin-bottom: 32px;
        }

        .model-selector label {
            display: block;
            font-size: 13px;
            margin-bottom: 8px;
            color: #bdc3c7;
        }

        .model-selector select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #2c3e50;
            background: #2c3e50;
            color: white;
            font-size: 14px;
        }

        .metadata-box {
            background: #2c3e50;
            border-radius: 8px;
            padding: 16px;
        }

        .metadata-box h3 {
            font-size: 14px;
            margin-bottom: 16px;
            color: #3498db;
        }

        .metadata-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #34495e;
            font-size: 13px;
        }

        .metadata-item:last-child {
            border-bottom: none;
        }

        .metadata-label {
            color: #bdc3c7;
        }

        .metadata-value {
            font-weight: 500;
            color: white;
        }

        .validation-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .validation-badge.valid {
            background: #27ae60;
            color: white;
        }

        .validation-badge.invalid {
            background: #e74c3c;
            color: white;
        }

        /* Center Pane */
        .center-pane {
            background: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Fixed Query Panel */
        .query-panel {
            background: white;
            border-bottom: 2px solid #e0e0e0;
            padding: 24px;
            flex-shrink: 0;
        }

        .query-panel h2 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #2c3e50;
        }

        .query-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .query-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-preview {
            background: #95a5a6;
            color: white;
        }

        .btn-preview:hover {
            background: #7f8c8d;
        }

        .btn-execute {
            background: #3498db;
            color: white;
        }

        .btn-execute:hover {
            background: #2980b9;
        }

        .btn-architect {
            background: #e67e22;
            color: white;
        }

        .btn-architect:hover {
            background: #d35400;
        }

        .btn-ba {
            background: #9b59b6;
            color: white;
        }

        .btn-ba:hover {
            background: #8e44ad;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Tabs */
        .tabs-container {
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            padding: 0 24px;
            display: flex;
            gap: 4px;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: #7f8c8d;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #2c3e50;
            background: rgba(52, 152, 219, 0.05);
        }

        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        /* Scrollable Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Markdown Formatted Content */
        .markdown-content {
            line-height: 1.6;
            color: #2c3e50;
        }

        .markdown-content h1 {
            font-size: 28px;
            margin: 24px 0 16px 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .markdown-content h2 {
            font-size: 22px;
            margin: 20px 0 12px 0;
            color: #34495e;
        }

        .markdown-content h3 {
            font-size: 18px;
            margin: 16px 0 10px 0;
            color: #7f8c8d;
        }

        .markdown-content h4 {
            font-size: 16px;
            margin: 14px 0 8px 0;
            color: #95a5a6;
        }

        .markdown-content p {
            margin: 0 0 12px 0;
        }

        .markdown-content ul, .markdown-content ol {
            margin: 0 0 12px 24px;
        }

        .markdown-content li {
            margin: 6px 0;
        }

        .markdown-content strong {
            color: #2c3e50;
            font-weight: 600;
        }

        .markdown-content code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .markdown-content .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .markdown-content .badge-mvp {
            background: #3498db;
            color: white;
        }

        .markdown-content .badge-later {
            background: #95a5a6;
            color: white;
        }

        .markdown-content .component-card {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 16px;
            margin: 12px 0;
            border-radius: 4px;
        }

        .markdown-content .story-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            padding: 16px;
            margin: 12px 0;
            border-radius: 6px;
        }

        .markdown-content .story-card h4 {
            margin-top: 0;
            color: #2c3e50;
        }

        /* JSON Content (existing styles) */
        .section {
            margin-bottom: 32px;
        }

        .section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-icon {
            font-size: 20px;
        }

        .code-block {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #2c3e50;
            line-height: 1.5;
        }

        .json-block {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 6px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre;
            line-height: 1.5;
        }

        .validation-success {
            background: #d5f4e6;
            border: 1px solid #27ae60;
            border-radius: 6px;
            padding: 16px;
            color: #27ae60;
        }

        .validation-errors {
            background: #fadbd8;
            border: 1px solid #e74c3c;
            border-radius: 6px;
            padding: 16px;
        }

        .validation-errors h4 {
            color: #e74c3c;
            margin-bottom: 12px;
        }

        .error-item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 13px;
        }

        .error {
            background: #fadbd8;
            border: 1px solid #e74c3c;
            border-radius: 6px;
            padding: 16px;
            color: #c0392b;
            font-size: 14px;
            line-height: 1.6;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px;
            color: #7f8c8d;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #ecf0f1;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- Left Pane -->
        <div class="left-pane">
            <h1>üß† PM Mentor</h1>
            <div class="subtitle">Release 1 Test Harness</div>

            <div class="caution-box">
                <h3>‚ö†Ô∏è Caution</h3>
                <p>Each request costs real money via Anthropic's API. Preview mode is free but Execute mode charges per token.</p>
            </div>

            <div class="info-section">
                <h3>About</h3>
                <p>This interface tests the PM Mentor's ability to transform a simple query into a complete, validated Epic.</p>
                <p>Enter a product idea and let the PM Mentor structure it into goals, stories, and acceptance criteria.</p>
            </div>

            <div class="info-section">
                <h3>Modes</h3>
                <p><strong>Preview:</strong> See the prepared prompt without executing. No API calls, no cost.</p>
                <p><strong>Execute:</strong> Send request to Claude and get full Epic response. Costs tokens.</p>
            </div>

            <div class="info-section">
                <h3>Pipeline</h3>
                <p>After executing PM, you can forward the validated Epic to the Architect Mentor for technical design.</p>
            </div>
        </div>

        <!-- Center Pane -->
        <div class="center-pane">
            <!-- Fixed Query Panel -->
            <div class="query-panel">
                <h2>üìù Epic Query</h2>
                <textarea 
                    id="queryInput" 
                    class="query-input" 
                    placeholder="Enter your product idea... e.g., 'Build a grade-school math testing website'"
                >Build a grade-school math testing website</textarea>
                <div class="button-group">
                    <button class="btn btn-preview" onclick="previewRequest()">
                        üëÅÔ∏è Preview
                    </button>
                    <button class="btn btn-execute" onclick="executeRequest()">
                        üöÄ Execute
                    </button>
                    <button class="btn btn-architect" id="forwardBtn" onclick="forwardToArchitect()" style="display: none;">
                        üèóÔ∏è Forward to Architect
                    </button>
                    <button class="btn btn-ba" id="forwardBABtn" onclick="forwardToBA()" style="display: none;">
                        üìã Forward to BA
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs-container">
                <button class="tab active" onclick="switchTab('data')">üìä Data</button>
                <button class="tab" onclick="switchTab('json')">üîß JSON</button>
            </div>

            <!-- Scrollable Content Area -->
            <div class="content-area" id="contentArea">
                <div id="dataContent" class="tab-content active">
                    <p style="color: #7f8c8d; text-align: center; padding: 48px;">
                        Execute a request to see formatted results
                    </p>
                </div>
                <div id="jsonContent" class="tab-content">
                    <p style="color: #7f8c8d; text-align: center; padding: 48px;">
                        Execute a request to see raw JSON
                    </p>
                </div>
            </div>
        </div>

        <!-- Right Pane -->
        <div class="right-pane">
            <h2>‚öôÔ∏è Settings</h2>
            
            <div class="model-selector">
                <label for="modelSelect">Model</label>
                <select id="modelSelect">
                    <option value="claude-sonnet-4-20250514">Claude Sonnet 4 (Recommended)</option>
                    <option value="claude-opus-4-20250514">Claude Opus 4 (Premium)</option>
                </select>
            </div>

            <div id="metadataBox" class="metadata-box" style="display: none;">
                <h3>üìä Metadata</h3>
                <div id="metadataContent"></div>
            </div>
        </div>
    </div>

    <script>
        let currentResponse = null;
        let currentArchitectResponse = null;
        let currentBAResponse = null;

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'data') {
                document.getElementById('dataContent').classList.add('active');
            } else {
                document.getElementById('jsonContent').classList.add('active');
            }
        }

        async function previewRequest() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) {
                alert('Please enter a query first');
                return;
            }

            const dataContent = document.getElementById('dataContent');
            const jsonContent = document.getElementById('jsonContent');
            
            dataContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading preview...</p>
                </div>
            `;

            try {
                const response = await fetch('/api/pm/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        user_query: query,
                        project_id: "DEMO"  // Add this
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();
                
                // Data tab - formatted view
                dataContent.innerHTML = `
                    <div class="markdown-content">
                        <h1>üîç Preview Mode</h1>
                        <p><em>This shows what will be sent to Claude. No API call is made in preview mode.</em></p>
                        
                        <h2>System Prompt</h2>
                        <div class="code-block">${escapeHtml(data.system_prompt)}</div>
                        
                        <h2>User Message</h2>
                        <div class="code-block">${escapeHtml(data.user_message)}</div>
                        
                        <h2>Expected Schema</h2>
                        <div class="code-block">${JSON.stringify(data.expected_schema, null, 2)}</div>
                        
                        <h2>Configuration</h2>
                        <ul>
                            <li><strong>Model:</strong> ${data.model}</li>
                            <li><strong>Max Tokens:</strong> ${data.max_tokens}</li>
                            <li><strong>Temperature:</strong> ${data.temperature}</li>
                            <li><strong>Estimated Input Tokens:</strong> ~${data.estimated_input_tokens}</li>
                        </ul>
                    </div>
                `;

                // JSON tab - raw data
                jsonContent.innerHTML = `
                    <div class="section">
                        <h3><span class="section-icon">üîß</span> Raw Preview Data</h3>
                        <div class="json-block">${JSON.stringify(data, null, 2)}</div>
                    </div>
                `;

                document.getElementById('metadataBox').style.display = 'none';
            } catch (error) {
                displayError('Preview Failed', error.message);
            }
        }

        async function executeRequest() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) {
                alert('Please enter a query first');
                return;
            }

            const dataContent = document.getElementById('dataContent');
            const jsonContent = document.getElementById('jsonContent');
            
            dataContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Executing request...</p>
                </div>
            `;

            try {
                const response = await fetch('/api/pm/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        user_query: query,
                        project_id: "DEMO"  // Add this
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();
                currentResponse = data;
                displayExecution(data);
                
                // Show "Forward to Architect" button if validation passed
                if (data.validation_result && data.validation_result.valid) {
                    document.getElementById('forwardBtn').style.display = 'inline-block';
                }
            } catch (error) {
                displayError('Execution Failed', error.message);
            }
        }

        function displayExecution(data) {
            const dataContent = document.getElementById('dataContent');
            const jsonContent = document.getElementById('jsonContent');

            // Data tab - formatted markdown view
            if (data.validation_result && data.validation_result.valid && data.validation_result.validated_data) {
                dataContent.innerHTML = formatEpicAsMarkdown(data.validation_result.validated_data);
            } else {
                dataContent.innerHTML = `
                    <div class="markdown-content">
                        <h1>‚ùå Validation Failed</h1>
                        ${displayValidation(data.validation_result)}
                    </div>
                `;
            }

            // JSON tab - raw data view
            jsonContent.innerHTML = `
                <div class="section">
                    <h3><span class="section-icon">üì•</span> Raw PM Response</h3>
                    <div class="code-block">${escapeHtml(data.raw_response)}</div>
                </div>

                <div class="section">
                    <h3><span class="section-icon">üîç</span> Parsed Epic JSON</h3>
                    ${data.parsed_json 
                        ? `<div class="json-block">${JSON.stringify(data.parsed_json, null, 2)}</div>`
                        : '<div class="error">Failed to parse JSON from response</div>'
                    }
                </div>

                <div class="section">
                    <h3><span class="section-icon">‚úÖ</span> Validation Result</h3>
                    ${displayValidation(data.validation_result)}
                </div>
            `;

            displayMetadata(data);
        }

        function formatEpicAsMarkdown(epic) {
            let html = '<div class="markdown-content">';
            
            // Title
            html += `<h1>üìã ${escapeHtml(epic.project_name || 'Epic')}</h1>`;
            html += `<p><strong>Epic ID:</strong> <code>${escapeHtml(epic.epic_id || 'N/A')}</code></p>`;

            // Epic Summary
            if (epic.epic_summary) {
                html += `<h2>üìù Epic Summary</h2>`;
                html += `<h3>${escapeHtml(epic.epic_summary.title || '')}</h3>`;
                html += `<p>${escapeHtml(epic.epic_summary.refined_description || '')}</p>`;
                
                if (epic.epic_summary.business_value) {
                    html += `<p><strong>Business Value:</strong> ${escapeHtml(epic.epic_summary.business_value)}</p>`;
                }

                if (epic.epic_summary.primary_users && epic.epic_summary.primary_users.length > 0) {
                    html += `<p><strong>Primary Users:</strong></p><ul>`;
                    epic.epic_summary.primary_users.forEach(user => {
                        html += `<li>${escapeHtml(user)}</li>`;
                    });
                    html += `</ul>`;
                }
            }

            // Goals
            if (epic.goals && epic.goals.length > 0) {
                html += `<h2>üéØ Goals</h2><ol>`;
                epic.goals.forEach(goal => {
                    html += `<li>${escapeHtml(goal)}</li>`;
                });
                html += `</ol>`;
            }

            // Constraints
            if (epic.constraints && epic.constraints.length > 0) {
                html += `<h2>‚ö†Ô∏è Constraints</h2><ul>`;
                epic.constraints.forEach(constraint => {
                    html += `<li>${escapeHtml(constraint)}</li>`;
                });
                html += `</ul>`;
            }

            // Acceptance Criteria
            if (epic.acceptance_criteria && epic.acceptance_criteria.length > 0) {
                html += `<h2>‚úÖ Acceptance Criteria</h2><ul>`;
                epic.acceptance_criteria.forEach(criteria => {
                    html += `<li>${escapeHtml(criteria)}</li>`;
                });
                html += `</ul>`;
            }

            // Stories
            if (epic.stories && epic.stories.length > 0) {
                html += `<h2>üìñ Stories (${epic.stories.length})</h2>`;
                epic.stories.forEach((story, index) => {
                    html += `<div class="story-card">`;
                    html += `<h4>${escapeHtml(story.id || `Story ${index + 1}`)}: ${escapeHtml(story.title || 'Untitled')}</h4>`;
                    html += `<p>${escapeHtml(story.description || '')}</p>`;
                    
                    if (story.acceptance_criteria && story.acceptance_criteria.length > 0) {
                        html += `<p><strong>Acceptance Criteria:</strong></p><ul>`;
                        story.acceptance_criteria.forEach(ac => {
                            html += `<li>${escapeHtml(ac)}</li>`;
                        });
                        html += `</ul>`;
                    }
                    
                    html += `<p><em>Type: ${escapeHtml(story.type || 'N/A')}</em></p>`;
                    html += `</div>`;
                });
            }

            // Risks
            if (epic.risks && epic.risks.length > 0) {
                html += `<h2>‚ö†Ô∏è Risks</h2><ul>`;
                epic.risks.forEach(risk => {
                    html += `<li>${escapeHtml(risk)}</li>`;
                });
                html += `</ul>`;
            }

            html += '</div>';
            return html;
        }

        function formatArchitectureAsMarkdown(arch) {
            let html = '<div class="markdown-content">';
            
            // Title
            html += `<h1>üèóÔ∏è ${escapeHtml(arch.project_name || 'Architecture')}</h1>`;
            html += `<p><strong>Epic ID:</strong> <code>${escapeHtml(arch.epic_id || 'N/A')}</code></p>`;

            // Architecture Summary
            if (arch.architecture_summary) {
                html += `<h2>üìê Architecture Summary</h2>`;
                html += `<h3>${escapeHtml(arch.architecture_summary.title || '')}</h3>`;
                html += `<p>${escapeHtml(arch.architecture_summary.refined_description || '')}</p>`;
                html += `<p><strong>Style:</strong> ${escapeHtml(arch.architecture_summary.architectural_style || 'N/A')}</p>`;
                
                if (arch.architecture_summary.key_decisions && arch.architecture_summary.key_decisions.length > 0) {
                    html += `<p><strong>Key Decisions:</strong></p><ul>`;
                    arch.architecture_summary.key_decisions.forEach(decision => {
                        html += `<li>${escapeHtml(decision)}</li>`;
                    });
                    html += `</ul>`;
                }
            }

            // Components
            if (arch.components && arch.components.length > 0) {
                html += `<h2>üîß Components (${arch.components.length})</h2>`;
                arch.components.forEach(component => {
                    const badge = component.mvp_phase === 'mvp' ? 
                        '<span class="badge badge-mvp">MVP</span>' : 
                        '<span class="badge badge-later">Later</span>';
                    
                    html += `<div class="component-card">`;
                    html += `<h4>${escapeHtml(component.name || 'Unnamed')} ${badge}</h4>`;
                    html += `<p><em>${escapeHtml(component.purpose || '')}</em></p>`;
                    
                    if (component.responsibilities && component.responsibilities.length > 0) {
                        html += `<p><strong>Responsibilities:</strong></p><ul>`;
                        component.responsibilities.forEach(resp => {
                            html += `<li>${escapeHtml(resp)}</li>`;
                        });
                        html += `</ul>`;
                    }
                    
                    html += `<p><strong>Layer:</strong> ${escapeHtml(component.layer || 'N/A')}</p>`;
                    html += `</div>`;
                });
            }

            // Data Model
            if (arch.data_model && arch.data_model.length > 0) {
                html += `<h2>üìä Data Model (${arch.data_model.length} entities)</h2>`;
                arch.data_model.forEach(entity => {
                    html += `<h3>${escapeHtml(entity.name || 'Unnamed')}</h3>`;
                    html += `<p>${escapeHtml(entity.description || '')}</p>`;
                    
                    if (entity.fields && entity.fields.length > 0) {
                        html += `<p><strong>Fields:</strong></p><ul>`;
                        entity.fields.forEach(field => {
                            const required = field.required ? '(required)' : '(optional)';
                            html += `<li><code>${escapeHtml(field.name)}</code>: ${escapeHtml(field.type)} ${required}</li>`;
                        });
                        html += `</ul>`;
                    }
                });
            }

            // Quality Attributes
            if (arch.quality_attributes && arch.quality_attributes.length > 0) {
                html += `<h2>‚≠ê Quality Attributes</h2><ul>`;
                arch.quality_attributes.forEach(qa => {
                    html += `<li><strong>${escapeHtml(qa.name || '')}:</strong> ${escapeHtml(qa.target || '')}</li>`;
                });
                html += `</ul>`;
            }

            // Risks
            if (arch.risks && arch.risks.length > 0) {
                html += `<h2>‚ö†Ô∏è Risks</h2><ul>`;
                arch.risks.forEach(risk => {
                    html += `<li>${escapeHtml(risk.description || '')} <em>(${escapeHtml(risk.likelihood || 'unknown')} likelihood)</em></li>`;
                });
                html += `</ul>`;
            }

            // Stories
            if (arch.stories && arch.stories.length > 0) {
                html += `<h2>üìñ Architecture Stories (${arch.stories.length})</h2>`;
                arch.stories.forEach((story, index) => {
                    const badge = story.mvp_phase === 'mvp' ? 
                        '<span class="badge badge-mvp">MVP</span>' : 
                        '<span class="badge badge-later">Later</span>';
                    
                    html += `<div class="story-card">`;
                    html += `<h4>${escapeHtml(story.id || `Story ${index + 1}`)}: ${escapeHtml(story.title || 'Untitled')} ${badge}</h4>`;
                    html += `<p>${escapeHtml(story.description || '')}</p>`;
                    html += `<p><em>Category: ${escapeHtml(story.category || 'N/A')}</em></p>`;
                    html += `</div>`;
                });
            }

            html += '</div>';
            return html;
        }

        function displayValidation(result) {
            if (!result) {
                return '<div class="error">No validation result available</div>';
            }

            if (result.valid) {
                return `<div class="validation-success">‚úì Validation passed successfully</div>`;
            }

            let html = '<div class="validation-errors"><h4>Validation Errors:</h4>';
            
            if (result.validation_errors && result.validation_errors.length > 0) {
                result.validation_errors.forEach((error, index) => {
                    html += `<div class="error-item">`;
                    html += `<strong>Error ${index + 1}:</strong><br>`;
                    html += `<strong>Type:</strong> ${escapeHtml(error.type || 'unknown')}<br>`;
                    html += `<strong>Location:</strong> ${JSON.stringify(error.loc || [])}<br>`;
                    html += `<strong>Message:</strong> ${escapeHtml(error.msg || 'No message')}<br>`;
                    if (error.input) {
                        html += `<strong>Input:</strong> ${escapeHtml(JSON.stringify(error.input).substring(0, 200))}...`;
                    }
                    html += `</div>`;
                });
            } else {
                html += `<div class="error-item">${escapeHtml(result.error_message || 'Unknown error')}</div>`;
            }
            
            html += '</div>';
            return html;
        }

        function displayMetadata(data) {
            const metadataBox = document.getElementById('metadataBox');
            const metadataContent = document.getElementById('metadataContent');
            
            const validationBadge = data.validation_result.valid
                ? '<span class="validation-badge valid">‚úì VALID</span>'
                : '<span class="validation-badge invalid">‚úó INVALID</span>';

            metadataContent.innerHTML = `
                <div class="metadata-item">
                    <span class="metadata-label">Prompt ID</span>
                    <span class="metadata-value" style="font-size: 11px;">${data.prompt_id || 'N/A'}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Execution Time</span>
                    <span class="metadata-value">${data.execution_time_ms}ms</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Input Tokens</span>
                    <span class="metadata-value">${data.input_tokens}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Output Tokens</span>
                    <span class="metadata-value">${data.output_tokens}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Total Tokens</span>
                    <span class="metadata-value">${data.total_tokens}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Validation</span>
                    <span class="metadata-value">${validationBadge}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Timestamp</span>
                    <span class="metadata-value" style="font-size: 11px;">${data.timestamp}</span>
                </div>
            `;

            metadataBox.style.display = 'block';
        }

// REPLACE the forwardToArchitect function (around line 1082) with this:

        async function forwardToArchitect() {
            if (!currentResponse || !currentResponse.epic_artifact_path) {
                alert('No valid Epic to forward. Please execute PM request first.');
                return;
            }

            // Get the artifact path from PM response
            const epicPath = currentResponse.epic_artifact_path;
            
            const dataContent = document.getElementById('dataContent');
            const jsonContent = document.getElementById('jsonContent');
            const previousDataContent = dataContent.innerHTML;
            const previousJsonContent = jsonContent.innerHTML;
            
            dataContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Forwarding to Architect Mentor...</p>
                    <p style="font-size: 12px; opacity: 0.7;">Epic: ${epicPath}</p>
                </div>
            `;

            try {
                // Send only the artifact path, not the full content
                const response = await fetch('/api/architect/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        epic_artifact_path: epicPath  // ‚úÖ Send path, not content
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();
                currentArchitectResponse = data;
                
                // Add Architecture results to both tabs
                dataContent.innerHTML = previousDataContent + generateArchitectDataView(data);
                jsonContent.innerHTML = previousJsonContent + generateArchitectJsonView(data);
                
                // Update metadata box with combined stats
                displayCombinedMetadata(currentResponse, data);
                
                // Show "Forward to BA" button if Architecture validation passed
                if (data.validation_result && data.validation_result.valid) {
                    document.getElementById('forwardBABtn').style.display = 'inline-block';
                }
                
            } catch (error) {
                dataContent.innerHTML = previousDataContent;
                jsonContent.innerHTML = previousJsonContent;
                alert('Error forwarding to Architect:\n' + error.message);
            }
        }


        // ALSO FIND AND REPLACE the forwardToBA function (around line 1140) with this:

        async function forwardToBA() {
            if (!currentResponse || !currentResponse.epic_artifact_path) {
                alert('No valid Epic found. Please execute PM request first.');
                return;
            }
            
            if (!currentArchitectResponse || !currentArchitectResponse.architecture_artifact_path) {
                alert('No valid Architecture found. Please forward to Architect first.');
                return;
            }

            // Get the artifact paths
            const epicPath = currentResponse.epic_artifact_path;
            const archPath = currentArchitectResponse.architecture_artifact_path;
            
            const dataContent = document.getElementById('dataContent');
            const jsonContent = document.getElementById('jsonContent');
            const previousDataContent = dataContent.innerHTML;
            const previousJsonContent = jsonContent.innerHTML;
            
            dataContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Forwarding to BA Mentor...</p>
                    <p style="font-size: 12px; opacity: 0.7;">Epic: ${epicPath}</p>
                    <p style="font-size: 12px; opacity: 0.7;">Architecture: ${archPath}</p>
                </div>
            `;

            try {
                // Send artifact paths, not full content
                const response = await fetch('/api/ba/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        epic_artifact_path: epicPath,           // ‚úÖ Send paths
                        architecture_artifact_path: archPath    // ‚úÖ Not content
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();
                currentBAResponse = data;
                
                // Add BA results to both tabs
                dataContent.innerHTML = previousDataContent + generateBADataView(data);
                jsonContent.innerHTML = previousJsonContent + generateBAJsonView(data);
                
                // Update metadata box with all stats
                displayCombinedMetadata(currentResponse, currentArchitectResponse, data);
                
            } catch (error) {
                dataContent.innerHTML = previousDataContent;
                jsonContent.innerHTML = previousJsonContent;
                alert('Error forwarding to BA:\n' + error.message);
            }
        }
        function generateBADataView(data) {
            let html = `
                <div style="margin-top: 40px; padding-top: 40px; border-top: 3px solid #9b59b6;">
                    <h1 style="color: #9b59b6;">üìã BA Results</h1>
                </div>
            `;

            if (data.validation_result && data.validation_result.valid && data.validation_result.validated_data) {
                html += formatBAStoriesAsMarkdown(data.validation_result.validated_data);
            } else {
                html += `
                    <div class="markdown-content">
                        <h2>‚ùå BA Validation Failed</h2>
                        ${displayValidation(data.validation_result)}
                    </div>
                `;
            }

            return html;
        }

        function generateBAJsonView(data) {
            return `
                <div style="margin-top: 40px; padding-top: 40px; border-top: 3px solid #9b59b6;">
                    <h2 style="color: #9b59b6; font-size: 24px; margin-bottom: 24px;">
                        üìã BA Results
                    </h2>
                </div>

                <div class="section">
                    <h3><span class="section-icon">üì•</span> Raw BA Response</h3>
                    <div class="code-block">${escapeHtml(data.raw_response)}</div>
                </div>

                <div class="section">
                    <h3><span class="section-icon">üîç</span> Parsed BA JSON</h3>
                    ${data.parsed_json 
                        ? `<div class="json-block">${JSON.stringify(data.parsed_json, null, 2)}</div>`
                        : '<div class="error">Failed to parse JSON from response</div>'
                    }
                </div>

                <div class="section">
                    <h3><span class="section-icon">‚úÖ</span> BA Validation</h3>
                    ${displayValidation(data.validation_result)}
                </div>
            `;
        }

        function formatBAStoriesAsMarkdown(baStorySet) {
            let html = '<div class="markdown-content">';
            
            // Title
            html += `<h1>üìã ${escapeHtml(baStorySet.project_name || 'BA Stories')}</h1>`;
            html += `<p><strong>Epic ID:</strong> <code>${escapeHtml(baStorySet.epic_id || 'N/A')}</code></p>`;
            html += `<p><strong>Total Stories:</strong> ${baStorySet.ba_stories ? baStorySet.ba_stories.length : 0}</p>`;

            // BA Stories
            if (baStorySet.ba_stories && baStorySet.ba_stories.length > 0) {
                html += `<h2>üìñ BA Stories (${baStorySet.ba_stories.length})</h2>`;
                baStorySet.ba_stories.forEach((story, index) => {
                    const badge = story.mvp_phase === 'mvp' ? 
                        '<span class="badge badge-mvp">MVP</span>' : 
                        '<span class="badge badge-later">Later</span>';
                    
                    html += `<div class="story-card">`;
                    html += `<h4>${escapeHtml(story.id || `Story ${index + 1}`)}: ${escapeHtml(story.title || 'Untitled')} ${badge}</h4>`;
                    html += `<p>${escapeHtml(story.description || '')}</p>`;
                    
                    // Related PM Stories
                    if (story.related_pm_story_ids && story.related_pm_story_ids.length > 0) {
                        html += `<p><strong>Related PM Stories:</strong> `;
                        story.related_pm_story_ids.forEach((pmId, i) => {
                            html += `<code>${escapeHtml(pmId)}</code>`;
                            if (i < story.related_pm_story_ids.length - 1) html += ', ';
                        });
                        html += `</p>`;
                    }
                    
                    // Related Components
                    if (story.related_arch_components && story.related_arch_components.length > 0) {
                        html += `<p><strong>Components:</strong> `;
                        story.related_arch_components.forEach((comp, i) => {
                            html += `<code>${escapeHtml(comp)}</code>`;
                            if (i < story.related_arch_components.length - 1) html += ', ';
                        });
                        html += `</p>`;
                    }
                    
                    // Acceptance Criteria
                    if (story.acceptance_criteria && story.acceptance_criteria.length > 0) {
                        html += `<p><strong>Acceptance Criteria:</strong></p><ul>`;
                        story.acceptance_criteria.forEach(ac => {
                            html += `<li>${escapeHtml(ac)}</li>`;
                        });
                        html += `</ul>`;
                    }
                    
                    // Notes
                    if (story.notes && story.notes.length > 0) {
                        html += `<p><strong>Notes:</strong></p><ul>`;
                        story.notes.forEach(note => {
                            html += `<li><em>${escapeHtml(note)}</em></li>`;
                        });
                        html += `</ul>`;
                    }
                    
                    html += `</div>`;
                });
            }

            html += '</div>';
            return html;
        }

        function displayBAError(message) {
            const dataContent = document.getElementById('dataContent');
            const errorHtml = `
                <div style="margin-top: 40px; padding-top: 40px; border-top: 3px solid #e74c3c;">
                    <h1 style="color: #e74c3c;">üìã BA Error</h1>
                    <div class="error">
                        <strong>Error forwarding to BA:</strong><br>
                        ${escapeHtml(message)}
                    </div>
                </div>
            `;
            
            dataContent.innerHTML += errorHtml;
        }

        function displayAllMentorsMetadata(pmData, archData, baData) {
            const metadataBox = document.getElementById('metadataBox');
            const metadataContent = document.getElementById('metadataContent');
            
            const pmValidationBadge = pmData.validation_result.valid
                ? '<span class="validation-badge valid">‚úì VALID</span>'
                : '<span class="validation-badge invalid">‚úó INVALID</span>';
            
            const archValidationBadge = archData.validation_result.valid
                ? '<span class="validation-badge valid">‚úì VALID</span>'
                : '<span class="validation-badge invalid">‚úó INVALID</span>';
            
            const baValidationBadge = baData.validation_result.valid
                ? '<span class="validation-badge valid">‚úì VALID</span>'
                : '<span class="validation-badge invalid">‚úó INVALID</span>';

            metadataContent.innerHTML = `
                <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #34495e;">
                    <strong style="color: #3498db;">PM Mentor</strong>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Execution Time</span>
                    <span class="metadata-value">${pmData.execution_time_ms}ms</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Total Tokens</span>
                    <span class="metadata-value">${pmData.total_tokens}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Validation</span>
                    <span class="metadata-value">${pmValidationBadge}</span>
                </div>
                
                <div style="margin: 16px 0; padding: 16px 0; border-bottom: 1px solid #34495e;">
                    <strong style="color: #e67e22;">Architect Mentor</strong>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Execution Time</span>
                    <span class="metadata-value">${archData.execution_time_ms}ms</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Total Tokens</span>
                    <span class="metadata-value">${archData.total_tokens}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Validation</span>
                    <span class="metadata-value">${archValidationBadge}</span>
                </div>
                
                <div style="margin: 16px 0; padding: 16px 0; border-bottom: 1px solid #34495e;">
                    <strong style="color: #9b59b6;">BA Mentor</strong>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Execution Time</span>
                    <span class="metadata-value">${baData.execution_time_ms}ms</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Total Tokens</span>
                    <span class="metadata-value">${baData.total_tokens}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Validation</span>
                    <span class="metadata-value">${baValidationBadge}</span>
                </div>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #34495e;">
                    <div class="metadata-item">
                        <span class="metadata-label">Combined Tokens</span>
                        <span class="metadata-value">${pmData.total_tokens + archData.total_tokens + baData.total_tokens}</span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Total Time</span>
                        <span class="metadata-value">${pmData.execution_time_ms + archData.execution_time_ms + baData.execution_time_ms}ms</span>
                    </div>
                </div>
            `;

            metadataBox.style.display = 'block';
        }

        function generateArchitectDataView(data) {
            let html = `
                <div style="margin-top: 40px; padding-top: 40px; border-top: 3px solid #e67e22;">
                    <h1 style="color: #e67e22;">üèóÔ∏è Architecture Results</h1>
                </div>
            `;

            if (data.validation_result && data.validation_result.valid && data.validation_result.validated_data) {
                html += formatArchitectureAsMarkdown(data.validation_result.validated_data);
            } else {
                html += `
                    <div class="markdown-content">
                        <h2>‚ùå Architecture Validation Failed</h2>
                        ${displayValidation(data.validation_result)}
                    </div>
                `;
            }

            return html;
        }

        function generateArchitectJsonView(data) {
            return `
                <div style="margin-top: 40px; padding-top: 40px; border-top: 3px solid #e67e22;">
                    <h2 style="color: #e67e22; font-size: 24px; margin-bottom: 24px;">
                        üèóÔ∏è Architecture Results
                    </h2>
                </div>

                <div class="section">
                    <h3><span class="section-icon">üì•</span> Raw Architect Response</h3>
                    <div class="code-block">${escapeHtml(data.raw_response)}</div>
                </div>

                <div class="section">
                    <h3><span class="section-icon">üîç</span> Parsed Architecture JSON</h3>
                    ${data.parsed_json 
                        ? `<div class="json-block">${JSON.stringify(data.parsed_json, null, 2)}</div>`
                        : '<div class="error">Failed to parse JSON from response</div>'
                    }
                </div>

                <div class="section">
                    <h3><span class="section-icon">‚úÖ</span> Architecture Validation</h3>
                    ${displayValidation(data.validation_result)}
                </div>
            `;
        }

        function displayArchitectError(message) {
            const dataContent = document.getElementById('dataContent');
            dataContent.innerHTML += `
                <div style="margin-top: 40px; padding-top: 40px; border-top: 3px solid #e74c3c;">
                    <h1 style="color: #e74c3c;">üèóÔ∏è Architecture Error</h1>
                    <div class="error">
                        <strong>Error forwarding to Architect:</strong><br>
                        ${escapeHtml(message)}
                    </div>
                </div>
            `;
        }

        function displayCombinedMetadata(pmData, archData) {
            const metadataBox = document.getElementById('metadataBox');
            const metadataContent = document.getElementById('metadataContent');
            
            const pmValidationBadge = pmData.validation_result.valid
                ? '<span class="validation-badge valid">‚úì VALID</span>'
                : '<span class="validation-badge invalid">‚úó INVALID</span>';
            
            const archValidationBadge = archData.validation_result.valid
                ? '<span class="validation-badge valid">‚úì VALID</span>'
                : '<span class="validation-badge invalid">‚úó INVALID</span>';

            metadataContent.innerHTML = `
                <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #34495e;">
                    <strong style="color: #3498db;">PM Mentor</strong>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Execution Time</span>
                    <span class="metadata-value">${pmData.execution_time_ms}ms</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Total Tokens</span>
                    <span class="metadata-value">${pmData.total_tokens}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Validation</span>
                    <span class="metadata-value">${pmValidationBadge}</span>
                </div>
                
                <div style="margin: 16px 0; padding: 16px 0; border-bottom: 1px solid #34495e;">
                    <strong style="color: #e67e22;">Architect Mentor</strong>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Execution Time</span>
                    <span class="metadata-value">${archData.execution_time_ms}ms</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Total Tokens</span>
                    <span class="metadata-value">${archData.total_tokens}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Validation</span>
                    <span class="metadata-value">${archValidationBadge}</span>
                </div>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #34495e;">
                    <div class="metadata-item">
                        <span class="metadata-label">Combined Tokens</span>
                        <span class="metadata-value">${pmData.total_tokens + archData.total_tokens}</span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Total Time</span>
                        <span class="metadata-value">${pmData.execution_time_ms + archData.execution_time_ms}ms</span>
                    </div>
                </div>
            `;

            metadataBox.style.display = 'block';
        }

        function displayError(title, message) {
            const dataContent = document.getElementById('dataContent');
            dataContent.innerHTML = `
                <div class="markdown-content">
                    <h1>‚ùå ${escapeHtml(title)}</h1>
                    <div class="error">
                        <strong>Error:</strong><br>
                        ${escapeHtml(message)}
                    </div>
                </div>
            `;

            document.getElementById('metadataBox').style.display = 'none';
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }
    </script>
</body>
</html>