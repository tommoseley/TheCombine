<!DOCTYPE html>
<html lang="en" class="text-[14px]">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}The Combine{% endblock %}</title>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/ws.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Fira Code', 'Consolas', 'monospace'],
                    },
                    colors: {
                        accent: { DEFAULT: '#7C3AED', dark: '#8B5CF6' },
                        success: { DEFAULT: '#059669', dark: '#10B981' },
                        warning: { DEFAULT: '#D97706', dark: '#F59E0B' },
                        error: { DEFAULT: '#DC2626', dark: '#EF4444' },
                    },
                }
            }
        }
    </script>
    
    <!-- Dark mode initialization -->
    <script>
        if (localStorage.getItem('darkMode') === 'dark' || 
            (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    {% block head %}{% endblock %}
</head><body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen font-sans">
    <!-- Header -->
    <header class="bg-gray-900 dark:bg-gray-950 text-white shadow-lg sticky top-0 z-50 border-b border-gray-800">
        <div class="px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/" class="hover:opacity-80 transition-opacity"><h1 class="text-xl font-bold">The Combine</h1></a>
                <span class="text-xs bg-violet-600 px-2 py-0.5 rounded">Admin</span>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Dark Mode Toggle -->
                <button onclick="toggleDarkMode()" class="p-1.5 hover:bg-gray-800 rounded-lg transition-colors" title="Toggle dark mode">
                    <i data-lucide="sun" class="w-4 h-4 hidden dark:block"></i>
                    <i data-lucide="moon" class="w-4 h-4 block dark:hidden"></i>
                </button>
                
                <!-- User Menu -->
                <div id="user-menu" class="relative" style="display: none;">
                    <button onclick="toggleUserDropdown()" class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-800 rounded-lg transition-colors">
                        <div id="user-avatar" class="w-6 h-6 rounded-full bg-violet-600 flex items-center justify-center text-white text-xs font-medium"></div>
                        <span id="user-email" class="text-sm text-gray-300 max-w-[150px] truncate"></span>
                        <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                    </button>
                    
                    <!-- Dropdown -->
                    <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 py-1 z-50">
                        <a href="/" class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i data-lucide="home" class="w-4 h-4"></i><span>Home</span>
                        </a>
                        <a href="/web/static/public/accounts.html" class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i data-lucide="link" class="w-4 h-4"></i><span>Linked Accounts</span>
                        </a>
                        <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                        <button onclick="logout()" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 text-left">
                            <i data-lucide="log-out" class="w-4 h-4"></i><span>Sign Out</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="flex" style="height: calc(100vh - 56px);">
        <!-- Sidebar -->
        <nav class="w-60 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col overflow-y-auto">
            <ul class="flex-1 p-2 space-y-1">
                <li>
                    <a href="/admin" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i data-lucide="home" class="w-4 h-4"></i>Admin Home
                    </a>
                </li>
                <li>
                    <a href="/admin/dashboard" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm {% if active_page == 'dashboard' %}bg-accent/10 text-accent dark:text-accent-dark{% else %}text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
                        <i data-lucide="layout-dashboard" class="w-4 h-4"></i>Dashboard
                    </a>
                </li>
                <li>
                    <a href="/admin/dashboard/costs" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm {% if active_page == 'costs' %}bg-accent/10 text-accent dark:text-accent-dark{% else %}text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
                        <i data-lucide="dollar-sign" class="w-4 h-4"></i>Costs
                    </a>
                </li>
                <li>
                    <a href="/admin/workflows" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm {% if active_page == 'workflows' %}bg-accent/10 text-accent dark:text-accent-dark{% else %}text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
                        <i data-lucide="workflow" class="w-4 h-4"></i>Workflows
                    </a>
                </li>
                <li>
                    <a href="/admin/executions" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm {% if active_page == 'executions' %}bg-accent/10 text-accent dark:text-accent-dark{% else %}text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
                        <i data-lucide="play-circle" class="w-4 h-4"></i>Executions
                    </a>
                </li>
                <li>
                    <a href="/admin/documents" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm {% if active_page == 'documents' %}bg-accent/10 text-accent dark:text-accent-dark{% else %}text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
                        <i data-lucide="file-text" class="w-4 h-4"></i>Documents
                    </a>
                </li>
            </ul>
            
            <!-- Configuration Section -->
            <div class="border-t border-gray-200 dark:border-gray-700 p-2">
                <p class="px-3 py-2 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Configuration</p>
                <ul class="space-y-1">
                    <li>
                        <a href="/admin/document-types" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm {% if active_page == 'document-types' %}bg-accent/10 text-accent dark:text-accent-dark{% else %}text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
                            <i data-lucide="file-cog" class="w-4 h-4"></i>Document Types
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-semibold">{% block page_title %}{% endblock %}</h2>
                <div class="flex items-center gap-4">{% block header_actions %}{% endblock %}</div>
            </header>
            
            <div class="flex-1 p-6 overflow-auto">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
    
    <script src="/static/js/websocket.js"></script>
    <script>
        let currentUser = null;
        
        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark ? 'dark' : 'light');
        }
        
        async function checkAuth() {
            try {
                const response = await fetch('/api/optional-auth');
                const data = await response.json();
                if (data.authenticated) {
                    currentUser = data;
                    showUserMenu(data);
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }
        }
        
        function showUserMenu(user) {
            document.getElementById('user-menu').style.display = 'block';
            document.getElementById('user-email').textContent = user.email || '';
            
            const avatar = document.getElementById('user-avatar');
            if (user.avatar_url) {
                avatar.innerHTML = '<img src="' + user.avatar_url + '" class="w-full h-full rounded-full object-cover">';
            } else {
                avatar.textContent = (user.name || user.email || '?').charAt(0).toUpperCase();
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        function toggleUserDropdown() {
            document.getElementById('user-dropdown').classList.toggle('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        async function logout() {
            try {
                const csrf = document.cookie.split('csrf=')[1]?.split(';')[0] || document.cookie.split('__Host-csrf=')[1]?.split(';')[0];
                await fetch('/auth/logout', { method: 'POST', headers: { 'X-CSRF-Token': csrf } });
                window.location.href = '/';
            } catch (error) {
                window.location.href = '/';
            }
        }
        
        document.addEventListener('click', (e) => {
            const userMenu = document.getElementById('user-menu');
            const dropdown = document.getElementById('user-dropdown');
            if (userMenu && dropdown && !userMenu.contains(e.target)) dropdown.classList.add('hidden');
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            checkAuth();
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>