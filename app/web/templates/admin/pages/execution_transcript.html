{% extends "base.html" %}

{% block title %}Transcript: {{ execution_id }} - The Combine{% endblock %}

{% block page_title %}Execution Transcript{% endblock %}

{% block header_actions %}
<a href="/admin/executions/{{ execution_id }}" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
    <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i>Back to Execution
</a>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header Info -->
    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
        <div class="flex flex-wrap gap-6 text-sm">
            <div>
                <span class="text-gray-500 dark:text-gray-400">Execution:</span>
                <span class="ml-2 font-mono">{{ execution_id }}</span>
            </div>
            {% if project_name %}
            <div>
                <span class="text-gray-500 dark:text-gray-400">Project:</span>
                <span class="ml-2">{{ project_name }}</span>
            </div>
            {% endif %}
            {% if document_type %}
            <div>
                <span class="text-gray-500 dark:text-gray-400">Document:</span>
                <span class="ml-2">{{ document_type }}</span>
            </div>
            {% endif %}
            <div>
                <span class="text-gray-500 dark:text-gray-400">Runs:</span>
                <span class="ml-2">{{ total_runs }}</span>
            </div>
            <div>
                <span class="text-gray-500 dark:text-gray-400">Tokens:</span>
                <span class="ml-2">{{ "{:,}".format(total_tokens) }}</span>
            </div>
            <div>
                <span class="text-gray-500 dark:text-gray-400">Cost:</span>
                <span class="ml-2 text-accent dark:text-accent-dark">${{ "%.4f"|format(total_cost) }}</span>
            </div>
        </div>
    </div>

    <!-- Transcript -->
    <div class="bg-gray-900 rounded-lg border border-gray-700 overflow-hidden">
        <div class="p-4 border-b border-gray-700 flex justify-between items-center">
            <h2 class="text-white font-semibold">LLM Conversation Log</h2>
            <div class="flex gap-2">
                <button id="copy-btn" onclick="copyTranscript(this)" class="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 rounded transition-colors">
                    <i data-lucide="copy" class="w-3 h-3 inline mr-1"></i>Copy All
                </button>
                <button onclick="saveTranscript()" class="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 rounded transition-colors">
                    <i data-lucide="download" class="w-3 h-3 inline mr-1"></i>Save As
                </button>
            </div>
        </div>

        <div id="transcript-content" class="p-4 font-mono text-sm text-gray-100 whitespace-pre-wrap overflow-x-auto">
<span class="text-gray-500">═══════════════════════════════════════════════════════════════════════════════
Execution Transcript: {{ execution_id }}
{% if project_name %}Project: {{ project_name }}{% endif %}
{% if document_type %}Document Type: {{ document_type }}{% endif %}
Started: {{ started_at or "N/A" }} | Ended: {{ ended_at or "N/A" }}
Total: {{ total_runs }} runs, {{ "{:,}".format(total_tokens) }} tokens, ${{ "%.4f"|format(total_cost) }}
═══════════════════════════════════════════════════════════════════════════════</span>
{% for entry in transcript %}

<span class="text-yellow-400">─── Run {{ entry.run_number }}: {{ entry.role }}{% if entry.node_id %} (node: {{ entry.node_id }}){% endif %} ───────────────────────────────</span>
<span class="text-gray-400">ID: {{ entry.run_id }}... | Task: {{ entry.task_ref }} | Model: {{ entry.model }}
Started: {{ entry.started_at or "N/A" }} | Duration: {{ entry.duration or "N/A" }} | Tokens: {{ entry.tokens or "N/A" }} | Status: {{ entry.status }}</span>
{% for input in entry.inputs %}

<span class="text-cyan-400">[{{ input.kind|upper }}]</span>{% if input.redacted %} <span class="text-red-400">[REDACTED]</span>{% endif %}

{{ input.content or "(empty)" }}
{% endfor %}
{% for output in entry.outputs %}

<span class="text-green-400">[{{ output.kind|upper }}]</span>{% if output.parse_status %} <span class="text-gray-400">(parse: {{ output.parse_status }})</span>{% endif %}

{{ output.content or "(empty)" }}
{% endfor %}
{% endfor %}

<span class="text-gray-500">═══════════════════════════════════════════════════════════════════════════════
End of Transcript
═══════════════════════════════════════════════════════════════════════════════</span>
        </div>
    </div>
</div>

<script>
function copyTranscript(btn) {
    const content = document.getElementById('transcript-content').innerText;
    navigator.clipboard.writeText(content).then(() => {
        // Brief visual feedback
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Copied!';
        btn.classList.add('bg-green-600');
        btn.classList.remove('bg-gray-700');
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('bg-green-600');
            btn.classList.add('bg-gray-700');
            lucide.createIcons();
        }, 2000);
    });
}

function saveTranscript() {
    const content = document.getElementById('transcript-content').innerText;
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'transcript-{{ execution_id }}.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}
