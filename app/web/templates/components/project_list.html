<!-- components/project_list.html -->
<!-- Accordion-based project tree with persistent status indicators -->
<!-- NO TOOLTIPS - all critical status information is always visible -->

{% if projects and projects|length > 0 %}
    {# Separate active and archived projects #}
    {% set active_projects = [] %}
    {% set archived_projects = [] %}
    {% for project in projects %}
        {% if project.is_archived %}
            {% set _ = archived_projects.append(project) %}
        {% else %}
            {% set _ = active_projects.append(project) %}
        {% endif %}
    {% endfor %}
    
    {# Active Projects #}
    {% for project in active_projects %}
    <div class="project-accordion">
        <!-- Project Header -->
        <div class="project-header w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors"
             data-project-url="/projects/{{ project.id }}">
            
            <!-- Expand/Collapse Chevron - ONLY this toggles accordion -->
            <button 
                type="button"
                onclick="event.stopPropagation(); toggleProjectAccordion(this, '{{ project.id }}')"
                class="p-1 -ml-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded transition-colors flex-shrink-0"
                aria-label="Toggle project documents">
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 dark:text-gray-500 accordion-chevron transition-transform"></i>
            </button>
            
            <!-- Project Link - Icon + Name navigate to project detail -->
            <a 
                href="/projects/{{ project.id }}"
                hx-get="/projects/{{ project.id }}"
                hx-target="#main-content"
                hx-push-url="true"
                class="flex items-center gap-2 flex-1 min-w-0"
                onclick="event.stopPropagation()">
                
                <!-- Project Icon -->
                <i data-lucide="{{ project.icon | default('folder') }}" class="w-5 h-5 text-gray-500 dark:text-gray-400 flex-shrink-0"></i>
                
                <!-- Project Name -->
                <span class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate hover:text-violet-600 dark:hover:text-violet-400">{{ project.name }}</span>
            </a>
            
            <!-- Project Status Summary - ALWAYS VISIBLE -->
            {% if project.documents %}
            <div class="flex items-center gap-1.5 flex-shrink-0">
                {% if project.status_summary.ready > 0 %}
                <span class="flex items-center gap-0.5">
                    <i data-lucide="check-circle" class="w-4 h-4 text-emerald-600 dark:text-emerald-400"></i>
                    <span class="text-xs text-gray-500 dark:text-gray-400">{{ project.status_summary.ready }}</span>
                </span>
                {% endif %}
                {% if project.status_summary.needs_acceptance > 0 %}
                <span class="flex items-center gap-0.5">
                    <i data-lucide="alert-triangle" class="w-4 h-4 text-amber-600 dark:text-amber-400"></i>
                    <span class="text-xs text-gray-500 dark:text-gray-400">{{ project.status_summary.needs_acceptance }}</span>
                </span>
                {% endif %}
                {% if project.status_summary.stale > 0 %}
                <span class="flex items-center gap-0.5">
                    <i data-lucide="alert-triangle" class="w-4 h-4 text-amber-600 dark:text-amber-400"></i>
                    <span class="text-xs text-gray-500 dark:text-gray-400">{{ project.status_summary.stale }}</span>
                </span>
                {% endif %}
                {% if project.status_summary.blocked > 0 %}
                <span class="flex items-center gap-0.5">
                    <i data-lucide="x-circle" class="w-4 h-4 text-red-600 dark:text-red-400"></i>
                    <span class="text-xs text-gray-500 dark:text-gray-400">{{ project.status_summary.blocked }}</span>
                </span>
                {% endif %}
                {% if project.status_summary.waiting > 0 %}
                <span class="flex items-center gap-0.5">
                    <i data-lucide="clock" class="w-4 h-4 text-gray-400 dark:text-gray-500"></i>
                    <span class="text-xs text-gray-500 dark:text-gray-400">{{ project.status_summary.waiting }}</span>
                </span>
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        <!-- Accordion Content: Document List -->
        <div class="accordion-content">
            <div class="ml-5 pl-4 border-l-2 border-gray-200 dark:border-gray-600">
                {% if project.documents %}
                    {% for doc in project.documents %}
                    <a 
                        href="/projects/{{ project.id }}/documents/{{ doc.doc_type_id }}"
                        hx-get="/projects/{{ project.id }}/documents/{{ doc.doc_type_id }}"
                        hx-target="#main-content"
                        hx-push-url="true"
                        class="doc-link flex items-center gap-3 px-2 py-2 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors border-l-2 border-transparent -ml-[2px] {% if doc.readiness == 'blocked' %}opacity-60{% endif %}">
                        
                        <!-- Document Type Icon -->
                        <i data-lucide="{{ doc.icon }}" class="doc-icon w-5 h-5 text-gray-500 dark:text-gray-400 flex-shrink-0"></i>
                        
                        <!-- Document Title + Subtitle -->
                        <div class="flex-1 min-w-0">
                            <span class="text-sm text-gray-700 dark:text-gray-200 truncate block">{{ doc.title }}</span>
                            {% if doc.subtitle %}
                            <span class="text-xs text-gray-500 dark:text-gray-400 truncate block">{{ doc.subtitle }}</span>
                            {% endif %}
                        </div>
                        
                        <!-- Document Status Icon -->
                        {% if doc.readiness == 'ready' %}
                            <i data-lucide="check-circle" class="w-5 h-5 text-emerald-600 dark:text-emerald-400 flex-shrink-0"></i>
                        {% elif doc.readiness == 'stale' %}
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600 dark:text-amber-400 flex-shrink-0"></i>
                        {% elif doc.readiness == 'blocked' %}
                            <i data-lucide="x-circle" class="w-5 h-5 text-red-600 dark:text-red-400 flex-shrink-0"></i>
                        {% elif doc.readiness == 'waiting' %}
                            <i data-lucide="clock" class="w-5 h-5 text-gray-400 dark:text-gray-500 flex-shrink-0"></i>
                        {% endif %}
                    </a>
                    {% endfor %}
                    
                    <!-- Missing Documents - ALWAYS VISIBLE when expanded -->
                    {% set doc_type_ids = project.documents | map(attribute='doc_type_id') | list %}
                    {% set missing = [] %}
                    {% if 'project_discovery' not in doc_type_ids %}
                        {% set _ = missing.append('project_discovery') %}
                    {% endif %}
                    {% if 'epic_backlog' not in doc_type_ids %}
                        {% set _ = missing.append('epic_backlog') %}
                    {% endif %}
                    {% if 'technical_architecture' not in doc_type_ids %}
                        {% set _ = missing.append('technical_architecture') %}
                    {% endif %}
                    
                    {% for m in missing %}
                    <div class="flex items-center gap-3 px-2 py-2 border-l-2 border-red-400 -ml-[2px] bg-red-50 dark:bg-red-900/20">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-red-500 dark:text-red-400 flex-shrink-0"></i>
                        <span class="text-sm text-red-600 dark:text-red-400 font-medium">Missing: {{ m }}</span>
                    </div>
                    {% endfor %}
                    
                {% else %}
                    <!-- No documents yet -->
                    <a 
                        href="/projects/{{ project.id }}"
                        hx-get="/projects/{{ project.id }}"
                        hx-target="#main-content"
                        hx-push-url="true"
                        class="doc-link flex items-center gap-3 px-2 py-2 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors border-l-2 border-transparent -ml-[2px]">
                        <i data-lucide="file-plus" class="doc-icon w-5 h-5 text-gray-400 dark:text-gray-500 flex-shrink-0"></i>
                        <span class="flex-1 text-sm text-gray-500 dark:text-gray-400 italic truncate">No documents yet</span>
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
    
    {# Archived Projects Section #}
    {% if archived_projects|length > 0 %}
    <!-- Archived Projects Divider (Collapsible) -->
    <div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">
        <button 
            type="button"
            onclick="toggleArchivedSection()"
            class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors rounded-lg group"
            id="archived-section-toggle">
            <!-- Chevron -->
            <i data-lucide="chevron-right" id="archived-chevron" class="w-4 h-4 text-gray-400 dark:text-gray-500 transition-transform"></i>
            <!-- Archive Icon -->
            <i data-lucide="archive" class="w-4 h-4 text-gray-400 dark:text-gray-500"></i>
            <!-- Label -->
            <span class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Archived Projects</span>
            <!-- Count Badge -->
            <span class="ml-auto text-xs text-gray-400 dark:text-gray-500 font-medium">{{ archived_projects|length }}</span>
        </button>
    </div>
    
    <!-- Archived Projects List (Collapsible Content) -->
    <div id="archived-projects-list" class="hidden">
        {% for project in archived_projects %}
        <div class="project-accordion opacity-60">
            <!-- Project Header -->
            <div class="project-header w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors"
                 data-project-url="/projects/{{ project.id }}">
                
                <!-- Expand/Collapse Chevron - ONLY this toggles accordion -->
                <button 
                    type="button"
                    onclick="event.stopPropagation(); toggleProjectAccordion(this, '{{ project.id }}')"
                    class="p-1 -ml-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded transition-colors flex-shrink-0"
                    aria-label="Toggle project documents">
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 dark:text-gray-500 accordion-chevron transition-transform"></i>
                </button>
                
                <!-- Project Link - Icon + Name navigate to project detail -->
                <a 
                    href="/projects/{{ project.id }}"
                    hx-get="/projects/{{ project.id }}"
                    hx-target="#main-content"
                    hx-push-url="true"
                    class="flex items-center gap-2 flex-1 min-w-0"
                    onclick="event.stopPropagation()">
                    
                    <!-- Project Icon -->
                    <i data-lucide="{{ project.icon | default('folder') }}" class="w-5 h-5 text-gray-500 dark:text-gray-400 flex-shrink-0"></i>
                    
                    <!-- Project Name -->
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300 truncate hover:text-violet-600 dark:hover:text-violet-400">{{ project.name }}</span>
                </a>
                
                <!-- Archive indicator -->
                <div class="flex items-center gap-1 flex-shrink-0">
                    <i data-lucide="lock" class="w-4 h-4 text-amber-600 dark:text-amber-400"></i>
                </div>
            </div>
            
            <!-- Accordion Content: Document List -->
            <div class="accordion-content">
                <div class="ml-5 pl-4 border-l-2 border-gray-200 dark:border-gray-600">
                    {% if project.documents %}
                        {% for doc in project.documents %}
                        <a 
                            href="/projects/{{ project.id }}/documents/{{ doc.doc_type_id }}"
                            hx-get="/projects/{{ project.id }}/documents/{{ doc.doc_type_id }}"
                            hx-target="#main-content"
                            hx-push-url="true"
                            class="doc-link flex items-center gap-3 px-2 py-2 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors border-l-2 border-transparent -ml-[2px]">
                            
                            <!-- Document Type Icon -->
                            <i data-lucide="{{ doc.icon }}" class="doc-icon w-5 h-5 text-gray-500 dark:text-gray-400 flex-shrink-0"></i>
                            
                            <!-- Document Title + Subtitle -->
                            <div class="flex-1 min-w-0">
                                <span class="text-sm text-gray-700 dark:text-gray-200 truncate block">{{ doc.title }}</span>
                                {% if doc.subtitle %}
                                <span class="text-xs text-gray-500 dark:text-gray-400 truncate block">{{ doc.subtitle }}</span>
                                {% endif %}
                            </div>
                            
                            <!-- Archived - show lock icon -->
                            <i data-lucide="lock" class="w-4 h-4 text-amber-600 dark:text-amber-400 flex-shrink-0"></i>
                        </a>
                        {% endfor %}
                    {% else %}
                        <!-- No documents -->
                        <div class="flex items-center gap-3 px-2 py-2">
                            <i data-lucide="file-x" class="w-5 h-5 text-gray-400 dark:text-gray-500 flex-shrink-0"></i>
                            <span class="flex-1 text-sm text-gray-500 dark:text-gray-400 italic truncate">No documents</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
{% else %}
<div class="p-4 text-center">
    <i data-lucide="folder-open" class="w-8 h-8 text-gray-300 dark:text-gray-600 mx-auto mb-2"></i>
    <p class="text-sm text-gray-500 dark:text-gray-400">No projects yet</p>
    <a 
        href="/projects/new"
        hx-get="/projects/new"
        hx-target="#main-content"
        hx-push-url="true"
        class="text-sm text-violet-600 dark:text-violet-400 hover:text-violet-800 dark:hover:text-violet-300 mt-2 inline-block">
        Create your first project
    </a>
</div>
{% endif %}

<script>
// Toggle archived projects section
function toggleArchivedSection() {
    const list = document.getElementById('archived-projects-list');
    const chevron = document.getElementById('archived-chevron');
    const isHidden = list.classList.contains('hidden');
    
    if (isHidden) {
        // Show
        list.classList.remove('hidden');
        chevron.setAttribute('data-lucide', 'chevron-down');
        localStorage.setItem('archivedProjectsExpanded', 'true');
    } else {
        // Hide
        list.classList.add('hidden');
        chevron.setAttribute('data-lucide', 'chevron-right');
        localStorage.setItem('archivedProjectsExpanded', 'false');
    }
    
    // Re-render icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

// Restore archived section state on load
document.addEventListener('DOMContentLoaded', function() {
    const expanded = localStorage.getItem('archivedProjectsExpanded') === 'true';
    if (expanded) {
        const list = document.getElementById('archived-projects-list');
        const chevron = document.getElementById('archived-chevron');
        if (list && chevron) {
            list.classList.remove('hidden');
            chevron.setAttribute('data-lucide', 'chevron-down');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
    }
});

// Also restore after HTMX swaps
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'project-tree-root') {
        const expanded = localStorage.getItem('archivedProjectsExpanded') === 'true';
        if (expanded) {
            setTimeout(() => {
                const list = document.getElementById('archived-projects-list');
                const chevron = document.getElementById('archived-chevron');
                if (list && chevron) {
                    list.classList.remove('hidden');
                    chevron.setAttribute('data-lucide', 'chevron-down');
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
            }, 10);
        }
    }
});
</script>