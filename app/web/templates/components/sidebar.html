<div class="flex flex-col h-full">
    <!-- New Project Button - px-4 matches header logo padding -->
    <div class="p-4 border-b border-gray-200">
        <a 
            href="/ui/projects/new"
            hx-get="/ui/projects/new"
            hx-target="#main-content"
            hx-push-url="true"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors">
            <i data-lucide="plus" class="w-5 h-5"></i>
            <span>New Project</span>
        </a>
    </div>
    
    <!-- Project Tree - px-4 matches header and button -->
    <div class="flex-1 overflow-y-auto p-4">
        <div 
            id="project-tree-root"
            hx-get="/ui/projects/tree"
            hx-trigger="load"
            hx-swap="innerHTML"
            hx-indicator="#tree-loading"
            class="space-y-1">
            <!-- Projects loaded here via HTMX -->
            <div class="flex items-center justify-center py-8">
                <div id="tree-loading" class="htmx-indicator">
                    <i data-lucide="loader-2" class="w-6 h-6 animate-spin text-gray-400"></i>
                </div>
            </div>
        </div>
        
        <!-- Infinite Scroll Trigger -->
        <div 
            id="scroll-trigger"
            hx-get="/ui/projects/tree"
            hx-trigger="intersect once"
            hx-swap="beforeend"
            hx-target="#project-tree-root"
            hx-vals='{"offset": "20"}'
            class="h-20 flex items-center justify-center">
            <div class="htmx-indicator">
                <i data-lucide="loader-2" class="w-5 h-5 animate-spin text-gray-400"></i>
            </div>
        </div>
    </div>
</div>

<style>
/* Active tree node styling */
.tree-link.active {
    background-color: rgb(239 246 255); /* bg-blue-50 */
    color: rgb(29 78 216); /* text-blue-700 */
}
.tree-link.active i {
    color: rgb(37 99 235); /* text-blue-600 */
}
</style>

<script>
// Update active tree node based on current URL
function updateActiveTreeNode() {
    const currentPath = window.location.pathname;
    
    // Remove active class from all tree links
    document.querySelectorAll('#project-tree-root .tree-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Find and activate the matching link
    document.querySelectorAll('#project-tree-root .tree-link').forEach(link => {
        const href = link.getAttribute('href');
        if (href && currentPath === href) {
            link.classList.add('active');
        }
    });
}

// Run on page load
document.addEventListener('DOMContentLoaded', updateActiveTreeNode);

// Run after HTMX swaps content (for both tree updates and main content navigation)
document.body.addEventListener('htmx:afterSwap', function(event) {
    // Small delay to ensure DOM is updated
    setTimeout(() => {
        updateActiveTreeNode();
        // Re-initialize Lucide icons for new content
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }, 10);
});

// Run after URL changes (for browser back/forward)
window.addEventListener('popstate', updateActiveTreeNode);

// Run after HTMX pushes URL
document.body.addEventListener('htmx:pushedIntoHistory', updateActiveTreeNode);
</script>