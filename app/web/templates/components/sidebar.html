<div class="flex flex-col h-full">
    <!-- Project Tree -->
    <div class="flex-1 overflow-y-auto p-4">
        <div 
            id="project-tree-root"
            hx-get="/ui/projects/tree"
            hx-trigger="load"
            hx-swap="innerHTML"
            hx-indicator="#tree-loading"
            class="space-y-1">
            <!-- Projects loaded here via HTMX -->
            <div class="flex items-center justify-center py-8">
                <div id="tree-loading" class="htmx-indicator">
                    <i data-lucide="loader-2" class="w-6 h-6 animate-spin text-gray-400"></i>
                </div>
            </div>
        </div>
        
        <!-- Infinite Scroll Trigger -->
        <div 
            id="scroll-trigger"
            hx-get="/ui/projects/tree"
            hx-trigger="intersect once"
            hx-swap="beforeend"
            hx-target="#project-tree-root"
            hx-vals='{"offset": "20"}'
            class="h-20 flex items-center justify-center">
            <div class="htmx-indicator">
                <i data-lucide="loader-2" class="w-5 h-5 animate-spin text-gray-400"></i>
            </div>
        </div>
    </div>
    
    <!-- New Project Button -->
    <div class="p-4 border-t border-gray-200">
        <a 
            href="/ui/projects/new"
            hx-get="/ui/projects/new"
            hx-target="#main-content"
            hx-push-url="true"
            class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors">
            <i data-lucide="plus" class="w-5 h-5"></i>
            <span>New Project</span>
        </a>
    </div>
    
    <!-- Legend Link -->
    <div class="px-4 pb-4">
        <button 
            onclick="openLegendModal()"
            class="w-full flex items-center justify-center gap-2 py-2 px-3 text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
            <i data-lucide="help-circle" class="w-4 h-4"></i>
            <span>Legend</span>
        </button>
    </div>
</div>

<style>
/* Active tree node styling */
.tree-link.active {
    background-color: rgb(238 242 255); /* bg-indigo-50 */
    color: rgb(67 56 202); /* text-indigo-700 */
    border-left: 3px solid rgb(99 102 241); /* border-indigo-500 */
    margin-left: -3px;
    padding-left: calc(0.5rem + 3px);
}
.tree-link.active i {
    color: rgb(79 70 229); /* text-indigo-600 */
}

/* Hover state for all tree links */
.tree-link:hover:not(.active) {
    background-color: rgb(249 250 251); /* bg-gray-50 */
}
</style>

<script>
// Update active tree node based on current URL
function updateActiveTreeNode() {
    const currentPath = window.location.pathname;
    
    // Remove active class from all tree links
    document.querySelectorAll('#project-tree-root .tree-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Find and activate the matching link
    document.querySelectorAll('#project-tree-root .tree-link').forEach(link => {
        const href = link.getAttribute('href');
        if (href && currentPath === href) {
            link.classList.add('active');
        }
    });
}

// Run on page load
document.addEventListener('DOMContentLoaded', updateActiveTreeNode);

// Run after HTMX swaps content (for both tree updates and main content navigation)
document.body.addEventListener('htmx:afterSwap', function(event) {
    // Small delay to ensure DOM is updated
    setTimeout(() => {
        updateActiveTreeNode();
        // Re-initialize Lucide icons for new content
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }, 10);
});

// Run after URL changes (for browser back/forward)
window.addEventListener('popstate', updateActiveTreeNode);

// Run after HTMX pushes URL
document.body.addEventListener('htmx:pushedIntoHistory', updateActiveTreeNode);
</script>