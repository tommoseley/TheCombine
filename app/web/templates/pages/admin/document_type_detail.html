{% extends "layout/base.html" %}

{% block title %}{{ doc_type.doc_name }} - Admin - The Combine{% endblock %}

{% block content %}
<div class="p-6 max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <nav class="text-sm text-gray-500 dark:text-gray-400 mb-2">
            <a href="/ui/admin" class="hover:text-gray-700 dark:hover:text-gray-200">Admin</a>
            <span class="mx-2">/</span>
            <a href="/ui/admin/document-types" class="hover:text-gray-700 dark:hover:text-gray-200">Document Types</a>
            <span class="mx-2">/</span>
            <span class="font-medium text-gray-900 dark:text-gray-100">{{ doc_type.doc_name }}</span>
        </nav>
        
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                <i data-lucide="{{ doc_type.icon or 'file-text' }}" class="w-6 h-6 text-gray-600 dark:text-gray-400"></i>
            </div>
            <div>
                <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100">{{ doc_type.doc_name }}</h1>
                <p class="text-gray-600 dark:text-gray-400 font-mono">{{ doc_type.doc_type_id }}</p>
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Document Type Info -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Document Type Card -->
            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="font-semibold text-gray-900 dark:text-gray-100">Document Type</h2>
                </div>
                <div class="p-4 space-y-3">
                    <div>
                        <label class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Description</label>
                        <p class="text-sm text-gray-700 dark:text-gray-300">{{ doc_type.doc_description or 'No description' }}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Scope</label>
                            <p class="text-sm text-gray-700 dark:text-gray-300">{{ doc_type.scope }}</p>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Order</label>
                            <p class="text-sm text-gray-700 dark:text-gray-300">{{ doc_type.display_order }}</p>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Handler ID</label>
                        <p class="text-sm font-mono text-gray-700 dark:text-gray-300">{{ doc_type.handler_id or 'Not set' }}</p>
                        {% if doc_type.handler_id != doc_type.doc_type_id %}
                        <p class="text-xs text-amber-600 dark:text-amber-400 mt-1">
                            <i data-lucide="alert-triangle" class="w-3 h-3 inline"></i>
                            Should match doc_type_id
                        </p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Acceptance Required</label>
                        <p class="text-sm text-gray-700 dark:text-gray-300">
                            {% if doc_type.acceptance_required %}
                            <span class="text-violet-600 dark:text-violet-400">Yes</span>
                            {% if doc_type.accepted_by_role %}
                            <span class="text-gray-500 dark:text-gray-400"> (by {{ doc_type.accepted_by_role }})</span>
                            {% endif %}
                            {% else %}
                            No
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Dependencies Card -->
            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="font-semibold text-gray-900 dark:text-gray-100">Dependencies</h2>
                </div>
                <div class="p-4 space-y-3">
                    <div>
                        <label class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Required Inputs</label>
                        {% if doc_type.required_inputs and doc_type.required_inputs | length > 0 %}
                        <div class="mt-1 space-y-1">
                            {% for input in doc_type.required_inputs %}
                            <a href="/ui/admin/document-types/{{ input }}" 
                               class="block text-sm font-mono text-violet-600 dark:text-violet-400 hover:underline">
                                {{ input }}
                            </a>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-sm text-gray-500 dark:text-gray-400">None</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Optional Inputs</label>
                        {% if doc_type.optional_inputs and doc_type.optional_inputs | length > 0 %}
                        <div class="mt-1 space-y-1">
                            {% for input in doc_type.optional_inputs %}
                            <a href="/ui/admin/document-types/{{ input }}" 
                               class="block text-sm font-mono text-gray-600 dark:text-gray-400 hover:underline">
                                {{ input }}
                            </a>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-sm text-gray-500 dark:text-gray-400">None</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Role Card -->
            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="font-semibold text-gray-900 dark:text-gray-100">Assigned Role</h2>
                </div>
                <div class="p-4">
                    {% if doc_type.role_name %}
                    <div class="flex items-center gap-3 mb-3">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
                            {{ doc_type.role_name }}
                        </span>
                        {% if doc_type.task_version %}
                        <span class="text-xs text-gray-500 dark:text-gray-400">Task v{{ doc_type.task_version }}</span>
                        {% endif %}
                    </div>
                    {% if doc_type.role_description %}
                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ doc_type.role_description }}</p>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <i data-lucide="user-x" class="w-8 h-8 text-gray-300 dark:text-gray-600 mx-auto mb-2"></i>
                        <p class="text-sm text-red-600 dark:text-red-400">No role assigned</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Add a role_task entry with task_name = '{{ doc_type.doc_type_id }}'</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Right Column: Prompts and Schema -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Role Identity Prompt -->
            {% if doc_type.role_identity %}
            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                    <h2 class="font-semibold text-gray-900 dark:text-gray-100">Role Identity Prompt</h2>
                    <span class="text-xs text-gray-500 dark:text-gray-400">roles.identity_prompt</span>
                </div>
                <div class="p-4">
                    <pre class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap font-mono bg-gray-50 dark:bg-gray-900 rounded-lg p-4 max-h-64 overflow-y-auto">{{ doc_type.role_identity }}</pre>
                </div>
            </div>
            {% endif %}
            
            <!-- Task Prompt -->
            {% if doc_type.task_prompt %}
            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                    <h2 class="font-semibold text-gray-900 dark:text-gray-100">Task Prompt</h2>
                    <span class="text-xs text-gray-500 dark:text-gray-400">role_tasks.task_prompt</span>
                </div>
                <div class="p-4">
                    <pre class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap font-mono bg-gray-50 dark:bg-gray-900 rounded-lg p-4 max-h-96 overflow-y-auto">{{ doc_type.task_prompt }}</pre>
                </div>
            </div>
            {% endif %}
            
            <!-- Expected Schema -->
            {% if doc_type.expected_schema %}
            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                    <h2 class="font-semibold text-gray-900 dark:text-gray-100">Expected Output Schema</h2>
                    <span class="text-xs text-gray-500 dark:text-gray-400">role_tasks.expected_schema</span>
                </div>
                <div class="p-4">
                    <pre class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap font-mono bg-gray-50 dark:bg-gray-900 rounded-lg p-4 max-h-96 overflow-y-auto"><code class="language-json">{{ doc_type.expected_schema | tojson(indent=2) }}</code></pre>
                </div>
            </div>
            {% endif %}
            
            <!-- No Task Warning -->
            {% if not doc_type.task_prompt %}
            <div class="bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-800 p-6 text-center">
                <i data-lucide="alert-triangle" class="w-12 h-12 text-amber-500 mx-auto mb-3"></i>
                <h3 class="text-lg font-semibold text-amber-800 dark:text-amber-200 mb-2">No Task Configured</h3>
                <p class="text-sm text-amber-700 dark:text-amber-300 mb-4">
                    This document type has no associated task in the role_tasks table.
                </p>
                <div class="text-left bg-white dark:bg-gray-800 rounded-lg p-4 text-xs font-mono text-gray-600 dark:text-gray-400">
                    <p class="mb-2">To fix, insert a role_task:</p>
                    <pre class="whitespace-pre-wrap">INSERT INTO role_tasks (role_id, task_name, task_prompt, expected_schema, is_active)
SELECT id, '{{ doc_type.doc_type_id }}', 'Your task prompt...', '{}'::jsonb, true
FROM roles WHERE name = 'your_role';</pre>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}