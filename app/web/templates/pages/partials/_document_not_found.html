{# Document Not Found / Build UI #}
{# Shared partial for when a document doesn't exist yet #}
{# Expected variables: project, doc_type_id, doc_type_name, doc_type_icon, doc_type_description #}

<div class="p-6 max-w-4xl mx-auto">
    <!-- Header with breadcrumb -->
    <div class="mb-8">
        <nav class="text-sm text-gray-500 dark:text-gray-400 mb-2">
            <a href="/projects/{{ project.id if project.id is defined else project['id'] }}" 
               hx-get="/projects/{{ project.id if project.id is defined else project['id'] }}"
               hx-target="#main-content"
               hx-push-url="true"
               class="hover:text-gray-700 dark:hover:text-gray-200">
                {{ project.name if project.name is defined else project['name'] }}
            </a>
            <span class="mx-2">/</span>
            <span class="font-medium text-gray-900 dark:text-gray-100">{{ doc_type_name }}</span>
        </nav>
        
        <div class="flex items-center gap-3">
            <i data-lucide="{{ doc_type_icon | default('file-text') }}" class="w-10 h-10 text-gray-400 dark:text-gray-500"></i>
            <div>
                <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100">{{ doc_type_name }}</h1>
                <p class="text-gray-500 dark:text-gray-400">Not yet created</p>
            </div>
        </div>
    </div>

    <!-- Document Type Description Card -->
    {% if doc_type_description %}
    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">About This Document</h2>
        <div class="text-gray-600 dark:text-gray-400 whitespace-pre-line">{{ doc_type_description }}</div>
    </div>
    {% endif %}

    <!-- Build Card -->
    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-8">
        <div class="max-w-md mx-auto text-center">
            <i data-lucide="{{ doc_type_icon | default('file-text') }}" class="w-16 h-16 text-gray-300 dark:text-gray-600 mx-auto mb-4"></i>
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 mb-2">{{ doc_type_name }} Not Created</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-6">This document has not been generated yet. Click below to create it.</p>
            
            <!-- Build Button with Progress -->
            <div id="build-container">
                <button 
                    id="build-btn"
                    onclick="startDocumentBuild('{{ project.id if project.id is defined else project['id'] }}', '{{ doc_type_id }}')"
                    class="w-full px-4 py-3 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-colors flex items-center justify-center gap-2 font-medium">
                    <i data-lucide="sparkles" class="w-5 h-5" id="btn-icon"></i>
                    <span id="btn-text">Generate {{ doc_type_name }}</span>
                </button>
                
                <!-- Progress Bar (hidden initially) -->
                <div id="progress-container" class="hidden mt-4">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Progress</span>
                        <span id="progress-pct" class="text-sm text-gray-500 dark:text-gray-400">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div id="progress-fill" class="bg-violet-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Status Messages (hidden initially) -->
                <div id="status-messages" class="hidden mt-4 text-left space-y-1 max-h-48 overflow-y-auto">
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Track last status to deduplicate
let lastStatusMessage = '';

async function startDocumentBuild(projectId, docTypeId) {
    const btn = document.getElementById('build-btn');
    const btnIcon = document.getElementById('btn-icon');
    const btnText = document.getElementById('btn-text');
    const progressContainer = document.getElementById('progress-container');
    const statusMessages = document.getElementById('status-messages');
    
    // Reset deduplication tracker
    lastStatusMessage = '';
    
    // Update button to loading state
    btn.disabled = true;
    btn.classList.add('opacity-75', 'cursor-not-allowed');
    btnIcon.outerHTML = `<svg class="animate-spin w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>`;
    btnText.textContent = 'Generating...';
    
    // Show progress bar and messages
    progressContainer.classList.remove('hidden');
    statusMessages.classList.remove('hidden');
    statusMessages.innerHTML = '';
    
    try {
        // Use fetch with POST for SSE stream
        const response = await fetch(`/projects/${projectId}/documents/${docTypeId}/build`, {
            method: 'POST',
            headers: {
                'Accept': 'text/event-stream',
            }
        });
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            
            // Process complete SSE messages
            const lines = buffer.split('\n');
            buffer = lines.pop(); // Keep incomplete line in buffer
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        
                        // Update progress bar
                        if (data.progress !== undefined) {
                            document.getElementById('progress-fill').style.width = data.progress + '%';
                            document.getElementById('progress-pct').textContent = data.progress + '%';
                        }
                        
                        // Add status message (with deduplication)
                        if (data.message) {
                            addStatusMessage(data.message, data.status);
                        }
                        
                        // Handle completion
                        if (data.status === 'complete') {
                            setTimeout(() => {
                                // Refresh main content
                                htmx.ajax('GET', window.location.pathname, {target: '#main-content', swap: 'innerHTML'});
                                
                                // Refresh project tree to update status indicators
                                htmx.ajax('GET', '/projects/tree', {target: '#project-tree-root', swap: 'innerHTML'});
                            }, 500);
                        }
                        
                    } catch (e) {
                        console.log('Parse error:', e, line);
                    }
                }
            }
        }
        
    } catch (error) {
        console.error('Build error:', error);
        addStatusMessage('Connection error. Please try again.', 'error');
        btn.disabled = false;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
    }
}

function addStatusMessage(message, status) {
    // Deduplicate: skip if identical to last message
    if (message === lastStatusMessage) {
        return;
    }
    lastStatusMessage = message;
    
    const container = document.getElementById('status-messages');
    const div = document.createElement('div');
    div.className = 'flex items-start gap-2 text-sm py-0.5';
    
    let iconHtml = '';
    if (status === 'complete') {
        iconHtml = '<i data-lucide="check-circle" class="w-4 h-4 text-emerald-500 flex-shrink-0 mt-0.5"></i>';
    } else if (status === 'error') {
        iconHtml = '<i data-lucide="x-circle" class="w-4 h-4 text-red-500 flex-shrink-0 mt-0.5"></i>';
    } else if (status === 'streaming') {
        iconHtml = '<i data-lucide="radio" class="w-4 h-4 text-violet-500 flex-shrink-0 mt-0.5 animate-pulse"></i>';
    } else {
        iconHtml = '<i data-lucide="bot" class="w-4 h-4 text-gray-400 dark:text-gray-500 flex-shrink-0 mt-0.5"></i>';
    }
    
    div.innerHTML = `${iconHtml}<span class="text-gray-600 dark:text-gray-400">${message}</span>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    
    // Re-init lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}
</script>