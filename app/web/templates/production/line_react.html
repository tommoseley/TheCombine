{% extends "public/layout/base.html" %}

{% block title %}Production Line{% if project %} - {{ project.name }}{% endif %} - The Combine{% endblock %}

{% block content %}
<!-- React via CDN - must be in content block since base.html has no head block -->
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<div id="production-line-root">
    <div class="p-6 text-gray-500">Loading Production Line...</div>
</div>

<script>
    window.INITIAL_DATA = {
        projectId: {{ (project.id|string|tojson) if project else 'null' }},
        projectName: {{ (project.name|tojson) if project else 'null' }},
        tracks: {{ tracks|tojson if tracks else '[]' }},
        lineState: {{ line_state|tojson if line_state else '"idle"' }},
        summary: {{ summary|tojson if summary else '{}' }},
        interrupt: {{ interrupt|tojson if interrupt else 'null' }}
    };
    console.log('INITIAL_DATA loaded:', window.INITIAL_DATA);
</script>

<script type="text/babel">
console.log('Babel script starting...');
const { useState, useEffect, useCallback, useRef } = React;

const STATE_COLORS = {
    stabilized: { bg: 'bg-green-500', light: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' },
    active: { bg: 'bg-amber-500 animate-pulse', light: 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400' },
    assembling: { bg: 'bg-amber-500 animate-pulse', light: 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400' },
    auditing: { bg: 'bg-amber-500 animate-pulse', light: 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400' },
    binding: { bg: 'bg-amber-500 animate-pulse', light: 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400' },
    remediating: { bg: 'bg-orange-500 animate-pulse', light: 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400' },
    awaiting_operator: { bg: 'bg-red-500', light: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400' },
    halted: { bg: 'bg-red-600', light: 'bg-red-200 text-red-900 dark:bg-red-900/50 dark:text-red-300' },
    blocked: { bg: 'bg-gray-400', light: 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400' },
    queued: { bg: 'bg-gray-300', light: 'bg-gray-50 text-gray-500 dark:bg-gray-800 dark:text-gray-400' },
};

function StateDot({ state }) {
    const colors = STATE_COLORS[state] || STATE_COLORS.queued;
    return <div className={`w-3 h-3 rounded-full ${colors.bg}`} />;
}

function StateBadge({ state }) {
    const colors = STATE_COLORS[state] || STATE_COLORS.queued;
    const label = (state || 'unknown').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    return <span className={`px-2 py-0.5 text-xs font-medium rounded-full ${colors.light}`}>{label}</span>;
}

function Track({ track, projectId }) {
    const isActive = ['active', 'assembling', 'auditing', 'binding', 'remediating'].includes(track.state);
    return (
        <div className={`p-4 ${isActive ? 'bg-amber-50/50 dark:bg-amber-900/10' : ''}`}>
            <div className="flex gap-4">
                <div className="flex-shrink-0 pt-1">
                    <StateDot state={track.state} />
                </div>
                <div className="flex-1 min-w-0 mr-4">
                    <div className="flex items-center gap-2 flex-wrap">
                        <span className="font-medium text-gray-900 dark:text-white">{track.document_name || track.document_type}</span>
                        <span className="text-xs text-gray-400 font-mono">({track.document_type})</span>
                        <StateBadge state={track.state} />
                    </div>
                    {track.description && (
                        <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">{track.description}</p>
                    )}
                </div>
                <div className="flex-shrink-0 flex items-start gap-2">
                    {track.state === 'queued' && (
                        <button 
                            onClick={async () => {
                                try {
                                    const res = await fetch(`/projects/${projectId}/documents/${track.document_type}/build`, { method: 'POST' });
                                    const data = await res.json();
                                    console.log('Build started:', data);
                                    // Refresh status after short delay
                                    setTimeout(() => window.location.reload(), 500);
                                } catch (err) {
                                    console.error('Build failed:', err);
                                }
                            }}
                            className="px-3 py-1.5 text-xs font-medium bg-violet-600 hover:bg-violet-700 text-white rounded">
                            Start Production
                        </button>
                    )}
                    {track.state === 'stabilized' && (
                        <a href={`/projects/${projectId}/documents/${track.document_type}`}
                           className="px-3 py-1.5 text-xs font-medium border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">
                            View Document
                        </a>
                    )}
                </div>
            </div>
            {track.state === 'blocked' && track.blocked_by && (
                <p className="mt-2 ml-6 text-xs text-gray-500">Awaiting: {track.blocked_by.join(', ')}</p>
            )}
        </div>
    );
}

function InterruptBanner({ interrupt, projectId }) {
    if (!interrupt) return null;
    return (
        <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
            <div className="flex items-start gap-3">
                <span className="text-red-600 text-xl">&#9888;</span>
                <div className="flex-1">
                    <h3 className="font-semibold text-red-800 dark:text-red-200">
                        Line Stopped: {interrupt.document_type} awaiting operator
                    </h3>
                    <p className="text-sm text-red-600 dark:text-red-400 mt-1">
                        {interrupt.interrupt_type === 'clarification' 
                            ? 'The system needs clarification to continue production.'
                            : 'The system needs your input to continue production.'}
                    </p>
                    <a href={`/projects/${projectId}/workflows/${interrupt.execution_id}/status`}
                       className="mt-3 inline-flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-md">
                        &#128172; Answer Questions
                    </a>
                </div>
            </div>
        </div>
    );
}

function ProductionLine() {
    const [state, setState] = useState({
        ...window.INITIAL_DATA,
        lineState: window.INITIAL_DATA.lineState || 'idle',
        tracks: window.INITIAL_DATA.tracks || [],
        summary: window.INITIAL_DATA.summary || {},
    });

    // SSE Connection
    useEffect(() => {
        if (!state.projectId) return;
        
        console.log('Connecting to SSE for project:', state.projectId);
        const es = new EventSource(`/api/v1/production/events?project_id=${state.projectId}`);
        
        es.addEventListener('connected', (e) => console.log('SSE connected:', JSON.parse(e.data)));
        
        const refreshStatus = async () => {
            try {
                const [statusRes, interruptRes] = await Promise.all([
                    fetch(`/api/v1/production/status?project_id=${state.projectId}`),
                    fetch(`/api/v1/projects/${state.projectId}/interrupts`)
                ]);
                const statusData = await statusRes.json();
                const interruptData = await interruptRes.json();
                
                setState(prev => ({
                    ...prev,
                    tracks: statusData.tracks || [],
                    lineState: statusData.line_state || 'idle',
                    summary: statusData.summary || {},
                    interrupt: interruptData?.length > 0 ? interruptData[0] : null,
                }));
            } catch (err) {
                console.error('Failed to refresh status:', err);
            }
        };

        ['station_transition', 'line_stopped', 'production_complete', 'track_started', 'track_stabilized', 'interrupt_resolved', 'document_escalated'].forEach(event => {
            es.addEventListener(event, (e) => {
                console.log(`SSE ${event}:`, JSON.parse(e.data));
                refreshStatus();
            });
        });
        
        es.onerror = (e) => console.error('SSE error:', e);
        
        return () => es.close();
    }, [state.projectId]);

    const isActive = state.lineState === 'active';
    const summary = state.summary || {};

    return (
        <div className="p-6 space-y-6">
            <div className="flex items-center gap-3">
                <h1 className="text-2xl font-bold text-gray-900 dark:text-white">Production Line</h1>
                {state.projectName && <span className="text-sm text-gray-500">{state.projectName}</span>}
            </div>

            <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className={`w-4 h-4 rounded-full ${isActive ? 'bg-amber-500 animate-pulse' : summary.stabilized === summary.total && summary.total > 0 ? 'bg-green-500' : 'bg-gray-400'}`} />
                        <span className="text-lg font-semibold text-gray-900 dark:text-white">
                            Status: <span className={isActive ? 'text-amber-600' : 'text-gray-500'}>
                                {isActive ? 'Active' : summary.stabilized === summary.total && summary.total > 0 ? 'Complete' : 'Idle'}
                            </span>
                        </span>
                    </div>
                    <div className="flex items-center gap-4 text-sm">
                        <span className="text-gray-500">{summary.stabilized || 0}/{summary.total || 0} Stabilized</span>
                        {summary.active > 0 && <span className="text-amber-600">{summary.active} Active</span>}
                        {summary.awaiting_operator > 0 && <span className="text-red-600 font-medium">{summary.awaiting_operator} Awaiting</span>}
                    </div>
                </div>
            </div>

            <InterruptBanner interrupt={state.interrupt} projectId={state.projectId} />

            <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                <div className="p-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 className="text-lg font-semibold text-gray-900 dark:text-white">Document Tracks</h2>
                </div>
                {state.tracks.length > 0 ? (
                    <div className="divide-y divide-gray-200 dark:divide-gray-700">
                        {state.tracks.map(track => (
                            <Track key={track.document_type} track={track} projectId={state.projectId} />
                        ))}
                    </div>
                ) : (
                    <div className="p-8 text-center text-gray-500">
                        <div className="text-4xl mb-3 opacity-50">&#128229;</div>
                        <p>No document tracks found</p>
                    </div>
                )}
            </div>
        </div>
    );
}

console.log('Rendering ProductionLine component...');
const root = ReactDOM.createRoot(document.getElementById('production-line-root'));
root.render(<ProductionLine />);
console.log('Render complete');
</script>
{% endblock %}