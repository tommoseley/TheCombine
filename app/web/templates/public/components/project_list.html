<!-- components/project_list.html -->
<!-- Accordion-based project tree with LAZY LOADING of document status -->

{% if projects and projects|length > 0 %}
    {# Separate active and archived projects #}
    {% set active_projects = [] %}
    {% set archived_projects = [] %}
    {% for project in projects %}
        {% if project.is_archived %}
            {% set _ = archived_projects.append(project) %}
        {% else %}
            {% set _ = active_projects.append(project) %}
        {% endif %}
    {% endfor %}
    
    {# Active Projects #}
    {% for project in active_projects %}
    <div class="project-accordion" data-project-id="{{ project.id }}">
        <!-- Project Header -->
        <div class="project-header w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors"
             data-project-url="/projects/{{ project.id }}">
            
            <!-- Expand/Collapse Chevron -->
            <button 
                type="button"
                onclick="event.stopPropagation(); toggleProjectAccordion(this, '{{ project.id }}')"
                class="p-1 -ml-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded transition-colors flex-shrink-0"
                aria-label="Toggle project documents">
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 dark:text-gray-500 accordion-chevron transition-transform"></i>
            </button>
            
            <!-- Project Link -->
            <a 
                href="/projects/{{ project.id }}"
                hx-get="/projects/{{ project.id }}"
                hx-target="#main-content"
                hx-push-url="true"
                class="flex items-center gap-2 flex-1 min-w-0"
                onclick="event.stopPropagation()">
                <i data-lucide="{{ project.icon | default('folder') }}" class="w-5 h-5 text-gray-500 dark:text-gray-400 flex-shrink-0"></i>
                <span class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate hover:text-violet-600 dark:hover:text-violet-400">{{ project.name }}</span>
            </a>
            
            <!-- Status summary placeholder (populated after lazy load) -->
            <div class="status-summary flex items-center gap-1.5 flex-shrink-0"></div>
        </div>
        
        <!-- Accordion Content: Lazy loaded documents -->
        <div class="accordion-content">
            <div class="ml-5 pl-4 border-l-2 border-gray-200 dark:border-gray-600 docs-container">
                <!-- Loading placeholder shown until HTMX fetches content -->
                <div class="px-2 py-3 text-sm text-gray-400 dark:text-gray-500">
                    <i data-lucide="loader-2" class="w-4 h-4 inline animate-spin mr-2"></i>
                    Loading documents...
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    
    {# Archived Projects Section #}
    {% if archived_projects|length > 0 %}
    <div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">
        <button 
            type="button"
            onclick="toggleArchivedSection()"
            class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors rounded-lg group"
            id="archived-section-toggle">
            <i data-lucide="chevron-right" id="archived-chevron" class="w-4 h-4 text-gray-400 dark:text-gray-500 transition-transform"></i>
            <i data-lucide="archive" class="w-4 h-4 text-gray-400 dark:text-gray-500"></i>
            <span class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Archived Projects</span>
            <span class="ml-auto text-xs text-gray-400 dark:text-gray-500 font-medium">{{ archived_projects|length }}</span>
        </button>
    </div>
    
    <div id="archived-projects-list" class="hidden">
        {% for project in archived_projects %}
        <div class="project-accordion opacity-60" data-project-id="{{ project.id }}">
            <div class="project-header w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors"
                 data-project-url="/projects/{{ project.id }}">
                <button 
                    type="button"
                    onclick="event.stopPropagation(); toggleProjectAccordion(this, '{{ project.id }}')"
                    class="p-1 -ml-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded transition-colors flex-shrink-0"
                    aria-label="Toggle project documents">
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 dark:text-gray-500 accordion-chevron transition-transform"></i>
                </button>
                <a 
                    href="/projects/{{ project.id }}"
                    hx-get="/projects/{{ project.id }}"
                    hx-target="#main-content"
                    hx-push-url="true"
                    class="flex items-center gap-2 flex-1 min-w-0"
                    onclick="event.stopPropagation()">
                    <i data-lucide="{{ project.icon | default('folder') }}" class="w-5 h-5 text-gray-500 dark:text-gray-400 flex-shrink-0"></i>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300 truncate hover:text-violet-600 dark:hover:text-violet-400">{{ project.name }}</span>
                </a>
                <i data-lucide="lock" class="w-4 h-4 text-amber-600 dark:text-amber-400 flex-shrink-0"></i>
            </div>
            <div class="accordion-content">
                <div class="ml-5 pl-4 border-l-2 border-gray-200 dark:border-gray-600 docs-container">
                    <div class="px-2 py-3 text-sm text-gray-400 dark:text-gray-500">
                        <i data-lucide="loader-2" class="w-4 h-4 inline animate-spin mr-2"></i>
                        Loading documents...
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
{% else %}
<div class="p-4 text-center">
    <i data-lucide="folder-open" class="w-8 h-8 text-gray-300 dark:text-gray-600 mx-auto mb-2"></i>
    <p class="text-sm text-gray-500 dark:text-gray-400">No projects yet</p>
    <a 
        href="/projects/new"
        hx-get="/projects/new"
        hx-target="#main-content"
        hx-push-url="true"
        class="text-sm text-violet-600 dark:text-violet-400 hover:text-violet-800 dark:hover:text-violet-300 mt-2 inline-block">
        Create your first project
    </a>
</div>
{% endif %}

<script>
function toggleArchivedSection() {
    const list = document.getElementById('archived-projects-list');
    const chevron = document.getElementById('archived-chevron');
    const isHidden = list.classList.contains('hidden');
    
    if (isHidden) {
        list.classList.remove('hidden');
        chevron.setAttribute('data-lucide', 'chevron-down');
        localStorage.setItem('archivedProjectsExpanded', 'true');
    } else {
        list.classList.add('hidden');
        chevron.setAttribute('data-lucide', 'chevron-right');
        localStorage.setItem('archivedProjectsExpanded', 'false');
    }
    
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const expanded = localStorage.getItem('archivedProjectsExpanded') === 'true';
    if (expanded) {
        const list = document.getElementById('archived-projects-list');
        const chevron = document.getElementById('archived-chevron');
        if (list && chevron) {
            list.classList.remove('hidden');
            chevron.setAttribute('data-lucide', 'chevron-down');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
    }
});
</script>
