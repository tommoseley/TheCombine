<div class="flex flex-col h-full">
    <!-- New Project Button -->
    <div class="p-3 border-b border-gray-200 dark:border-gray-700">
        <a 
            href="/projects/new"
            hx-get="/projects/new"
            hx-target="#main-content"
            hx-push-url="true"
            class="w-full bg-violet-600 hover:bg-violet-700 dark:bg-violet-500 dark:hover:bg-violet-600 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors focus:outline-none focus:ring-2 focus:ring-violet-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span>New Project</span>
        </a>
    </div>
    
    <!-- Project Accordion Tree -->
    <div class="flex-1 overflow-y-auto">
        <div 
            id="project-tree-root"
            hx-get="/projects/tree"
            hx-trigger="load"
            hx-swap="innerHTML"
            hx-indicator="#tree-loading"
            class="py-1">
            <!-- Projects loaded here via HTMX -->
            <div class="flex items-center justify-center py-8">
                <div id="tree-loading" class="htmx-indicator">
                    <i data-lucide="loader-2" class="w-6 h-6 animate-spin text-gray-400 dark:text-gray-500"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Accordion animation */
.accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.2s ease-out;
}
.accordion-content.open {
    max-height: 500px;
}

/* Active project header */
.project-header.active {
    background-color: rgb(76 29 149 / 0.2);
}

/* Active document link - Light mode */
.doc-link.active {
    background-color: rgb(243 232 255);
    border-left-color: rgb(124 58 237) !important;
}
.doc-link.active span {
    color: rgb(109 40 217);
    font-weight: 500;
}
.doc-link.active .doc-icon {
    color: rgb(124 58 237);
}

/* Active document link - Dark mode */
.dark .doc-link.active {
    background-color: rgb(124 58 237 / 0.15);
    border-left-color: rgb(139 92 246) !important;
}
.dark .doc-link.active span {
    color: rgb(196 181 253);
}
.dark .doc-link.active .doc-icon {
    color: rgb(167 139 250);
}
</style>

<script>
// Accordion toggle - collapse others when opening
// Note: button is now inside .project-header, not the header itself
// Save/restore expanded state for tree refreshes
var savedExpandedProjects = [];

function saveExpandedState() {
    savedExpandedProjects = [];
    document.querySelectorAll('.accordion-content.open').forEach(content => {
        const accordion = content.closest('.project-accordion');
        const projectId = accordion?.getAttribute('data-project-id');
        if (projectId) savedExpandedProjects.push(projectId);
    });
}

function restoreExpandedState() {
    savedExpandedProjects.forEach(projectId => {
        const accordion = document.querySelector(`.project-accordion[data-project-id="${projectId}"]`);
        if (accordion) {
            const content = accordion.querySelector('.accordion-content');
            const header = accordion.querySelector('.project-header');
            const chevron = accordion.querySelector('.accordion-chevron');
            if (content) content.classList.add('open');
            if (header) header.classList.add('active');
            if (chevron) chevron.setAttribute('data-lucide', 'chevron-down');
        }
    });
}

function toggleProjectAccordion(button, projectId) {
    const accordion = button.closest('.project-accordion');
    const content = accordion.querySelector('.accordion-content');
    const header = accordion.querySelector('.project-header');
    const chevron = button.querySelector('.accordion-chevron');
    const isOpening = !content.classList.contains('open');
    
    // Projects can stay expanded independently (no auto-collapse)
    
    // Toggle this one
    content.classList.toggle('open');
    header.classList.toggle('active');
    
    if (content.classList.contains('open')) {
        chevron.setAttribute('data-lucide', 'chevron-down');
    } else {
        chevron.setAttribute('data-lucide', 'chevron-right');
    }
    
    // Re-render icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

// Update active states based on current URL
function updateActiveStates() {
    const currentPath = window.location.pathname;
    
    // Remove all active states
    document.querySelectorAll('.project-header.active').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.doc-link.active').forEach(el => el.classList.remove('active'));
    // Note: We no longer collapse all accordions or reset chevrons - users can keep multiple projects open

    
    // Find matching document link and activate it + its parent project
    // BUT: Skip archived projects - they stay collapsed
    document.querySelectorAll('.doc-link').forEach(link => {
        const href = link.getAttribute('href');
        if (href && currentPath.startsWith(href)) {
            link.classList.add('active');
            
            // Open parent accordion ONLY if it's NOT in the archived section
            const accordion = link.closest('.project-accordion');
            if (accordion) {
                const isArchived = accordion.closest('#archived-projects-list') !== null;
                
                if (!isArchived) {
                    // Only auto-expand active projects
                    const content = accordion.querySelector('.accordion-content');
                    const header = accordion.querySelector('.project-header');
                    const chevron = accordion.querySelector('.accordion-chevron');
                    
                    content.classList.add('open');
                    header.classList.add('active');
                    chevron.setAttribute('data-lucide', 'chevron-down');
                }
            }
        }
    });
    
    // Also check project-level links (when viewing project detail page)
    // BUT: Skip archived projects - they stay collapsed
    document.querySelectorAll('.project-header').forEach(header => {
        const projectLink = header.getAttribute('data-project-url');
        if (projectLink && currentPath === projectLink) {
            header.classList.add('active');
            
            // Only auto-expand if NOT archived
            const accordion = header.closest('.project-accordion');
            const isArchived = accordion?.closest('#archived-projects-list') !== null;
            
            if (!isArchived && accordion) {
                const content = accordion.querySelector('.accordion-content');
                const chevron = accordion.querySelector('.accordion-chevron');
                
                content.classList.add('open');
                chevron.setAttribute('data-lucide', 'chevron-down');
            }
        }
    });
    
    // Re-render icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

// Save expanded state before tree refresh
document.body.addEventListener('htmx:beforeRequest', function(event) {
    if (event.target.id === 'project-tree-root' || event.detail.target?.id === 'project-tree-root') {
        saveExpandedState();
    }
});

// Run on page load
document.addEventListener('DOMContentLoaded', updateActiveStates);

// Run after HTMX swaps
document.body.addEventListener('htmx:afterSwap', function(event) {
    // Restore expanded state after tree refresh
    if (event.target.id === 'project-tree-root' || event.detail.target?.id === 'project-tree-root') {
        restoreExpandedState();
    }
    
    setTimeout(() => {
        updateActiveStates();
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }, 10);
});

// Run after URL changes
window.addEventListener('popstate', updateActiveStates);
document.body.addEventListener('htmx:pushedIntoHistory', updateActiveStates);
</script>








