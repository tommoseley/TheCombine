{# Document Not Found / Build UI #}
{# Shared partial for when a document doesn't exist yet #}
{# Expected variables: project, doc_type_id, doc_type_name, doc_type_icon, doc_type_description #}

<div class="p-6 max-w-4xl mx-auto">
    <!-- Header with breadcrumb -->
    <div class="mb-8">
        <nav class="text-sm text-gray-500 dark:text-gray-400 mb-2">
            <a href="/projects/{{ project.id if project.id is defined else project['id'] }}" 
               hx-get="/projects/{{ project.id if project.id is defined else project['id'] }}"
               hx-target="#main-content"
               hx-push-url="true"
               class="hover:text-gray-700 dark:hover:text-gray-200">
                {{ project.name if project.name is defined else project['name'] }}
            </a>
            <span class="mx-2">/</span>
            <span class="font-medium text-gray-900 dark:text-gray-100">{{ doc_type_name }}</span>
        </nav>
        
        <div class="flex items-center gap-3">
            <i data-lucide="{{ doc_type_icon | default('file-text') }}" class="w-10 h-10 text-gray-400 dark:text-gray-500"></i>
            <div>
                <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100">{{ doc_type_name }}</h1>
                <p class="text-gray-500 dark:text-gray-400">Not yet created</p>
            </div>
        </div>
    </div>

    <!-- Document Type Description Card -->
    {% if doc_type_description %}
    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">About This Document</h2>
        <div class="text-gray-600 dark:text-gray-400 whitespace-pre-line">{{ doc_type_description }}</div>
    </div>
    {% endif %}

    <!-- Build Card -->
    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-8">
        <div class="max-w-md mx-auto text-center">
            <i data-lucide="{{ doc_type_icon | default('file-text') }}" class="w-16 h-16 text-gray-300 dark:text-gray-600 mx-auto mb-4"></i>
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 mb-2">{{ doc_type_name }} Not Created</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-6">This document has not been generated yet. Click below to create it.</p>
            
            {% if is_blocked and missing_dependencies %}
            <!-- Dependencies not met -->
            <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4 mb-4">
                <div class="flex items-start gap-3">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5"></i>
                    <div>
                        <p class="font-medium text-amber-900 dark:text-amber-100">Dependencies Required</p>
                        <p class="text-sm text-amber-700 dark:text-amber-300 mt-1">
                            Create these documents first:
                            {% for dep in missing_dependencies %}
                            <a href="/projects/{{ project.id if project.id is defined else project['id'] }}/documents/{{ dep }}"
                               hx-get="/projects/{{ project.id if project.id is defined else project['id'] }}/documents/{{ dep }}"
                               hx-target="#main-content"
                               hx-push-url="true"
                               class="inline-block px-2 py-1 mt-1 mr-1 bg-amber-200 dark:bg-amber-800 rounded text-amber-800 dark:text-amber-200 hover:bg-amber-300 dark:hover:bg-amber-700">
                                {{ dep | replace('_', ' ') | title }}
                            </a>
                            {% endfor %}
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Build Button with Progress -->
            <div id="build-container">
                <button 
                    id="build-btn"
                    {% if is_blocked %}disabled{% endif %}
                    onclick="startDocumentBuild('{{ project.id if project.id is defined else project['id'] }}', '{{ doc_type_id }}')"
                    class="w-full px-4 py-3 {{ 'bg-gray-400 cursor-not-allowed' if is_blocked else 'bg-violet-600 hover:bg-violet-700' }} text-white rounded-lg transition-colors flex items-center justify-center gap-2 font-medium">
                    <i data-lucide="sparkles" class="w-5 h-5" id="btn-icon"></i>
                    <span id="btn-text">Generate {{ doc_type_name }}</span>
                </button>
                
                <!-- Progress Bar (hidden initially) -->
                <div id="progress-container" class="hidden mt-4">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Progress</span>
                        <span id="progress-pct" class="text-sm text-gray-500 dark:text-gray-400">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div id="progress-fill" class="bg-violet-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Status Messages (hidden initially) -->
                <div id="status-messages" class="hidden mt-4 text-left space-y-1 max-h-48 overflow-y-auto">
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Build tracking - uses task_id from backend
var BUILD_STORAGE_KEY = 'combine_document_builds';
var lastStatusMessage = '';

function trackBuildTask(projectId, docTypeId, taskId) {
    const key = `${projectId}:${docTypeId}`;
    const builds = JSON.parse(localStorage.getItem(BUILD_STORAGE_KEY) || '{}');
    builds[key] = { projectId, docTypeId, taskId, startedAt: Date.now() };
    localStorage.setItem(BUILD_STORAGE_KEY, JSON.stringify(builds));
}

function clearBuildTracking(projectId, docTypeId) {
    const key = `${projectId}:${docTypeId}`;
    const builds = JSON.parse(localStorage.getItem(BUILD_STORAGE_KEY) || '{}');
    delete builds[key];
    localStorage.setItem(BUILD_STORAGE_KEY, JSON.stringify(builds));
}

function getBuildTracking(projectId, docTypeId) {
    const key = `${projectId}:${docTypeId}`;
    const builds = JSON.parse(localStorage.getItem(BUILD_STORAGE_KEY) || '{}');
    return builds[key] || null;
}

async function startDocumentBuild(projectId, docTypeId) {
    const btn = document.getElementById('build-btn');
    const btnIcon = document.getElementById('btn-icon');
    const btnText = document.getElementById('btn-text');
    const progressContainer = document.getElementById('progress-container');
    const statusMessages = document.getElementById('status-messages');

    // Reset
    lastStatusMessage = '';
    
    // Update button to loading state
    btn.disabled = true;
    btn.classList.add('opacity-75', 'cursor-not-allowed');
    btnIcon.outerHTML = `<svg class="animate-spin w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>`;
    btnText.textContent = 'Generating...';
    
    // Show progress bar and messages
    progressContainer.classList.remove('hidden');
    statusMessages.classList.remove('hidden');
    statusMessages.innerHTML = '';
    
    try {
        // Start build task
        const response = await fetch(`/projects/${projectId}/documents/${docTypeId}/build`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (!result.task_id) {
            throw new Error('No task_id returned');
        }
        
        // Track the task
        trackBuildTask(projectId, docTypeId, result.task_id);
        addStatusMessage('Build started...', 'running');
        
        // Start polling
        pollTaskStatus(result.task_id, projectId, docTypeId);
        
    } catch (error) {
        console.error('Build start error:', error);
        addStatusMessage('Failed to start build. Please try again.', 'error');
        btn.disabled = false;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
    }
}

async function pollTaskStatus(taskId, projectId, docTypeId) {
    try {
        const response = await fetch(`/tasks/${taskId}/status`);
        
        // Handle 404 - task doesn't exist (server restarted or task expired)
        if (response.status === 404) {
            console.log('Task not found - clearing tracking');
            clearBuildTracking(projectId, docTypeId);
            addStatusMessage('Build interrupted. Please try again.', 'error');
            resetButton();
            return;
        }
        
        if (!response.ok) {
            throw new Error(`Status check failed: ${response.status}`);
        }
        
        const status = await response.json();
        
        // Update progress bar
        if (status.progress !== undefined) {
            const pf = document.getElementById('progress-fill');
            const pp = document.getElementById('progress-pct');
            if (pf) pf.style.width = status.progress + '%';
            if (pp) pp.textContent = status.progress + '%';
        }
        
        // Add status message
        if (status.message) {
            addStatusMessage(status.message, status.status);
        }
        
        // Handle completion
        if (status.status === 'complete') {
            clearBuildTracking(projectId, docTypeId);
            addStatusMessage('Complete!', 'complete');
            setTimeout(() => {
                htmx.ajax('GET', window.location.pathname, {target: '#main-content', swap: 'innerHTML'});
                htmx.ajax('GET', '/projects/tree', {target: '#project-tree-root', swap: 'innerHTML'});
            }, 500);
            return;
        }
        
        // Handle failure
        if (status.status === 'failed') {
            clearBuildTracking(projectId, docTypeId);
            addStatusMessage(status.error || 'Build failed', 'error');
            resetButton();
            return;
        }
        
        // Continue polling
        setTimeout(() => pollTaskStatus(taskId, projectId, docTypeId), 1000);
        
    } catch (error) {
        console.error('Poll error:', error);
        // Continue polling even on error (task might still be running)
        setTimeout(() => pollTaskStatus(taskId, projectId, docTypeId), 2000);
    }
}

function resetButton() {
    const btn = document.getElementById('build-btn');
    if (btn) {
        btn.disabled = false;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
    }
}

function addStatusMessage(message, status) {
    const container = document.getElementById('status-messages');
    if (!container) return;
    
    // Deduplicate
    if (message === lastStatusMessage) return;
    lastStatusMessage = message;
    
    const iconMap = {
        'pending': 'clock',
        'running': 'loader',
        'loading': 'loader',
        'generating': 'sparkles',
        'streaming': 'sparkles',
        'parsing': 'file-check',
        'saving': 'save',
        'complete': 'check-circle',
        'error': 'alert-circle',
        'failed': 'alert-circle'
    };
    
    const colorMap = {
        'pending': 'text-gray-500',
        'running': 'text-blue-500',
        'loading': 'text-blue-500',
        'generating': 'text-violet-500',
        'streaming': 'text-violet-500',
        'parsing': 'text-blue-500',
        'saving': 'text-blue-500',
        'complete': 'text-green-500',
        'error': 'text-red-500',
        'failed': 'text-red-500'
    };
    
    const icon = iconMap[status] || 'info';
    const color = colorMap[status] || 'text-gray-500';
    const animateClass = (status === 'running' || status === 'loading' || status === 'generating' || status === 'streaming') ? 'animate-spin' : '';
    
    const div = document.createElement('div');
    div.className = `flex items-center gap-2 text-sm ${color}`;
    div.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 ${animateClass}"></i><span>${message}</span>`;
    container.appendChild(div);
    
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

// Check for in-progress build on page load
(function checkForInProgressBuild() {
    const projectId = '{{ project.id if project.id is defined else project["id"] }}';
    const docTypeId = '{{ doc_type_id }}';
    
    const tracked = getBuildTracking(projectId, docTypeId);
    if (!tracked || !tracked.taskId) return;
    
    // If build is too old (> 10 minutes), clear it
    if (Date.now() - tracked.startedAt > 10 * 60 * 1000) {
        clearBuildTracking(projectId, docTypeId);
        return;
    }
    
    // Resume polling for existing task
    const btn = document.getElementById('build-btn');
    const progressContainer = document.getElementById('progress-container');
    const statusMessages = document.getElementById('status-messages');
    
    if (btn) {
        btn.disabled = true;
        btn.classList.add('opacity-75', 'cursor-not-allowed');
        const btnText = btn.querySelector('#btn-text');
        if (btnText) btnText.textContent = 'Generating...';
    }
    if (progressContainer) progressContainer.classList.remove('hidden');
    if (statusMessages) {
        statusMessages.classList.remove('hidden');
        statusMessages.innerHTML = '';
    }
    
    addStatusMessage('Resuming build...', 'running');
    pollTaskStatus(tracked.taskId, projectId, docTypeId);
})();
</script>






















