<div class="p-6 max-w-7xl mx-auto">
    {% set doc_title = "Story Backlog" %}
    {% set doc_icon = "list-checks" %}
    {% set doc_description = "Implementation-ready BA stories" %}
    {% include "public/pages/partials/_document_header.html" %}

    {% set backlog = content if content else {} %}
    {% set all_stories = backlog.stories if backlog.stories else [] %}
    
    {% if all_stories and all_stories|length > 0 %}
    
    <!-- Summary Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
            <div class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ all_stories|length }}</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Total Stories</div>
        </div>
        
        {% set mvp_stories = all_stories | selectattr('mvp_phase', 'equalto', 'mvp') | list %}
        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
            <div class="text-3xl font-bold text-violet-600 dark:text-violet-400">{{ mvp_stories|length }}</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">MVP Stories</div>
        </div>
        
        {% set later_stories = all_stories | selectattr('mvp_phase', 'equalto', 'later-phase') | list %}
        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
            <div class="text-3xl font-bold text-gray-600 dark:text-gray-400">{{ later_stories|length }}</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Later Phase</div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
            <div class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ backlog.epic_id }}</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Epic ID</div>
        </div>
    </div>
    
    <!-- Phase Filter Tabs -->
    <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
        <nav class="flex gap-4" id="phase-tabs">
            <button 
                type="button"
                onclick="filterStories('all')"
                class="phase-tab active px-4 py-2 text-sm font-medium border-b-2 border-violet-600 text-violet-600 dark:text-violet-400"
                data-phase="all">
                All Stories ({{ all_stories|length }})
            </button>
            <button 
                type="button"
                onclick="filterStories('mvp')"
                class="phase-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
                data-phase="mvp">
                MVP ({{ mvp_stories|length }})
            </button>
            <button 
                type="button"
                onclick="filterStories('later-phase')"
                class="phase-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
                data-phase="later-phase">
                Later Phase ({{ later_stories|length }})
            </button>
        </nav>
    </div>
    
    <!-- Stories Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-50 dark:bg-gray-900/50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider w-36">ID</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Title</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider w-24">Phase</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider w-20">AC</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700" id="stories-tbody">
                {% for story in all_stories %}
                <tr class="story-row cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50" 
                    data-phase="{{ story.mvp_phase }}"
                    onclick="toggleStoryDetails('{{ story.id | replace('-', '_') }}')">
                    <td class="px-4 py-3 text-sm font-mono text-violet-600 dark:text-violet-400">{{ story.id }}</td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-gray-100">{{ story.title }}</td>
                    <td class="px-4 py-3">
                        {% if story.mvp_phase == 'mvp' %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-violet-100 dark:bg-violet-900/30 text-violet-700 dark:text-violet-300">
                            MVP
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400">
                            Later
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">
                        {{ story.acceptance_criteria | length }}
                    </td>
                </tr>
                <!-- Expandable Details Row -->
                <tr class="story-details hidden bg-gray-50 dark:bg-gray-900/30" id="details-{{ story.id | replace('-', '_') }}" data-phase="{{ story.mvp_phase }}">
                    <td colspan="4" class="px-4 py-4">
                        <div class="pl-4 border-l-4 border-violet-500 space-y-4">
                            <!-- Description -->
                            <div>
                                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Description</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ story.description }}</p>
                            </div>
                            
                            <!-- Acceptance Criteria -->
                            {% if story.acceptance_criteria %}
                            <div>
                                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Acceptance Criteria</h4>
                                <ul class="space-y-1">
                                    {% for ac in story.acceptance_criteria %}
                                    <li class="flex items-start gap-2 text-sm text-gray-600 dark:text-gray-400">
                                        <i data-lucide="check-square" class="w-4 h-4 text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                        <span>{{ ac }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            
                            <!-- Related Architecture Components -->
                            {% if story.related_arch_components and story.related_arch_components|length > 0 %}
                            <div>
                                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Architecture Components</h4>
                                <div class="flex flex-wrap gap-2">
                                    {% for comp in story.related_arch_components %}
                                    <span class="text-xs px-2 py-1 rounded bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-mono">{{ comp }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Related PM Stories -->
                            {% if story.related_pm_story_ids and story.related_pm_story_ids|length > 0 %}
                            <div>
                                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Related PM Stories</h4>
                                <div class="flex flex-wrap gap-2">
                                    {% for pm_id in story.related_pm_story_ids %}
                                    <span class="text-xs px-2 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-mono">{{ pm_id }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Notes -->
                            {% if story.notes and story.notes|length > 0 %}
                            <div>
                                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Implementation Notes</h4>
                                <ul class="space-y-1">
                                    {% for note in story.notes %}
                                    <li class="flex items-start gap-2 text-sm text-gray-600 dark:text-gray-400">
                                        <i data-lucide="info" class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0"></i>
                                        <span>{{ note }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Raw JSON (collapsible) -->
    <details class="mt-8 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
        <summary class="px-6 py-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 flex items-center gap-2">
            <i data-lucide="code" class="w-5 h-5 text-gray-600 dark:text-gray-400"></i>
            <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Raw Data (JSON)</h2>
        </summary>
        <div class="p-6">
            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                <pre class="text-sm text-gray-700 dark:text-gray-300 overflow-x-auto"><code>{{ backlog | tojson(indent=2) }}</code></pre>
            </div>
        </div>
    </details>
    
    {% else %}
    <!-- No Stories Defined -->
    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-12 text-center">
        <i data-lucide="list-checks" class="w-16 h-16 text-gray-300 dark:text-gray-600 mx-auto mb-4"></i>
        <h2 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 mb-2">No Stories Defined</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-6">The BA has not yet generated implementation stories for this project.</p>
        
        <button 
            hx-post="/projects/{{ project.id }}/documents/story_backlog/build"
            hx-target="#main-content"
            hx-swap="innerHTML"
            class="bg-violet-600 hover:bg-violet-700 text-white font-medium py-2 px-4 rounded-lg inline-flex items-center gap-2">
            <i data-lucide="sparkles" class="w-4 h-4"></i>
            Generate Story Backlog
        </button>
    </div>
    {% endif %}
</div>

<script>
// Toggle story details expansion
function toggleStoryDetails(storyId) {
    const detailsRow = document.getElementById('details-' + storyId);
    if (detailsRow) {
        detailsRow.classList.toggle('hidden');
        // Re-initialize icons in expanded content
        if (typeof lucide !== 'undefined') {
            setTimeout(() => lucide.createIcons(), 50);
        }
    }
}

// Filter stories by phase
function filterStories(phase) {
    // Update tab active states
    document.querySelectorAll('.phase-tab').forEach(tab => {
        if (tab.dataset.phase === phase) {
            tab.classList.add('border-violet-600', 'text-violet-600', 'dark:text-violet-400');
            tab.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
        } else {
            tab.classList.remove('border-violet-600', 'text-violet-600', 'dark:text-violet-400');
            tab.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
        }
    });
    
    // Filter rows
    document.querySelectorAll('.story-row').forEach(row => {
        const rowPhase = row.dataset.phase;
        const storyId = row.getAttribute('onclick').match(/'([^']+)'/)[1];
        const detailsRow = document.getElementById('details-' + storyId);
        
        if (phase === 'all' || rowPhase === phase) {
            row.classList.remove('hidden');
        } else {
            row.classList.add('hidden');
            // Also hide details when filtering
            if (detailsRow) {
                detailsRow.classList.add('hidden');
            }
        }
    });
}
</script>