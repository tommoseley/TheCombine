{#
  Document Viewer Content Partial
  
  For HTMX swaps - includes header and wrapper, but not base layout.
  Targets #main-content swap.
#}

<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-5xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-semibold text-gray-900 dark:text-white">
                        {{ render_model.title }}
                    </h1>
                    {% if render_model.subtitle %}
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        {{ render_model.subtitle }}
                    </p>
                    {% endif %}
                </div>
                <div class="flex items-center gap-4">
                    {# Generate All Stories button for StoryBacklogView #}
                    {% if render_model.document_type == 'StoryBacklogView' and document_data and document_data.project_id %}
                    <button type="button"
                            id="generate-all-btn"
                            class="inline-flex items-center gap-2 px-4 py-2 bg-violet-600 hover:bg-violet-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            data-project-id="{{ document_data.project_id }}"
                            onclick="generateAllStories(this)">
                        <svg id="generate-all-spinner" class="hidden animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                        <span class="btn-text">Generate All Stories</span>
                    </button>
                    {% endif %}
                </div>
            </div>
            {# Status message area #}
            <div id="generate-status" class="mt-2"></div>
        </div>
    </header>
    
    <!-- Main content -->
    <main class="max-w-5xl mx-auto px-6 py-8">
        {% include "public/partials/_document_viewer.html" %}
    </main>
    
    {# Story generation scripts #}
    <script>
    function renderStoriesHtml(stories) {
        if (!stories || stories.length === 0) {
            return '<p class="text-sm text-gray-500 p-4">No stories generated</p>';
        }
        
        let html = `
            <div class="stories-section">
                <div class="px-4 py-2 bg-gray-50 border-b border-gray-100">
                    <span class="text-sm font-medium text-gray-700">Stories (${stories.length})</span>
                </div>
                <ul class="divide-y divide-gray-100">
        `;
        
        for (const story of stories) {
            const storyId = story.story_id || story.id || '';
            const title = story.title || 'Untitled';
            const intent = story.intent || story.description || '';
            const phase = story.phase || story.mvp_phase || 'mvp';
            const phaseClass = phase === 'mvp' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600';
            
            html += `
                <li class="px-4 py-3 hover:bg-gray-50 transition-colors">
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-mono text-gray-500">${storyId}</span>
                                <span class="text-sm font-medium text-gray-900">${title}</span>
                            </div>
                            ${intent ? `<p class="text-sm text-gray-600 mt-1 line-clamp-2">${intent}</p>` : ''}
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium ${phaseClass}">
                                ${phase.toUpperCase()}
                            </span>
                        </div>
                    </div>
                </li>
            `;
        }
        
        html += '</ul></div>';
        return html;
    }
    
    async function generateAllStories(btn) {
        const projectId = btn.dataset.projectId;
        
        if (!projectId) {
            console.error('Missing projectId');
            return;
        }
        
        // Disable button and show loading
        btn.disabled = true;
        const spinner = btn.querySelector('#generate-all-spinner');
        const btnText = btn.querySelector('.btn-text');
        spinner.classList.remove('hidden');
        btnText.textContent = 'Generating...';
        
        const statusDiv = document.getElementById('generate-status');
        
        // Hide all individual generate buttons and update "No stories" text
        document.querySelectorAll('.generate-epic-btn').forEach(epicBtn => {
            epicBtn.style.display = 'none';
        });
        
        // Change "No stories generated yet" to "Generating stories - please wait." on all cards
        document.querySelectorAll('.epic-stories-card').forEach(card => {
            const generateBtn = card.querySelector('.generate-epic-btn');
            const statusArea = card.querySelector('.generate-status');
            const noStoriesText = card.querySelector('.no-stories-text');
            
            if (noStoriesText) {
                noStoriesText.textContent = 'Generating stories - please wait.';
            }
            
            if (generateBtn && statusArea) {
                statusArea.innerHTML = '<span class="text-violet-400 flex items-center gap-2"><svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...</span>';
            }
        });
        
        statusDiv.innerHTML = '<span class="text-gray-500 text-sm">Starting parallel generation...</span>';
        
        let totalStories = 0;
        let completedEpics = 0;
        let totalEpics = 0;
        
        try {
            // Use fetch with SSE streaming
            const response = await fetch('/api/commands/story-backlog/generate-all-stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ project_id: projectId })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';
                
                for (const line of lines) {
                    if (!line.startsWith('data: ')) continue;
                    
                    try {
                        const data = JSON.parse(line.slice(6));
                        
                        if (data.type === 'start') {
                            totalEpics = data.total_epics;
                            statusDiv.innerHTML = `<span class="text-gray-500 text-sm">Generating stories for ${totalEpics} epics in parallel...</span>`;
                        }
                        else if (data.type === 'epic_complete') {
                            completedEpics = data.completed;
                            totalStories += data.stories_generated;
                            
                            // Update the specific epic card with stories
                            const card = document.querySelector(`.epic-stories-card[data-epic-id="${data.epic_id}"]`);
                            if (card) {
                                const statusArea = card.querySelector('.generate-status');
                                if (statusArea) {
                                    statusArea.innerHTML = `<span class="text-green-600 flex items-center gap-2"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> ${data.stories_generated} stories generated</span>`;
                                }
                                
                                // Replace "No stories" section with actual stories
                                const noStoriesSection = card.querySelector('.no-stories-section');
                                if (noStoriesSection && data.stories && data.stories.length > 0) {
                                    noStoriesSection.outerHTML = renderStoriesForCard(data.stories);
                                }
                            }
                            
                            statusDiv.innerHTML = `<span class="text-gray-500 text-sm">Generated ${completedEpics}/${totalEpics} epics (${totalStories} stories total)</span>`;
                        }
                        else if (data.type === 'epic_error') {
                            completedEpics = data.completed;
                            
                            const card = document.querySelector(`.epic-stories-card[data-epic-id="${data.epic_id}"]`);
                            if (card) {
                                const statusArea = card.querySelector('.generate-status');
                                if (statusArea) {
                                    statusArea.innerHTML = `<span class="text-red-600 flex items-center gap-2"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg> Error</span>`;
                                }
                            }
                            
                            statusDiv.innerHTML = `<span class="text-gray-500 text-sm">Generated ${completedEpics}/${totalEpics} epics (${totalStories} stories total)</span>`;
                        }
                        else if (data.type === 'complete') {
                            spinner.classList.add('hidden');
                            btnText.textContent = 'Done!';
                            btn.style.display = 'none';
                            
                            if (data.errors && data.errors.length > 0) {
                                statusDiv.innerHTML = `<span class="text-amber-600 text-sm"> Generated ${data.total_stories} stories for ${data.total_epics} epics (${data.errors.length} errors)</span>`;
                            } else {
                                statusDiv.innerHTML = `<span class="text-green-600 text-sm"> Generated ${data.total_stories} stories for ${data.total_epics} epics</span>`;
                            }
                        }
                        else if (data.type === 'error') {
                            spinner.classList.add('hidden');
                            btnText.textContent = 'Retry';
                            btn.disabled = false;
                            statusDiv.innerHTML = `<span class="text-red-600 text-sm">Error: ${data.message}</span>`;
                        }
                    } catch (parseError) {
                        console.warn('Failed to parse SSE data:', line, parseError);
                    }
                }
            }
        } catch (error) {
            spinner.classList.add('hidden');
            btnText.textContent = 'Retry';
            btn.disabled = false;
            statusDiv.innerHTML = `<span class="text-red-600 text-sm">Error: ${error.message}</span>`;
        }
    }
    
    function renderStoriesForCard(stories) {
        if (!stories || stories.length === 0) return '';
        
        const storyItems = stories.map(story => {
            const phase = story.phase || 'mvp';
            const phaseColor = phase === 'mvp' ? 'bg-violet-100 text-violet-800 dark:bg-violet-900 dark:text-violet-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
            return `
                <div class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-mono text-xs text-violet-600 dark:text-violet-400">${story.story_id || ''}</span>
                            <span class="px-2 py-0.5 text-xs rounded ${phaseColor}">${phase}</span>
                        </div>
                        <p class="text-sm font-medium text-gray-900 dark:text-gray-100">${story.title || 'Untitled'}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 line-clamp-2">${story.intent || ''}</p>
                    </div>
                </div>
            `;
        }).join('');
        
        return `<div class="space-y-2 mt-3">${storyItems}</div>`;
    }
    async function generateEpicStories(btn) {
        const epicId = btn.dataset.epicId;
        const viewer = btn.closest('.document-viewer');
        const projectId = viewer ? viewer.dataset.projectId : null;
        
        if (!projectId || !epicId) {
            console.error('Missing projectId or epicId');
            return;
        }
        
        // Disable button and show loading
        btn.disabled = true;
        const btnText = btn.querySelector('.btn-text');
        const originalText = btnText.textContent;
        btnText.textContent = 'Generating...';
        
        const statusDiv = btn.parentElement.querySelector('.generate-status');
        statusDiv.innerHTML = '<span class="text-gray-500">Calling LLM...</span>';
        
        try {
            const response = await fetch('/api/commands/story-backlog/generate-epic', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ project_id: projectId, epic_id: epicId })
            });
            
            const result = await response.json();
            
            if (result.status === 'completed' || result.status === 'skipped') {
                // Replace the entire card content below header with stories
                const card = btn.closest('.epic-stories-card');
                const noStoriesSection = card.querySelector('.bg-gray-50');
                if (noStoriesSection && result.stories && result.stories.length > 0) {
                    noStoriesSection.outerHTML = renderStoriesHtml(result.stories);
                } else if (result.status === 'skipped') {
                    statusDiv.innerHTML = `<span class="text-gray-500">Already has stories</span>`;
                    setTimeout(() => location.reload(), 1000);
                } else {
                    statusDiv.innerHTML = `<span class="text-green-600">Generated ${result.summary.stories_generated} stories!</span>`;
                    setTimeout(() => location.reload(), 1000);
                }
                
                // Hide Generate All button if no more epics need generation
                const remainingButtons = document.querySelectorAll('.generate-epic-btn');
                if (remainingButtons.length === 0) {
                    const generateAllBtn = document.getElementById('generate-all-btn');
                    if (generateAllBtn) generateAllBtn.style.display = 'none';
                }
            } else {
                statusDiv.innerHTML = `<span class="text-red-600">Error: ${result.error || 'Unknown error'}</span>`;
                btn.disabled = false;
                btnText.textContent = originalText;
            }
        } catch (error) {
            statusDiv.innerHTML = `<span class="text-red-600">Error: ${error.message}</span>`;
            btn.disabled = false;
            btnText.textContent = originalText;
        }
    }
    

    </script>
</div>















