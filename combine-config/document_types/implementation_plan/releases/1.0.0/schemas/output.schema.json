{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://thecombine.dev/schemas/implementation_plan_final.v2.json",
  "type": "object",
  "title": "Implementation Plan (Final)",
  "description": "Final implementation plan with committed Work Packages reconciled from WP candidates, informed by Technical Architecture.",
  "additionalProperties": false,
  "required": ["meta", "plan_summary", "work_packages", "candidate_reconciliation"],
  "properties": {
    "meta": {
      "type": "object",
      "additionalProperties": false,
      "required": ["schema_version", "artifact_id", "created_at", "source"],
      "properties": {
        "schema_version": { "type": "string", "const": "1.0" },
        "artifact_id": {
          "type": "string",
          "minLength": 1,
          "description": "Unique identifier for this artifact."
        },
        "correlation_id": {
          "type": "string",
          "minLength": 1,
          "description": "Correlation identifier linking to workflow run."
        },
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO-8601 timestamp of artifact creation."
        },
        "source": {
          "type": "string",
          "enum": ["human", "combine_generated", "mixed"],
          "description": "Provenance of the artifact content."
        }
      }
    },

    "plan_summary": {
      "type": "object",
      "description": "High-level plan overview",
      "additionalProperties": false,
      "required": ["overall_intent", "mvp_definition", "key_constraints", "sequencing_rationale"],
      "properties": {
        "overall_intent": {
          "type": "string",
          "minLength": 1,
          "description": "What this plan aims to achieve"
        },
        "mvp_definition": {
          "type": "string",
          "minLength": 1,
          "description": "What constitutes MVP"
        },
        "key_constraints": {
          "type": "array",
          "description": "Key constraints shaping the plan",
          "minItems": 0,
          "items": { "type": "string", "minLength": 1 }
        },
        "sequencing_rationale": {
          "type": "string",
          "minLength": 1,
          "description": "Why Work Packages are ordered this way"
        }
      }
    },

    "work_packages": {
      "type": "array",
      "description": "Committed Work Packages for implementation",
      "minItems": 1,
      "items": { "$ref": "#/definitions/work_package" }
    },

    "candidate_reconciliation": {
      "type": "array",
      "description": "Audit-friendly mapping of each IPP WP candidate to its final outcome in this plan.",
      "minItems": 0,
      "items": { "$ref": "#/definitions/candidate_reconciliation_item" }
    },

    "cross_cutting_concerns": {
      "type": "array",
      "description": "Concerns spanning multiple Work Packages",
      "minItems": 0,
      "items": { "type": "string", "minLength": 1 }
    },

    "risk_summary": {
      "type": "array",
      "description": "Aggregated risk summary across Work Packages",
      "minItems": 0,
      "items": { "$ref": "#/definitions/risk_summary_item" }
    }
  },

  "definitions": {
    "work_package": {
      "type": "object",
      "description": "A committed Work Package suitable for spawning a WP child document.",
      "additionalProperties": false,
      "required": [
        "wp_id",
        "title",
        "rationale",
        "scope_in",
        "scope_out",
        "dependencies",
        "definition_of_done",
        "governance_pins",
        "transformation",
        "source_candidate_ids"
      ],
      "properties": {
        "wp_id": {
          "type": "string",
          "description": "Unique identifier (snake_case). Prefer stability across revisions when meaning is preserved.",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable Work Package title"
        },
        "rationale": {
          "type": "string",
          "minLength": 1,
          "description": "Why this Work Package is needed"
        },
        "scope_in": {
          "type": "array",
          "description": "What is explicitly in scope",
          "minItems": 0,
          "items": { "type": "string", "minLength": 1 }
        },
        "scope_out": {
          "type": "array",
          "description": "What is explicitly excluded",
          "minItems": 0,
          "items": { "type": "string", "minLength": 1 }
        },
        "dependencies": {
          "type": "array",
          "description": "WP IDs this depends on",
          "minItems": 0,
          "items": { "$ref": "#/definitions/wp_dependency" }
        },
        "definition_of_done": {
          "type": "array",
          "description": "Measurable completion criteria",
          "minItems": 1,
          "items": { "type": "string", "minLength": 1 }
        },
        "governance_pins": {
          "type": "object",
          "description": "Governance references pinned at reconciliation time",
          "additionalProperties": false,
          "required": [],
          "properties": {
            "ta_version_id": {
              "type": "string",
              "minLength": 1,
              "description": "Technical Architecture version that informed this WP"
            },
            "adr_refs": {
              "type": "array",
              "items": { "type": "string" },
              "description": "ADR IDs that apply to this WP"
            },
            "policy_refs": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Policy IDs that apply to this WP"
            }
          }
        },

        "source_candidate_ids": {
          "type": "array",
          "description": "IPP WP candidate IDs that this committed WP was derived from. Empty only if transformation='added'.",
          "items": {
            "type": "string",
            "pattern": "^WPC-\\d{1,4}$",
            "description": "Must match IPP candidate_id format (e.g., WPC-001)."
          }
        },
        "transformation": {
          "type": "string",
          "description": "How this committed WP relates to IPP WP candidates.",
          "enum": ["kept", "split", "merged", "added"]
        },
        "transformation_notes": {
          "type": "string",
          "description": "Short justification for the transformation.",
          "minLength": 0,
          "maxLength": 600
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "transformation": { "const": "added" } },
            "required": ["transformation"]
          },
          "then": {
            "properties": {
              "source_candidate_ids": {
                "type": "array",
                "maxItems": 0
              }
            }
          }
        }
      ]
    },

    "wp_dependency": {
      "type": "object",
      "additionalProperties": false,
      "required": ["wp_id", "dependency_type"],
      "properties": {
        "wp_id": {
          "type": "string",
          "description": "Dependent wp_id",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "dependency_type": {
          "type": "string",
          "enum": ["must_complete_first", "can_start_after", "soft"]
        },
        "notes": {
          "type": "string",
          "minLength": 0,
          "maxLength": 400
        }
      }
    },

    "candidate_reconciliation_item": {
      "type": "object",
      "description": "How a single IPP WP candidate was treated in this final plan.",
      "additionalProperties": false,
      "required": ["candidate_id", "outcome", "resulting_wp_ids", "notes"],
      "properties": {
        "candidate_id": {
          "type": "string",
          "pattern": "^WPC-\\d{1,4}$",
          "description": "WP candidate identifier from Primary Implementation Plan."
        },
        "outcome": {
          "type": "string",
          "enum": ["kept", "split", "merged", "dropped"],
          "description": "Disposition of the candidate in the final plan"
        },
        "resulting_wp_ids": {
          "type": "array",
          "description": "Committed wp_id values that result from this candidate. Empty only when outcome='dropped'.",
          "items": { "type": "string", "pattern": "^[a-z][a-z0-9_]*$" }
        },
        "notes": {
          "type": "string",
          "description": "Short rationale for the reconciliation decision.",
          "minLength": 0,
          "maxLength": 600
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "outcome": { "const": "dropped" } },
            "required": ["outcome"]
          },
          "then": {
            "properties": {
              "resulting_wp_ids": {
                "type": "array",
                "maxItems": 0
              }
            }
          }
        },
        {
          "if": {
            "properties": { "outcome": { "enum": ["kept", "split", "merged"] } },
            "required": ["outcome"]
          },
          "then": {
            "properties": {
              "resulting_wp_ids": { "type": "array", "minItems": 1 }
            }
          }
        }
      ]
    },

    "risk_summary_item": {
      "type": "object",
      "additionalProperties": false,
      "required": ["risk", "affected_wps", "overall_impact", "mitigation_strategy"],
      "properties": {
        "risk": { "type": "string", "minLength": 1 },
        "affected_wps": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "pattern": "^[a-z][a-z0-9_]*$" }
        },
        "overall_impact": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"]
        },
        "mitigation_strategy": { "type": "string", "minLength": 1 }
      }
    }
  }
}
