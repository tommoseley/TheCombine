$schema: https://thecombine.ai/schemas/mech-op-registry.v1.json

types:
  extractor:
    name: "Extractor"
    description: "Extracts structured fields from a document using JSONPath expressions"
    icon: "scissors"
    category: "data_access"
    config_schema:
      type: object
      required:
        - source_type
        - field_paths
        - output_shape
      properties:
        source_type:
          type: string
          description: "Document type to extract from"
          ui_hint: "dropdown:document_types"
        field_paths:
          type: array
          description: "JSONPath expressions to extract"
          items:
            type: object
            required:
              - path
              - as
            properties:
              path:
                type: string
                description: "JSONPath expression (e.g., $.summary, $.items[*].name)"
              as:
                type: string
                description: "Output field name for the extracted value"
        output_shape:
          type: string
          description: "Schema for the extracted structure"
          ui_hint: "dropdown:schemas"
    inputs:
      - name: "source_document"
        type: "document"
        description: "The document to extract from"
    outputs:
      - name: "extracted"
        type: "object"
        description: "Extracted fields matching output_shape"

  merger:
    name: "Merger"
    description: "Combines multiple inputs into a single structured output"
    icon: "git-merge"
    category: "composition"
    config_schema:
      type: object
      required:
        - inputs
        - merge_strategy
        - output_shape
      properties:
        inputs:
          type: array
          description: "Input references with merge keys"
          items:
            type: object
            required:
              - ref
              - key
            properties:
              ref:
                type: string
                description: "Input reference (e.g., pass_a_output, entry_output)"
              key:
                type: string
                description: "Key in the merged output for this input"
        merge_strategy:
          type: string
          enum:
            - deep_merge
            - shallow_merge
            - concatenate
          description: "How to combine the inputs"
        output_shape:
          type: string
          description: "Schema for the merged output"
          ui_hint: "dropdown:schemas"
    inputs:
      - name: "inputs"
        type: "array"
        description: "Multiple inputs to merge"
    outputs:
      - name: "merged"
        type: "object"
        description: "Combined output matching output_shape"

  validator:
    name: "Validator"
    description: "Validates data against a schema and routes based on result"
    icon: "check-circle"
    category: "quality"
    config_schema:
      type: object
      required:
        - input
        - schema_ref
      properties:
        input:
          type: string
          description: "Reference to data to validate"
        schema_ref:
          type: string
          description: "Schema to validate against"
          ui_hint: "dropdown:schemas"
        on_pass:
          type: string
          default: "success"
          description: "Outcome when validation passes"
        on_fail:
          type: string
          default: "failed"
          description: "Outcome when validation fails"
    inputs:
      - name: "data"
        type: "any"
        description: "Data to validate"
    outputs:
      - name: "result"
        type: "object"
        description: "Validation result with valid flag and errors array"

  transformer:
    name: "Transformer"
    description: "Applies deterministic transformations to data structure"
    icon: "shuffle"
    category: "data_transform"
    config_schema:
      type: object
      required:
        - input
        - transform_rules
        - output_shape
      properties:
        input:
          type: string
          description: "Reference to input data"
        transform_rules:
          type: array
          description: "Transformation operations to apply"
          items:
            type: object
            description: "Transformation rule (flatten, rename, format, etc.)"
        output_shape:
          type: string
          description: "Schema for transformed output"
          ui_hint: "dropdown:schemas"
    inputs:
      - name: "source"
        type: "object"
        description: "Data to transform"
    outputs:
      - name: "transformed"
        type: "object"
        description: "Transformed data matching output_shape"

  selector:
    name: "Selector"
    description: "Routes workflow based on field values (deterministic branching)"
    icon: "git-branch"
    category: "flow_control"
    config_schema:
      type: object
      required:
        - input
        - field_path
        - routes
      properties:
        input:
          type: string
          description: "Reference to data containing selector field"
        field_path:
          type: string
          description: "JSONPath to the routing field"
        routes:
          type: object
          description: "Map of field values to outcome names"
          additionalProperties:
            type: string
        default:
          type: string
          description: "Fallback outcome if no route matches"
    inputs:
      - name: "data"
        type: "object"
        description: "Data containing the routing field"
    outputs:
      - name: "selected_route"
        type: "string"
        description: "The outcome name for the matched route"

  entry:
    name: "Entry"
    description: "Captures structured input from an operator via UI"
    icon: "user-edit"
    category: "human_input"
    config_schema:
      type: object
      required:
        - renders
        - captures
      properties:
        renders:
          type: string
          description: "Schema defining what to display to operator"
          ui_hint: "dropdown:schemas"
        captures:
          type: string
          description: "Schema defining expected operator response"
          ui_hint: "dropdown:schemas"
        entry_prompt:
          type: string
          description: "Instructions shown to operator"
        layout:
          type: string
          enum:
            - form
            - wizard
            - review
          default: form
          description: "UI layout hint"
        validation_mode:
          type: string
          enum:
            - strict
            - lenient
          default: strict
          description: "How strictly to enforce captures schema"
    inputs:
      - name: "context"
        type: "object"
        description: "Data to render for operator review/action"
    outputs:
      - name: "response"
        type: "object"
        description: "Structured operator input matching captures schema"

  clarification_merger:
    name: "Clarification Merger"
    description: "Merges PGC questions with operator answers, derives binding constraints"
    icon: "message-square-plus"
    category: "composition"
    config_schema:
      type: object
      properties:
        extract_invariants:
          type: boolean
          default: true
          description: "Also extract binding invariants from merged clarifications"
        normalize_answers:
          type: boolean
          default: true
          description: "Normalize answer text to canonical form"
    inputs:
      - name: "questions"
        type: "array"
        description: "PGC question objects from question generation"
      - name: "answers"
        type: "object"
        description: "Operator answers keyed by question ID"
    outputs:
      - name: "clarifications"
        type: "array"
        description: "Merged clarification objects with binding status"
      - name: "invariants"
        type: "array"
        description: "Binding invariants extracted from clarifications (if extract_invariants=true)"

  invariant_pinner:
    name: "Invariant Pinner"
    description: "Pins binding invariants into document known_constraints, removing duplicates"
    icon: "pin"
    category: "data_transform"
    config_schema:
      type: object
      properties:
        deduplicate:
          type: boolean
          default: true
          description: "Remove LLM constraints that duplicate pinned ones"
        keyword_match_threshold:
          type: integer
          default: 2
          description: "Minimum keyword matches to consider a constraint duplicate"
    inputs:
      - name: "document"
        type: "object"
        description: "Document to pin invariants into"
      - name: "invariants"
        type: "array"
        description: "Binding invariants to pin"
    outputs:
      - name: "document"
        type: "object"
        description: "Document with pinned constraints in known_constraints"

  exclusion_filter:
    name: "Exclusion Filter"
    description: "Filters document sections mentioning excluded topics"
    icon: "filter-x"
    category: "data_transform"
    config_schema:
      type: object
      properties:
        filter_recommendations:
          type: boolean
          default: true
          description: "Filter recommendations_for_pm mentioning exclusions"
        filter_decision_points:
          type: boolean
          default: true
          description: "Filter early_decision_points overlapping bindings"
    inputs:
      - name: "document"
        type: "object"
        description: "Document to filter"
      - name: "invariants"
        type: "array"
        description: "Invariants containing exclusion tags"
    outputs:
      - name: "document"
        type: "object"
        description: "Document with excluded topics filtered out"

categories:
  data_access:
    name: "Data Access"
    description: "Operations that read or extract from documents"
  composition:
    name: "Composition"
    description: "Operations that combine multiple inputs"
  quality:
    name: "Quality"
    description: "Operations that validate or check data"
  data_transform:
    name: "Data Transform"
    description: "Operations that reshape data structures"
  flow_control:
    name: "Flow Control"
    description: "Operations that determine workflow routing"
  human_input:
    name: "Human Input"
    description: "Operations that capture structured input from operators"
