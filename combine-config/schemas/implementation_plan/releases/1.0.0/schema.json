{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://thecombine.dev/schemas/implementation_plan.v3.json",
  "type": "object",
  "title": "Implementation Plan",
  "description": "Single implementation plan (post-Discovery, pre-TA) containing high-level plan intent, constraints, cross-cutting concerns, and candidate Work Packages (WPC-###). No committed Work Packages are created here; governed WPs are created later in the Work Binder after TA.",
  "additionalProperties": false,
  "required": [
    "meta",
    "plan_summary",
    "work_package_candidates",
    "cross_cutting_concerns",
    "risk_summary"
  ],
  "properties": {
    "meta": {
      "type": "object",
      "additionalProperties": false,
      "required": ["schema_version", "artifact_id", "created_at", "source"],
      "properties": {
        "schema_version": { "type": "string", "const": "3.0" },
        "artifact_id": { "type": "string", "minLength": 1 },
        "correlation_id": { "type": "string", "minLength": 1 },
        "created_at": { "type": "string", "format": "date-time" },
        "source": { "type": "string", "enum": ["human", "combine_generated", "mixed"] }
      }
    },

    "plan_summary": {
      "type": "object",
      "description": "High-level plan overview. Must remain architecture-agnostic (no component IDs, no technology choices).",
      "additionalProperties": false,
      "required": ["overall_intent", "mvp_definition", "key_constraints", "sequencing_rationale"],
      "properties": {
        "overall_intent": { "type": "string", "minLength": 1 },
        "mvp_definition": { "type": "string", "minLength": 1 },
        "key_constraints": {
          "type": "array",
          "minItems": 0,
          "items": { "type": "string", "minLength": 1 }
        },
        "sequencing_rationale": { "type": "string", "minLength": 1 },

        "assumptions": {
          "type": "array",
          "minItems": 0,
          "items": { "type": "string", "minLength": 1 }
        },
        "out_of_scope": {
          "type": "array",
          "minItems": 0,
          "items": { "type": "string", "minLength": 1 }
        }
      }
    },

    "work_package_candidates": {
      "type": "array",
      "description": "Candidate Work Packages. Advisory only. These are later promoted and bound to TA in the Work Binder.",
      "minItems": 1,
      "items": { "$ref": "#/definitions/work_package_candidate" }
    },

    "cross_cutting_concerns": {
      "type": "array",
      "description": "Concerns spanning multiple candidate Work Packages (e.g., security posture, audit, data retention, rollout strategy).",
      "minItems": 0,
      "items": { "type": "string", "minLength": 1 }
    },

    "risk_summary": {
      "type": "array",
      "description": "Aggregated risks across the plan. Candidate-level only; must not assume TA decisions.",
      "minItems": 0,
      "items": { "$ref": "#/definitions/risk_summary_item" }
    },

    "recommendations_for_architecture": {
      "type": "array",
      "description": "Architecture questions, areas of focus, or recommended investigation topics for the TA phase (not decisions).",
      "minItems": 0,
      "items": { "type": "string", "minLength": 1 }
    },

    "open_questions": {
      "type": "array",
      "description": "Questions that must be answered to reduce planning risk. Do not request secrets or credentials.",
      "minItems": 0,
      "items": { "$ref": "#/definitions/open_question" }
    }
  },

  "definitions": {
    "work_package_candidate": {
      "type": "object",
      "description": "A candidate Work Package intended to become a governed WP later (after TA) via Work Binder promotion.",
      "additionalProperties": false,
      "required": [
        "candidate_id",
        "title",
        "rationale",
        "scope_in",
        "scope_out",
        "dependencies",
        "definition_of_done"
      ],
      "properties": {
        "candidate_id": { "type": "string", "pattern": "^WPC-[0-9]{3}$" },
        "title": { "type": "string", "minLength": 1 },
        "rationale": { "type": "string", "minLength": 1 },

        "scope_in": {
          "type": "array",
          "minItems": 0,
          "items": { "type": "string", "minLength": 1 }
        },
        "scope_out": {
          "type": "array",
          "minItems": 0,
          "items": { "type": "string", "minLength": 1 }
        },

        "dependencies": {
          "type": "array",
          "description": "Candidate dependencies only: references other WPC-### or an external prerequisite. No TA component IDs here.",
          "minItems": 0,
          "items": { "$ref": "#/definitions/candidate_dependency" }
        },

        "definition_of_done": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 1 }
        },

        "sequencing_hint": {
          "type": "integer",
          "minimum": 1,
          "description": "Optional ordering hint. Not a commitment."
        },

        "notes_for_work_binder": {
          "type": "string",
          "minLength": 0,
          "maxLength": 1000,
          "description": "Optional notes for later WP promotion/binding after TA."
        }
      }
    },

    "candidate_dependency": {
      "type": "object",
      "additionalProperties": false,
      "required": ["dependency_type", "notes"],
      "properties": {
        "dependency_type": {
          "type": "string",
          "enum": ["must_complete_first", "can_start_after", "soft"]
        },
        "depends_on_candidate_id": {
          "type": "string",
          "pattern": "^WPC-[0-9]{3}$",
          "description": "Dependency on another candidate WP."
        },
        "depends_on_external": {
          "type": "string",
          "minLength": 3,
          "description": "External prerequisite dependency (e.g., 'SSO requirements clarified', 'Legal review complete')."
        },
        "notes": {
          "type": "string",
          "minLength": 0,
          "maxLength": 400
        }
      },
      "oneOf": [
        { "required": ["depends_on_candidate_id"] },
        { "required": ["depends_on_external"] }
      ]
    },

    "risk_summary_item": {
      "type": "object",
      "additionalProperties": false,
      "required": ["risk", "affected_candidates", "overall_impact", "mitigation_strategy"],
      "properties": {
        "risk": { "type": "string", "minLength": 1 },
        "affected_candidates": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "pattern": "^WPC-[0-9]{3}$" }
        },
        "overall_impact": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"]
        },
        "mitigation_strategy": { "type": "string", "minLength": 1 }
      }
    },

    "open_question": {
      "type": "object",
      "additionalProperties": false,
      "required": ["question", "why_it_matters", "who_needs_to_answer"],
      "properties": {
        "question": { "type": "string", "minLength": 1 },
        "why_it_matters": { "type": "string", "minLength": 1 },
        "who_needs_to_answer": { "type": "string", "minLength": 1 },
        "desired_by": { "type": "string", "minLength": 0 },
        "status": {
          "type": "string",
          "enum": ["open", "answered", "deferred"]
        }
      }
    }
  }
}