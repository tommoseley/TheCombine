{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://thecombine.ai/schemas/workflow.v1.json",
  "title": "Workflow Definition",
  "description": "Schema for The Combine workflow definitions per ADR-027 (supports v1 and v2)",
  "type": "object",
  "required": [
    "schema_version",
    "workflow_id",
    "revision",
    "effective_date",
    "name",
    "scopes",
    "document_types",
    "entity_types",
    "steps"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "enum": ["workflow.v1", "workflow.v2"],
      "description": "Schema version identifier"
    },
    "workflow_id": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9_]*$",
      "description": "Unique workflow identifier (snake_case)"
    },
    "revision": {
      "type": "string",
      "description": "Opaque revision identifier"
    },
    "effective_date": {
      "type": "string",
      "format": "date",
      "description": "Date this workflow version becomes effective (ISO 8601)"
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "description": "Human-readable workflow name"
    },
    "description": {
      "type": "string",
      "description": "Optional workflow description"
    },
    "pow_class": {
      "type": "string",
      "enum": ["reference", "project_instance"],
      "description": "POW classification (v2): reference template or project instance"
    },
    "derived_from": {
      "type": ["string", "null"],
      "description": "Parent POW ID if this is a derived instance (v2)"
    },
    "source_version": {
      "type": ["string", "null"],
      "description": "Version of source POW when derived (v2)"
    },
    "tags": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Workflow classification tags (v2)"
    },
    "scopes": {
      "$ref": "#/$defs/scopes"
    },
    "document_types": {
      "type": "object",
      "minProperties": 1,
      "additionalProperties": {
        "$ref": "#/$defs/documentType"
      },
      "description": "Document type definitions keyed by type ID"
    },
    "entity_types": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/entityType"
      },
      "description": "Entity type definitions keyed by type ID"
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/step"
      },
      "description": "Ordered list of workflow steps"
    }
  },
  "additionalProperties": true,
  "$defs": {
    "scopes": {
      "type": "object",
      "minProperties": 1,
      "additionalProperties": {
        "type": "object",
        "required": ["parent"],
        "properties": {
          "parent": {
            "type": ["string", "null"],
            "description": "Parent scope name, or null for root scope"
          }
        },
        "additionalProperties": true
      },
      "description": "Scope hierarchy definition"
    },
    "documentType": {
      "type": "object",
      "required": ["name", "scope", "may_own"],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable document type name"
        },
        "scope": {
          "type": "string",
          "description": "Scope level where this document exists"
        },
        "may_own": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Entity types this document may own"
        },
        "collection_field": {
          "type": "string",
          "description": "Field name containing owned entities (required if may_own is non-empty)"
        },
        "acceptance_required": {
          "type": "boolean",
          "default": false,
          "description": "Whether human acceptance is required"
        },
        "accepted_by": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1,
          "description": "Roles that may accept this document"
        }
      },
      "dependentSchemas": {
        "accepted_by": {
          "properties": {
            "acceptance_required": { "const": true }
          },
          "required": ["acceptance_required"]
        }
      },
      "additionalProperties": true
    },
    "entityType": {
      "type": "object",
      "required": ["name", "parent_doc_type", "creates_scope"],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable entity type name"
        },
        "parent_doc_type": {
          "type": ["string", "null"],
          "description": "Document type that owns entities of this type (null for top-level entities)"
        },
        "creates_scope": {
          "type": "string",
          "description": "Scope level created by entities of this type"
        }
      },
      "additionalProperties": true
    },
    "step": {
      "type": "object",
      "required": ["step_id"],
      "oneOf": [
        { "$ref": "#/$defs/productionStep" },
        { "$ref": "#/$defs/iterationStep" }
      ]
    },
    "productionStep": {
      "type": "object",
      "required": ["step_id", "role", "task_prompt", "produces", "scope", "inputs"],
      "properties": {
        "step_id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "Unique step identifier (snake_case)"
        },
        "role": {
          "type": "string",
          "minLength": 1,
          "description": "Role prompt name"
        },
        "task_prompt": {
          "type": "string",
          "minLength": 1,
          "description": "Task prompt name (must match pattern 'Name v#.#')"
        },
        "produces": {
          "type": "string",
          "description": "Document type ID this step produces"
        },
        "scope": {
          "type": "string",
          "description": "Scope level where this step executes"
        },
        "inputs": {
          "type": "array",
          "items": { "$ref": "#/$defs/inputReference" },
          "description": "Input documents/entities for this step"
        }
      },
      "additionalProperties": true
    },
    "iterationStep": {
      "type": "object",
      "required": ["step_id", "iterate_over", "scope", "steps"],
      "properties": {
        "step_id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "Unique step identifier (snake_case)"
        },
        "iterate_over": {
          "$ref": "#/$defs/iterationConfig"
        },
        "scope": {
          "type": "string",
          "description": "Scope level for iteration context"
        },
        "steps": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/step" },
          "description": "Steps to execute for each iteration item"
        }
      },
      "additionalProperties": true
    },
    "iterationConfig": {
      "type": "object",
      "required": ["doc_type", "collection_field", "entity_type"],
      "properties": {
        "doc_type": {
          "type": "string",
          "description": "Document type containing the collection"
        },
        "collection_field": {
          "type": "string",
          "description": "Field name of the collection to iterate"
        },
        "entity_type": {
          "type": "string",
          "description": "Entity type of collection items"
        }
      },
      "additionalProperties": false
    },
    "inputReference": {
      "type": "object",
      "required": ["scope"],
      "oneOf": [
        {
          "required": ["doc_type"],
          "not": { "required": ["entity_type"] }
        },
        {
          "required": ["entity_type"],
          "not": { "required": ["doc_type"] }
        }
      ],
      "properties": {
        "doc_type": {
          "type": "string",
          "description": "Document type to reference"
        },
        "entity_type": {
          "type": "string",
          "description": "Entity type to reference (iteration context)"
        },
        "scope": {
          "type": "string",
          "description": "Scope level to find the reference"
        },
        "required": {
          "type": "boolean",
          "default": true,
          "description": "Whether this input is required"
        },
        "context": {
          "type": "boolean",
          "default": false,
          "description": "Whether this is the iteration context item"
        }
      },
      "additionalProperties": false
    }
  }
}
