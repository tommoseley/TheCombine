{
  "schema_version": "workflow.v2",
  "workflow_id": "intake_and_route",
  "revision": "wfrev_2026_02_07_b",
  "effective_date": "2026-02-07",
  "name": "Intake & Routing",
  "description": "Front-door POW: captures operator intent, classifies project, routes to appropriate follow-on workflow",
  "pow_class": "reference",
  "derived_from": null,
  "source_version": null,
  "tags": ["intake", "routing", "front_door"],

  "scopes": {
    "project": { "parent": null }
  },

  "produced_artifacts": {
    "intake_record": {
      "name": "Intake Record",
      "scope": "project",
      "schema_ref": "schema:intake_record@1.0.0",
      "acceptance_required": false,
      "description": "Canonical intake artifact with reflected intent and intent classification"
    },
    "routing_decision": {
      "name": "Routing Decision",
      "scope": "project",
      "schema_ref": "schema:routing_decision@1.0.0",
      "acceptance_required": false,
      "description": "Which follow-on POW to spawn and why (includes candidates + confidence)"
    },
    "spawn_receipt": {
      "name": "Spawn Receipt",
      "scope": "project",
      "schema_ref": "schema:spawn_receipt@1.0.0",
      "acceptance_required": false,
      "description": "Record of spawned POW instance (child_execution_id + lineage pointers)"
    }
  },

  "steps": [
    {
      "step_id": "intake",
      "name": "Concierge Intake",
      "type": "dcw_run",
      "dcw_ref": "dcw:concierge_intake@1.4.0",
      "scope": "project",
      "inputs": [],
      "produces": {
        "artifact_id": "intake_record",
        "schema_ref": "schema:intake_record@1.0.0"
      },
      "description": "Run the Concierge Intake DCW to capture and classify operator intent"
    },
    {
      "step_id": "route_selection",
      "name": "Route Selection",
      "type": "mechanical_op",
      "op_ref": "op:intake_route@1.0.0",
      "scope": "project",
      "inputs": [
        { "artifact_id": "intake_record", "scope": "project" }
      ],
      "produces": {
        "artifact_id": "routing_decision",
        "schema_ref": "schema:routing_decision@1.0.0"
      },
      "config": {
        "min_confidence_to_auto_route": "medium",
        "route_on": "intake_record.intent_class",
        "routes": {
          "plan_work": "pow:software_product_development@1.0.0",
          "explore_problem": "pow:software_product_development@1.0.0",
          "change_existing": "pow:software_product_development@1.0.0",
          "integrate_systems": "pow:software_product_development@1.0.0",
          "produce_output": "pow:software_product_development@1.0.0",
          "unknown": "pow:software_product_development@1.0.0"
        }
      },
      "description": "Determine which follow-on POW to spawn based on intake classification"
    },
    {
      "step_id": "confirm_route",
      "name": "Confirm Route",
      "type": "entry_op",
      "op_ref": "op:confirm_route@1.0.0",
      "scope": "project",
      "optional": true,
      "condition": {
        "==": [
          { "var": "routing_decision.decision.confidence" },
          "low"
        ]
      },
      "inputs": [
        { "artifact_id": "routing_decision", "scope": "project" }
      ],
      "produces": {
        "artifact_id": "routing_decision",
        "schema_ref": "schema:routing_decision@1.0.0",
        "write_mode": "replace"
      },
      "description": "Operator confirms or corrects routing decision (only if low confidence)"
    },
    {
      "step_id": "validate_route",
      "name": "Validate Route Reference",
      "type": "mechanical_op",
      "op_ref": "op:validate_routing_decision@1.0.0",
      "scope": "project",
      "inputs": [
        { "artifact_id": "routing_decision", "scope": "project" }
      ],
      "produces": null,
      "config": {
        "must_resolve_pow_ref": true,
        "must_be_active_in_release": true
      },
      "description": "Fail fast if the selected next_pow_ref cannot be resolved or activated"
    },
    {
      "step_id": "spawn_pow",
      "name": "Spawn Follow-on POW",
      "type": "mechanical_op",
      "op_ref": "op:spawn_pow_instance@1.0.0",
      "scope": "project",
      "inputs": [
        { "artifact_id": "intake_record", "scope": "project" },
        { "artifact_id": "routing_decision", "scope": "project" }
      ],
      "produces": {
        "artifact_id": "spawn_receipt",
        "schema_ref": "schema:spawn_receipt@1.0.0"
      },
      "config": {
        "seed_inputs": [
          { "name": "intake_record", "from_artifact_id": "intake_record" },
          { "name": "routing_decision", "from_artifact_id": "routing_decision" }
        ],
        "write_project_event": true,
        "return_child_execution_id": true,
        "lineage": {
          "set_spawned_from_execution_id": true,
          "set_spawned_by_operation_id": true
        }
      },
      "description": "Create and initialize the follow-on POW instance, then hand off execution"
    },
    {
      "step_id": "end",
      "name": "Routed",
      "type": "end",
      "outcome": "routed",
      "description": "Intake complete, follow-on POW spawned"
    }
  ],

  "terminal_outcomes": {
    "routed": {
      "description": "Intake complete, follow-on POW spawned",
      "success": true
    },
    "abandoned": {
      "description": "Operator abandoned intake",
      "success": false
    }
  },

  "governance": {
    "adr_references": ["ADR-048"],
    "design_principles": [
      "Universal front door - all projects start here",
      "Explicit routing as governed mechanical operation",
      "Complete-and-handoff spawn model",
      "Full lineage via spawned_from_execution_id"
    ]
  },

  "metadata": {
    "created_date": "2026-02-07",
    "author": "system",
    "work_statement": "ADR-048"
  }
}
