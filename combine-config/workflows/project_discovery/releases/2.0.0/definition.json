{
  "$schema": "https://thecombine.ai/schemas/workflow.v2.json",
  "schema_version": "workflow.v2",
  "workflow_id": "project_discovery",
  "revision": "dcwrev_2026_02_09_a",
  "effective_date": "2026-02-09",
  "version": "2.0.0",
  "name": "Project Discovery",
  "description": "Discovery document creation with explicit PGC clarification gate and QA gate. Follows ADR-049 No Black Boxes principle.",
  "workflow_type": "dcw",
  "scope_type": "document",
  "document_type": "project_discovery",
  "thread_ownership": {
    "owns_thread": false,
    "thread_purpose": null
  },
  "entry_node_ids": ["pgc_gate"],
  "nodes": [
    {
      "node_id": "pgc_gate",
      "type": "gate",
      "name": "Clarification Gate",
      "description": "Pre-generation clarification to surface unknowns before document generation",
      "gate_kind": "pgc",
      "produces": "pgc_clarifications.discovery",
      "internals": {
        "pass_a": {
          "internal_type": "LLM",
          "name": "Question Generation",
          "description": "Generate clarification questions based on intake context",
          "template_ref": "prompt:template:pgc_clarifier:1.0.0",
          "includes": {
            "ROLE_PROMPT": "prompt:role:technical_architect:1.0.0",
            "TASK_PROMPT": "prompt:task:project_discovery:1.4.0",
            "PGC_CONTEXT": "prompt:pgc:project_discovery.v1:1.0.0"
          },
          "output_schema_ref": "schema:clarification_questions:1.0.0"
        },
        "entry": {
          "internal_type": "UI",
          "name": "Operator Answers",
          "description": "Operator provides answers to clarification questions",
          "op_ref": "mech:entry:pgc_operator_answers:1.0.0"
        },
        "merge": {
          "internal_type": "MECH",
          "name": "Merge Clarifications",
          "description": "Combine questions and answers into bound clarifications",
          "op_ref": "mech:merger:pgc_clarification_merge:1.0.0"
        }
      },
      "_position": { "x": 50, "y": 40 }
    },
    {
      "node_id": "generation",
      "type": "task",
      "name": "Document Generation",
      "description": "Generate Project Discovery document using clarified context",
      "internal_type": "LLM",
      "task_ref": "prompt:template:document_generator:1.0.0",
      "includes": {
        "ROLE_PROMPT": "prompt:role:technical_architect:1.0.0",
        "TASK_PROMPT": "prompt:task:project_discovery:1.4.0",
        "OUTPUT_SCHEMA": "schema:project_discovery:1.4.0"
      },
      "produces": "project_discovery",
      "inputs": [
        { "from": "pgc_gate", "field": "clarifications" }
      ],
      "_position": { "x": 50, "y": 230 }
    },
    {
      "node_id": "qa_gate",
      "type": "gate",
      "name": "Quality Gate",
      "description": "Structural and semantic QA evaluation with remediation loop",
      "gate_kind": "qa",
      "internals": {
        "evaluate": {
          "internal_type": "LLM",
          "name": "QA Evaluation",
          "description": "Evaluate document against quality criteria",
          "task_ref": "prompt:task:project_discovery_qa:1.1.0",
          "includes": {
            "ROLE_PROMPT": "prompt:role:quality_assurance:1.0.0"
          },
          "qa_mode": "semantic"
        }
      },
      "remediation": {
        "enabled": true,
        "max_attempts": 2,
        "feedback_to": "remediation"
      },
      "_position": { "x": 65, "y": 389 }
    },
    {
      "node_id": "remediation",
      "type": "task",
      "name": "Document Remediation",
      "description": "Rework document based on QA feedback",
      "internal_type": "LLM",
      "task_ref": "prompt:template:document_generator:1.0.0",
      "includes": {
        "ROLE_PROMPT": "prompt:role:technical_architect:1.0.0",
        "TASK_PROMPT": "prompt:task:project_discovery:1.4.0",
        "OUTPUT_SCHEMA": "schema:project_discovery:1.4.0"
      },
      "produces": "project_discovery",
      "inputs": [
        { "from": "qa_gate", "field": "feedback" }
      ],
      "_position": { "x": 539, "y": 207 }
    },
    {
      "node_id": "end_stabilized",
      "type": "end",
      "name": "Document Stabilized",
      "description": "Project Discovery document is complete and governed",
      "terminal_outcome": "stabilized",
      "_position": { "x": -164, "y": 796 }
    },
    {
      "node_id": "end_blocked",
      "type": "end",
      "name": "Document Blocked",
      "description": "Generation failed - circuit breaker or unrecoverable error",
      "terminal_outcome": "blocked",
      "_position": { "x": 190, "y": 800 }
    }
  ],
  "edges": [
    {
      "edge_id": "pgc_to_generation",
      "from_node_id": "pgc_gate",
      "to_node_id": "generation",
      "outcome": "qualified",
      "label": "Clarification complete"
    },
    {
      "edge_id": "pgc_needs_input",
      "from_node_id": "pgc_gate",
      "to_node_id": null,
      "outcome": "needs_user_input",
      "label": "Awaiting operator answers",
      "non_advancing": true
    },
    {
      "edge_id": "generation_to_qa",
      "from_node_id": "generation",
      "to_node_id": "qa_gate",
      "outcome": "success",
      "label": "Document generated, evaluate quality"
    },
    {
      "edge_id": "generation_failed",
      "from_node_id": "generation",
      "to_node_id": "end_blocked",
      "outcome": "failed",
      "label": "Generation failed"
    },
    {
      "edge_id": "qa_pass",
      "from_node_id": "qa_gate",
      "to_node_id": "end_stabilized",
      "outcome": "pass",
      "label": "QA passed - document stabilized"
    },
    {
      "edge_id": "qa_fail_remediate",
      "from_node_id": "qa_gate",
      "to_node_id": "remediation",
      "outcome": "fail",
      "label": "QA failed, attempt remediation",
      "conditions": [
        { "type": "retry_count", "operator": "lt", "value": 2 }
      ]
    },
    {
      "edge_id": "qa_circuit_breaker",
      "from_node_id": "qa_gate",
      "to_node_id": "end_blocked",
      "outcome": "fail",
      "label": "Circuit breaker - max remediation attempts",
      "conditions": [
        { "type": "retry_count", "operator": "gte", "value": 2 }
      ]
    },
    {
      "edge_id": "remediation_to_qa",
      "from_node_id": "remediation",
      "to_node_id": "qa_gate",
      "outcome": "success",
      "label": "Remediation complete, re-evaluate"
    },
    {
      "edge_id": "remediation_failed",
      "from_node_id": "remediation",
      "to_node_id": "end_blocked",
      "outcome": "failed",
      "label": "Remediation failed"
    }
  ],
  "terminal_outcomes": ["stabilized", "blocked"],
  "governance": {
    "adr_references": [
      "ADR-012",
      "ADR-039",
      "ADR-041",
      "ADR-045",
      "ADR-047",
      "ADR-049"
    ],
    "design_principles": [
      "No Black Boxes - all gates explicitly composed (ADR-049)",
      "PGC Gate: question_generation (LLM) → entry (UI) → merge (MECH)",
      "QA Gate: evaluate (LLM) with remediation loop",
      "Uses concierge_intake as upstream input"
    ],
    "circuit_breaker": {
      "max_retries": 2,
      "applies_to": ["qa_gate", "remediation"],
      "on_trip": "end_blocked"
    }
  },
  "metadata": {
    "created_date": "2026-02-09",
    "work_statement": "WS-ADR-049-001",
    "changelog": [
      "v2.0.0: Decomposed per ADR-049 No Black Boxes principle",
      "- PGC gate with explicit internals (pass_a/LLM, entry/UI, merge/MECH)",
      "- QA gate with explicit evaluate internal (LLM)",
      "- Generation and remediation nodes marked with internal_type: LLM",
      "- Schema upgraded to workflow.v2"
    ]
  },
  "requires_inputs": ["concierge_intake"]
}
