# ADR-034: Document Composition Manifest & Canonical Components

| | |
|---|---|
| **Status** | Accepted |
| **Date** | 2026-01-06 |
| **Decision Owner** | Product Owner |
| **Execution State** | complete |
| **Applies To** | All document-centric generation, validation, rendering, and prompt construction |

---

## 1. Context

The Combine operates as an industrial system for AI work. Documents are:
- Generated by LLMs
- Validated mechanically
- Rendered dynamically
- Governed and auditable

Prior ADRs established:
- ADR-031: Canonical schema registry
- ADR-032: Fragment-based rendering
- ADR-033: Data-only API contracts

However, a critical gap remained:

**Prompt instructions, schema definitions, and rendering fragments were not normalized into a single composable unit.**

This caused inevitable drift:
- A component could be reused structurally
- But its generation instructions had to be duplicated manually
- Rendering bindings were indirectly coupled

ADR-034 closes this gap by introducing Document Composition Manifests built from Canonical Component Specifications.

---

## 2. Decision

### 2.1 Canonical Component Specification (NEW)

A Canonical Component Specification is the atomic, reusable unit of document composition.

Each component specification defines everything required to:
- validate
- generate
- render

a document section.

A component specification MUST include:

| Aspect | Purpose |
|--------|---------|
| schema_id | Structural validation truth (ADR-031) |
| generation_guidance | LLM prompt bullets for generating this component |
| view_bindings | Fragment bindings per rendering channel (ADR-032) |

Component specifications are:
- Versioned
- Stored as governed artifacts in the database
- Referenced by Document Composition Manifests
- The only authorized location for component-specific instructions

---

### 2.2 Document Composition Manifest

A Document Composition Manifest defines what a document is by composing canonical components.

It specifies:
- Which components appear
- Where they appear in the JSON structure
- Ordering
- Repetition rules
- Section titles and labels

It does not:
- Define schemas
- Define prompt instructions
- Define rendering logic

Those are resolved via the referenced components.

---

### 2.3 Separation of Truths (Explicit)

| Concern | Owned By |
|---------|----------|
| Structural validation | JSON Schema (ADR-031) |
| Generation instructions | Component Specification |
| Rendering | Fragment Registry (ADR-032) |
| Data contracts | Render Model (ADR-033) |
| Composition & ordering | Document Composition Manifest (ADR-034) |

No single artifact may attempt to own more than its concern.

---

## 3. Canonical Component Specification Schema (Illustrative)

```json
{
  "component_id": "component:OpenQuestionV1:1.0.0",
  "schema_id": "schema:OpenQuestionV1",

  "generation_guidance": {
    "bullets": [
      "Provide a stable question id.",
      "Write a clear, specific question.",
      "Set blocking=true only if work cannot proceed responsibly.",
      "Explain why_it_matters in one sentence.",
      "Include options only if meaningful.",
      "If options exist, default_response SHOULD match one option.",
      "Use notes for assumptions or follow-ups."
    ]
  },

  "view_bindings": {
    "web": {
      "fragment_id": "fragment:OpenQuestionV1:web:1.0.0"
    }
  }
}
```

---

## 4. Document Composition Manifest Schema (Illustrative)

```json
{
  "document_id": "docdef:EpicBacklog:2.0.0",
  "document_schema_id": "schema:EpicBacklogV2",

  "sections": [
    {
      "section_id": "epic_open_questions",
      "title": "Epic Open Questions",
      "order": 30,

      "repeat_over": "/epics",
      "item_pointer": "/open_questions",

      "component_id": "component:OpenQuestionV1:1.0.0"
    }
  ]
}
```

Notes:
- Nested data is explicitly supported.
- No flattening is permitted to satisfy rendering.
- Composition respects domain reality (e.g., epics own their open questions).

---

## 5. Prompt Construction (Normalized)

### 5.1 Rule

Document-level prompts MUST NOT contain component-specific instructions.

### 5.2 Prompt Assembly is Mechanical

When constructing an LLM request:
1. Load Document Composition Manifest
2. Resolve referenced Component Specifications
3. Assemble prompt as:
   - Document-level header (role, constraints)
   - Concatenated component generation_guidance.bullets
4. Attach resolved schema bundle (ADR-031)

No handwritten duplication is permitted.

---

## 6. Rendering Flow (Aligned with ADR-033)

- APIs return data only
- Render Model contains blocks typed by component.schema_id
- Web channel:
  - Resolves component → fragment bindings
  - Calls FragmentRenderer
  - Produces HTML

Fragment rendering is a web-channel concern, not a contract concern.

---

## 7. Administrative Document Composer Capability

This ADR explicitly enables a Document Composer for administrators.

### 7.1 Admin-Editable Artifacts

An administrator may author and version:

1. **Component Specifications**
   - schema selection
   - generation bullets
   - fragment bindings

2. **Document Composition Manifests**
   - section ordering
   - repetition rules
   - component references

3. **Document Prompt Headers**
   - role definition
   - global constraints
   - non-component instructions

### 7.2 Derived (Not Authored)

The system derives:
- LLM prompts
- Validation bundles
- Render models
- Web view composition

Admins do not write:
- Schemas inline
- Prompt text per document
- Templates per document

---

## 8. Hard Rules (Enforced)

1. No document definition may embed component-specific prompt instructions
2. No prompt may describe how to fill a component outside its specification
3. No document schema may introduce a novel shape if an equivalent component exists
4. APIs MUST NOT return HTML
5. Rendering MUST be schema- and component-driven
6. Flattening domain data to satisfy rendering is prohibited

---

## 9. Storage

The following governed artifacts MUST be stored in the database:

| Artifact | Storage |
|----------|---------|
| Schema artifacts | schema_artifacts |
| Component specifications | component_artifacts |
| Fragment artifacts | fragment_artifacts |
| Document composition manifests | document_definitions |

Filesystem access is prohibited during prompt construction and rendering resolution.

---

## 10. Non-Goals

- Client-side editors (initially)
- Workflow/action bindings (future ADR)
- Per-block actions (future ADR)
- Automatic schema inference

---

## 11. Acceptance Criteria

ADR-034 is considered satisfied when:
- At least one canonical component (e.g., OpenQuestion) exists with schema, prompt guidance, and fragment binding
- A document type composes components without duplicating prompt text
- LLM prompts are assembled mechanically from component guidance
- Web rendering uses fragment bindings without API HTML leakage
- An administrator can define a new document type without writing:
  - a new schema
  - a new prompt
  - a new template

---

## 12. Shape Semantics Quick Reference

| Shape | `repeat_over` | Output |
|-------|---------------|--------|
| `single` | — | 1 block |
| `list` | — | N blocks (one per item) |
| `nested_list` | required | N blocks (one per item across all parents) |
| `container` | no | 1 block (all items) |
| `container` | yes | N blocks (one per parent, each containing that parent's items) |

**Key distinction:** `nested_list` → one block *per item*; `container + repeat_over` → one block *per parent*.

Behavior is mechanically deterministic: shape + pointers fully determine output structure. No inference, no magic, no document-type branching.

See [ADR-034-B](./ADR-034-Amendment-B.md) for full semantics and validation evidence.

> ⚠️ **Governance Notice**
>
> **DocDef is not a DSL.** The following are explicitly non-features:
> - No `filter` semantics
> - No wildcard pointers  
> - No nested `repeat_over`
> - No expression language / conditional logic
>
> Changes to shape semantics require governance approval. See [RENDER_SHAPES_SEMANTICS.md](../../governance/RENDER_SHAPES_SEMANTICS.md).

---

## 13. Amendments

- [ADR-034-A: Clarifications & Contract Completion](./ADR-034-Amendment-A.md)
- [ADR-034-B: Flatten-First Canonical Data, Hierarchy as View](./ADR-034-Amendment-B.md)

---

## 14. Changelog

| Date | Change |
|------|--------|
| 2026-01-06 | Initial ADR accepted |
| 2026-01-07 | Amendment A: Clarifications & Contract Completion |
| 2026-01-08 | Execution complete (WS-ADR-034-POC) |
| 2026-01-08 | Amendment B: Clarified flatten-first canonical modeling; related items are represented as flat structures with explicit references; hierarchical views are produced via container blocks during rendering. Confirmed boundary that container sections support a single level of parent iteration (no nested wildcard traversal), per EXP2 findings. |




