# Session Summary - 2026-01-24

## Scope

Document persistence on workflow completion, PGC payload contract hardening, semantic QA implementation, and prompt updates for decision promotion rules.

## Decisions Made

- `pending_prompt` renamed to `pending_user_input_rendered` for clarity; source of truth is `pending_user_input_payload` (structured object)
- PGC schema consistency enforced: `required`/`blocking` must derive from `priority` (must→true, should/could→false)
- "No budget questions" policy applies to both PGC and PD - frame resource questions as timeline, staffing, approval gates
- Semantic QA checks are prompt-based (v1.1) but non-deterministic; code-based validation deferred as technical debt
- System-owned metadata fields: `meta.created_at`, `meta.artifact_id`, `meta.correlation_id`, `meta.workflow_id`

## Implemented

### Document Persistence
- Added `_persist_produced_documents()` to `PlanExecutor`
- Documents persisted to `documents` table on successful completion (`terminal_outcome="stabilized"`)
- System overwrites LLM-minted meta fields with system values
- Deep copy prevents mutation of context_state
- Context_state updated with corrected document so API returns correct values

### PGC Payload Contract
- `pending_user_input_payload`: Structured JSON object (source of truth)
- `pending_user_input_schema_ref`: Schema identifier (e.g., "schema://clarification_question_set.v2")
- `pending_user_input_rendered`: Optional human-readable text (NOT JSON)
- Added new columns to `workflow_executions` table
- Updated persistence layer and API responses

### Prompt Updates
- `Clarification Questions Generator v1.1.txt`: Schema consistency rules (priority → required/blocking)
- `Project Discovery v1.3.txt`: Strict promotion rules, no budget questions, internal consistency
- `Project Discovery QA v1.1.txt`: Semantic checks (promotion validity, contradiction, policy, grounding)

### Workflow Updates
- `project_discovery.v1.json` → v1.7.0
- QA node uses semantic mode with v1.1 prompt
- PGC uses v1.1 generator prompt
- Generation uses v1.3 task prompt

## Updated or Created

### New Files
- `seed/prompts/tasks/Clarification Questions Generator v1.1.txt`
- `seed/prompts/tasks/Project Discovery v1.3.txt`
- `seed/prompts/tasks/Project Discovery QA v1.1.txt`
- `alembic/versions/add_pgc_payload_fields.py` (migration for new columns)

### Modified Files
- `app/api/models/workflow_execution.py` - Added payload/schema_ref columns, renamed pending_prompt
- `app/domain/workflow/document_workflow_state.py` - New fields, renamed pending_prompt
- `app/domain/workflow/pg_state_persistence.py` - New fields, renamed pending_prompt
- `app/domain/workflow/plan_executor.py` - Document persistence, pause handling, debug logging
- `app/domain/workflow/nodes/task.py` - PGC payload/schema_ref, human-readable prompt format
- `app/domain/workflow/nodes/base.py` - NodeResult payload/schema_ref fields
- `app/api/v1/routers/document_workflows.py` - API response models, db_session injection
- `app/web/routes/public/intake_workflow.py` - Renamed pending_prompt
- `app/web/routes/public/intake_workflow_routes.py` - Renamed pending_prompt
- `seed/workflows/project_discovery.v1.json` - v1.7.0 with updated prompt references
- 5 test files - Updated for field rename

## Commits / PRs

- None (pending test run and commit)

## Open Threads

### Integration Work (Next Priority)
1. Build PGC questions UI in document workflow experience
2. Store PGC answers as first-class document with provenance
3. Pass PGC answers explicitly to QA node for validation
4. Build document viewer in Admin UI

### Code-Based Semantic Validation (Technical Debt)
- LLM-based QA v1.1 didn't catch promotion violations (should→constraint)
- Need deterministic code-based validation layer:
  - Promotion validity: constraint only from must-answer
  - Internal contradiction: assumption ≠ constraint for same item
  - Policy conformance: no budget/authority questions

### Database Schema
- Run migration: `alembic upgrade head`
- Or manual: `ALTER TABLE workflow_executions ADD COLUMN pending_user_input_payload JSONB, ADD COLUMN pending_user_input_schema_ref VARCHAR(255);`

## Known Risks / Drift Warnings

- Semantic QA is non-deterministic (LLM-based); promotion violations may slip through
- Test run required after field rename (`pending_prompt` → `pending_user_input_rendered`)
- Old prompt files (v1.0, v1.2) still exist; consider cleanup after verification