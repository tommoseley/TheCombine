# Session Summary - 2026-01-24

## Scope

Document persistence on workflow completion, PGC payload contract hardening, semantic QA implementation, prompt updates for decision promotion rules, and WS-PGC-VALIDATION-001 implementation (code-based validation + PGC answer persistence).

## Decisions Made

- `pending_prompt` renamed to `pending_user_input_rendered` for clarity; source of truth is `pending_user_input_payload` (structured object)
- PGC schema consistency enforced: `required`/`blocking` must derive from `priority` (must->true, should/could->false)
- "No budget questions" policy applies to both PGC and PD - frame resource questions as timeline, staffing, approval gates
- System-owned metadata fields: `meta.created_at`, `meta.artifact_id`, `meta.correlation_id`, `meta.workflow_id`
- Code-based validation uses keyword extraction + Jaccard similarity (>0.5 threshold) for text matching
- PGC answers stored as first-class documents with full provenance tracking
- Repository pattern: does NOT commit - caller owns transaction

## Implemented

### Part 1: Document Persistence & PGC Payload (Claude Opus 4.5)

#### Document Persistence
- Added `_persist_produced_documents()` to `PlanExecutor`
- Documents persisted to `documents` table on successful completion (`terminal_outcome="stabilized"`)
- System overwrites LLM-minted meta fields with system values
- Deep copy prevents mutation of context_state

#### PGC Payload Contract
- `pending_user_input_payload`: Structured JSON object (source of truth)
- `pending_user_input_schema_ref`: Schema identifier (e.g., "schema://clarification_question_set.v2")
- `pending_user_input_rendered`: Optional human-readable text (NOT JSON)
- Added new columns to `workflow_executions` table

#### Prompt Updates
- `Clarification Questions Generator v1.1.txt`: Schema consistency rules
- `Project Discovery v1.3.txt`: Strict promotion rules, no budget questions
- `Project Discovery QA v1.1.txt`: Semantic checks (4 categories)
- `project_discovery.v1.json` -> v1.7.0

### Part 2: WS-PGC-VALIDATION-001 (Claude Code)

#### Phase 1: Code-Based Promotion Validation
- `PromotionValidator` with 4 deterministic rule checks:
  - Promotion validity (constraints must trace to must-priority answers)
  - Internal contradiction (same concept in constraints and assumptions)
  - Policy conformance (no budget/authority questions)
  - Grounding validation (guardrails must trace to input)
- Keyword extraction with stopword removal
- Jaccard similarity for text comparison
- Integration in QA node before LLM-based QA

#### Phase 2: PGC Answer Persistence
- `PGCAnswer` model with full provenance tracking
- `PGCAnswerRepository` (does NOT commit - caller owns transaction)
- Migration for `pgc_answers` table
- Persist answers when user submits at PGC node
- Load answers into context for QA validation
- `GET /executions/{id}/pgc-answers` endpoint

## Updated or Created

### Work Statements Created
- `docs/work-statements/WS-PGC-UX-001.md` - PGC Questions UI Integration (ready for Claude Code)

### New Files (Part 1)
- `seed/prompts/tasks/Clarification Questions Generator v1.1.txt`
- `seed/prompts/tasks/Project Discovery v1.3.txt`
- `seed/prompts/tasks/Project Discovery QA v1.1.txt`
- `alembic/versions/add_pgc_payload_fields.py`
- `docs/work-statements/WS-PGC-VALIDATION-001.md`

### New Files (Part 2 - Claude Code)
- `app/domain/workflow/validation/__init__.py`
- `app/domain/workflow/validation/validation_result.py`
- `app/domain/workflow/validation/rules.py`
- `app/domain/workflow/validation/promotion_validator.py`
- `app/api/models/pgc_answer.py`
- `app/domain/repositories/pgc_answer_repository.py`
- `alembic/versions/20260124_001_create_pgc_answers_table.py`
- `tests/tier1/workflow/validation/test_promotion_validator.py` (29 tests)
- `tests/tier1/repositories/test_pgc_answer_repository.py` (7 tests)

### Modified Files
- `app/api/models/workflow_execution.py` - payload/schema_ref columns, renamed pending_prompt
- `app/domain/workflow/document_workflow_state.py` - New fields, renamed pending_prompt
- `app/domain/workflow/pg_state_persistence.py` - New fields, renamed pending_prompt
- `app/domain/workflow/plan_executor.py` - Document persistence, PGC answer loading
- `app/domain/workflow/nodes/task.py` - PGC payload/schema_ref
- `app/domain/workflow/nodes/base.py` - NodeResult payload/schema_ref fields
- `app/domain/workflow/nodes/qa.py` - Code-based validation integration
- `app/api/v1/routers/document_workflows.py` - Response models, PGC answer endpoint
- `app/api/models/__init__.py` - Export PGCAnswer
- `seed/workflows/project_discovery.v1.json` - v1.7.0

## Commits / PRs

- `feat: Document persistence, PGC payload hardening, semantic QA` (Part 1)
- `feat: implement WS-PGC-VALIDATION-001 code-based validation and PGC answer persistence` (Part 2)

## Open Threads

### UX Integration (Next Priority)
1. Build PGC questions UI in document workflow experience
2. Render questions from `pending_user_input_payload`
3. Handle different answer types (single_choice, multi_choice, yes_no, free_text)
4. Build document viewer in Admin UI

### Database Migrations Required
```sql
-- Migration 1: add_pgc_payload_fields
ALTER TABLE workflow_executions 
ADD COLUMN pending_user_input_payload JSONB,
ADD COLUMN pending_user_input_schema_ref VARCHAR(255);

-- Migration 2: create_pgc_answers_table
CREATE TABLE pgc_answers (
    id UUID PRIMARY KEY,
    execution_id VARCHAR(36) NOT NULL,
    workflow_id VARCHAR(100) NOT NULL,
    project_id UUID NOT NULL REFERENCES projects(id),
    pgc_node_id VARCHAR(100) NOT NULL,
    schema_ref VARCHAR(255) NOT NULL,
    questions JSONB NOT NULL,
    answers JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX ix_pgc_answers_execution_id ON pgc_answers(execution_id);
```

## Known Risks / Drift Warnings

- Old prompt files (v1.0, v1.2) still exist; consider cleanup after verification
- 36 new tests added (29 validation + 7 repository)

## Technical Debt Resolved

- [x] Code-based validation replaces non-deterministic LLM checks
- [x] PGC answers now first-class documents with audit trail