# Session Summary - 2026-02-04

## Scope
- Restructure Admin Workbench workflow editing: separate Document Production Workflows from Project Orchestration Workflows
- Build interactive step editor for orchestration workflows with drag-to-reorder
- Backend CRUD endpoints for orchestration workflow lifecycle

## Decisions Made
- Document Production Workflows (graph-based, ADR-039: concierge_intake, project_discovery) belong as a "Workflow" tab on their document type in PromptEditor
- Project Orchestration Workflows (step-based, workflow.v1: software_product_development) belong in the sidebar "Workflows" section with their own editor
- Orchestration workflow steps declare WHAT document to produce, not HOW — role and task_prompt belong on the document production workflow's task node, not on the orchestration step
- @dnd-kit chosen for drag-to-reorder (modern React DnD standard, ~15KB gzipped, supports nested sortable contexts)
- Orchestration workflow create/delete operates through workspace service for Git-branch isolation

## Implemented
- **Backend: workflow_ref on DocumentTypeDetail** — reverse lookup from workflow `document_type` field, cached mapping, returned in API response
- **Backend: orchestration workflow list endpoint** — `GET /workbench/orchestration-workflows` filters for step-based workflows
- **Backend: tier1 validation guard** — step-based workflows skip PlanValidator, get JSON validity check only
- **Backend: create/delete orchestration workflow** — `POST/DELETE /{workspace_id}/orchestration-workflows`, handles directory structure, definition.json skeleton, active_releases.json updates
- **Frontend: WorkflowEditorContent extraction** — reusable React Flow canvas component for embedding in PromptEditor
- **Frontend: Workflow tab on PromptEditor** — shows React Flow canvas for document types with associated production workflows
- **Frontend: sidebar repurposed** — now fetches orchestration workflows only, shows step_count
- **Frontend: StepWorkflowEditor** — full interactive editor with Steps/JSON/Metadata tabs
- **Frontend: editable step cards** — inline form fields for step_id, produces, scope, creates_entities, inputs array
- **Frontend: drag-to-reorder** — @dnd-kit sortable with drag handles, nested DndContext for iteration steps
- **Frontend: add/delete steps** — production step and iteration step skeletons, delete button per card
- **Frontend: create/delete workflows** — "+ New" button in sidebar with inline form, delete button in editor header
- **Seed: software_product_development workflow** — copied to combine-config with active release pointer
- **Removed role/task_prompt from orchestration step editor** — these belong on the document production workflow, not the orchestration step

## Updated or Created
- app/api/services/admin_workbench_service.py (modified — workflow_ref mapping, orchestration list)
- app/api/services/workspace_service.py (modified — tier1 guard, create/delete orchestration workflow)
- app/api/v1/routers/admin_workbench.py (modified — workflow_ref, orchestration models/endpoint)
- app/api/v1/routers/admin_workspaces.py (modified — create/delete orchestration workflow endpoints)
- app/web/templates/admin/pages/workflow_detail.html (modified — updated for ADR-039 WorkflowPlan model)
- combine-config/_active/active_releases.json (modified — added software_product_development)
- combine-config/workflows/software_product_development/releases/1.0.0/definition.json (new)
- spa/src/components/admin/workflow/WorkflowEditorContent.jsx (new — extracted from WorkflowEditor)
- spa/src/components/admin/workflow/StepWorkflowEditor.jsx (new — interactive step editor)
- spa/src/components/admin/workflow/WorkflowEditor.jsx (modified — thin wrapper)
- spa/src/components/admin/PromptEditor.jsx (modified — Workflow tab)
- spa/src/components/admin/AdminWorkbench.jsx (modified — StepWorkflowEditor, create/delete handlers)
- spa/src/components/admin/DocTypeBrowser.jsx (modified — orchestration workflows, + New button)
- spa/src/api/adminClient.js (modified — orchestration endpoints, create/delete methods)
- spa/src/hooks/useAdminWorkflows.js (modified — fetches orchestration endpoint)
- spa/package.json (modified — @dnd-kit dependencies)

## Commits / PRs
- None (all changes uncommitted)

## Open Threads
- Produces field should be a dropdown of available document production workflows (in progress when session paused)
- Existing software_product_development definition.json still has role/task_prompt fields on steps — data cleanup needed to match new architecture
- workflow.v1 schema may need updating to reflect that role/task_prompt are not orchestration-level concerns

## Known Risks / Drift Warnings
- Large number of uncommitted changes across backend and frontend — should commit soon
- Step ID uniqueness is not validated client-side (duplicate step_ids could cause drag-and-drop issues)
