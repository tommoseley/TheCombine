# Session Summary - 2026-02-07

## Scope
- Complete WS-ADR-047-005 Phase 4 (IntakeGateProfileExecutor) and Phase 5 (cleanup)
- Activate and test Gate Profile v1.4.0 for concierge_intake workflow
- Draft ADR-048 for Intake POW and Workflow Routing architecture
- Create `intake_and_route` POW as the front-door workflow
- Implement all ADR-048 mechanical operations (router, validator, entry, spawner)

## Decisions Made
- Gate Profile pattern adopted: Gates with internals (pass_a/LLM, extract/MECH, entry/UI, pin/MECH) replace special-case executor code
- Complete-and-handoff spawn model: Intake POW completes fully, spawns distinct POW execution with lineage tracking
- Routing as mechanical operation: Route selection is config-driven via RouterHandler, no LLM for routing decisions
- Lineage tracking: Spawned POW stores `spawned_from_execution_id`, `spawned_by_operation_id`; project maintains `executions[]` array
- ADR-047 marked complete (all 5 work statements delivered)
- Adopted enhanced POW definition structure from ChatGPT proposal (produced_artifacts, validate step, JSONLogic conditions)
- Use `concierge_intake` as artifact name in POW (matches DCW output) rather than abstract `intake_record`

## Implemented
- `app/domain/workflow/nodes/intake_gate_profile.py` - IntakeGateProfileExecutor for Gate Profile pattern
- `app/domain/workflow/nodes/gate.py` - Updated to delegate to profile executor when internals present
- `app/domain/workflow/plan_executor.py` - Added `internals` field to node_config, scoped legacy pause to INTAKE_GATE only
- `app/api/services/mech_handlers/router.py` - RouterHandler for intake_route operation
- `app/api/services/mech_handlers/validator.py` - ValidatorHandler for validate_routing_decision operation
- `app/api/services/mech_handlers/spawner.py` - SpawnerHandler for spawn_pow_instance operation
- `app/api/services/mech_handlers/base.py` - Enhanced pending_entry() with ui_hints, merge_strategy, renders_schema
- `app/api/services/mech_handlers/entry.py` - Enhanced EntryHandler for confirm_route with merge_strategy support
- `combine-config/workflows/intake_and_route/releases/1.0.0/definition.json` - Front-door POW (6 steps with validate)
- `combine-config/mechanical_ops/intake_route/releases/1.0.0/operation.yaml` - Router operation
- `combine-config/mechanical_ops/validate_routing_decision/releases/1.0.0/operation.yaml` - Validator operation
- `combine-config/mechanical_ops/confirm_route/releases/1.0.0/operation.yaml` - Entry operation
- `combine-config/mechanical_ops/spawn_pow_instance/releases/1.0.0/operation.yaml` - Spawner operation
- `combine-config/schemas/routing_decision/releases/1.0.0/schema.json` - Routing decision schema
- `combine-config/schemas/spawn_receipt/releases/1.0.0/schema.json` - Spawn receipt with lineage
- `combine-config/schemas/route_confirmation/releases/1.0.0/schema.json` - Operator confirmation schema
- `docs/adr/ADR-048-intake-pow-and-routing.md` - Full ADR for Intake POW architecture

## Updated or Created
- `combine-config/_active/active_releases.json` - Added all new schemas and operations
- `seed/workflows/concierge_intake.v1.json` - Synced v1.4.0 from combine-config
- `app/api/services/mech_handlers/__init__.py` - Added RouterHandler, ValidatorHandler, SpawnerHandler
- `docs/PROJECT_STATE.md` - Updated with ADR-048 mechanical ops complete

## Commits / PRs
- `f162a5f` feat(mech-ops): Add intake_route router operation (ADR-048)
- `5e6871b` feat(pow): Enhance intake_and_route with validation step and improved schema (ADR-048)
- `b0b040c` feat(mech-ops): Add confirm_route entry operation (ADR-048)
- `60bcc4e` feat(mech-ops): Add spawn_pow_instance spawner operation (ADR-048)
- `6013152` docs: Update PROJECT_STATE for ADR-048 mechanical ops complete
- `565f9cc` docs: Update session log with ADR-048 mechanical ops
- `191b175` fix(pow): Use concierge_intake artifact name consistently (ADR-048)

## Open Threads
- Wire intake_and_route POW to actually execute (currently definition only)
- Integrate SpawnerHandler with ExecutionService to create actual child POW executions
- Add lineage fields to WorkflowExecution model (spawned_from_execution_id, spawned_by_operation_id)
- UX: Collapsed receipt view for completed Intake POW

## Known Risks / Drift Warnings
- LLM classification in Gate Profile has prompt ref parsing issue (`prompt:task:intake_gate:1.0.0` resolves incorrectly); fallback pattern matching works
- Dual workflow loading paths: PlanRegistry loads from `seed/workflows/`, AdminWorkbench uses PackageLoader with `combine-config/` - must keep in sync
- `seed/workflows/` must be synced with `combine-config/` for PlanRegistry to load correct versions
