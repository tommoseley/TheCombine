# Session Summary - 2026-02-20-2

## Scope
- WS-OPS-001: Transient LLM Error Recovery and Honest Gate Outcomes

## Decisions Made
- None (WS followed as written)

## Implemented
- `LLMOperationalError` exception class in `app/llm/models.py` with structured fields (provider, status_code, request_id, attempts)
- `request_id` and `retry_after_seconds` fields added to `LLMError` dataclass
- Enhanced `complete_with_retry()` in `BaseLLMProvider`: 0.5s base delay, 4x backoff (0.5/2/8s), jitter, retry-after support, raises `LLMOperationalError` on exhaustion
- `set_error_sequence()` on `MockLLMProvider` for multi-error test scenarios
- Fixed transport error retryability bug in `AnthropicProvider` (`httpx.RequestError` now `retryable=True`)
- Response header extraction in `AnthropicProvider` (`request-id`, `retry-after`, `x-should-retry`)
- Wired `complete_with_retry()` in `LoggingLLMService` (replaces direct `complete()` call)
- Honest error handling in `IntakeGateProfileExecutor`: `LLMOperationalError` returns `needs_user_input` with `reason=operational_error` instead of silent regex fallback
- `intake_operational_error` and `reason` added to `gate_profile_keys` in `plan_executor.py`
- `operational_error` field added to `IntakeStateResponse` in intake router
- `operationalError` state and `retryLastMessage` callback in `useConciergeIntake.js`
- Operational error panel with warning icon, "temporarily unavailable" message, and Retry button in `ConciergeIntakeSidecar.jsx`

## Updated or Created
- `app/llm/models.py` — LLMError fields, LLMOperationalError class
- `app/llm/providers/base.py` — Enhanced complete_with_retry()
- `app/llm/providers/anthropic.py` — Header extraction, transport error fix
- `app/llm/providers/mock.py` — set_error_sequence()
- `app/llm/__init__.py` — Export LLMOperationalError
- `app/domain/workflow/nodes/llm_executors.py` — Wire complete_with_retry()
- `app/domain/workflow/nodes/intake_gate_profile.py` — Honest error handling
- `app/domain/workflow/plan_executor.py` — gate_profile_keys expansion
- `app/api/v1/routers/intake.py` — operational_error field
- `spa/src/hooks/useConciergeIntake.js` — operationalError state, retryLastMessage
- `spa/src/components/ConciergeIntakeSidecar.jsx` — Error panel with retry
- `tests/tier1/test_llm_retry.py` — New (6 tests, criteria C1-C4)
- `tests/tier1/test_gate_honesty.py` — New (3 tests, criteria C5-C7)
- `tests/infrastructure/test_operational_error_ui.py` — New (5 tests, criteria C8-C9)
- `tests/unit/test_logged_llm_executor_workflow_id.py` — Updated mock for complete_with_retry compatibility

## Commits / PRs
- (pending commit)

## Open Threads
- Two pre-existing tier0 harness test failures (TestCriterion6CleanPass, TestWSCriterion3ScopePass) — not introduced by this WS
- Pre-existing circular import in `app.domain.workflow.__init__` prevents isolated test execution of workflow node tests

## Known Risks / Drift Warnings
- None
