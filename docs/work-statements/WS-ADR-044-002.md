# WS-ADR-044-002: Admin Workbench — Building Blocks Redesign

| | |
|---|---|
| **Status** | Accepted |
| **Date** | 2026-02-05 |
| **Scope** | Multi-commit |
| **Governing ADRs** | ADR-044 (Admin Workbench), ADR-045 (System Ontology) |
| **Governing Policies** | POL-WS-001 |

---

## Purpose

Redesign the Building Blocks section of the Admin Workbench to implement a unified Config Artifact model with kind-based filtering and consistent metadata across all artifact types.

**Current problems (observed):**

1. Building Blocks shows 4 distinct sections (Roles, Interactions, Schemas, Templates) with no unifying concept
2. Interactions and Schemas are derived from DCWs, creating duplication — clicking an Interaction navigates to the DCW's task_prompt, not a standalone artifact
3. Prompt fragments (roles, tasks, QA prompts, PGC context) have no unified editing model
4. No metadata (name, intent, tags) support for prompt fragments beyond templates
5. No "create new" flow for prompt fragments

**Target state:**

- **Prompt Fragments section** with kind filter (All | Roles | Tasks | QA | PGC) — content artifacts that shape behavior
- **Templates section** (separate) — composition artifacts with `$$TOKEN` slot structure
- **Schemas section** (separate) — validation artifacts requiring JSON editor
- Unified metadata model: all artifacts share `name`, `intent`, `tags[]`, `version`, `kind`
- Consistent editing experience: text editor for prompts/templates, JSON editor for schemas
- "New" creation flow for all Building Block types

---

## Governing References

- **ADR-044**: Admin Workbench — defines the three-panel layout and editing model
- **ADR-045 §7**: Left rail MUST be organized by abstraction level; Building Blocks contain reusable primitives
- **ADR-045**: Prompt Fragments shape behavior; Schemas define acceptability; Templates define composition structure
- **POL-WS-001**: Work Statement execution standard

---

## Scope

### Included

- Restructure `DocTypeBrowser.jsx` Building Blocks section
- Add kind filter component for Prompt Fragments
- Create unified `PromptFragmentEditor.jsx` for prompt artifacts
- Extend `meta.yaml` support to roles and other prompt fragment types
- Add backend support for listing prompt fragments by kind
- Add "New" creation buttons with workspace-scoped CRUD
- Update API models and routes for prompt fragment metadata

### Excluded

- No changes to POW or DCW sections of the left rail (completed in WS-ADR-044-001)
- No changes to the grouped tab bar (completed in WS-ADR-044-001)
- No changes to `StepWorkflowEditor` or `WorkflowEditorContent`
- No changes to `GitStatusPanel` or workspace lifecycle
- No changes to instance POW storage (ADR-046 scope)
- No changes to token replacement logic in templates

---

## Preconditions

1. WS-ADR-044-001 accepted and execution complete ✓
2. Template metadata support implemented (session 2026-02-05) ✓
3. Admin Workbench functional with current Building Blocks layout ✓

---

## Procedure

### Phase 1: Backend — Prompt Fragment Metadata

Target: `app/config/`, `app/api/`

**Step 1.1 — Extend metadata model**

Add to `app/config/package_model.py`:
- `PromptFragmentKind` enum: `role`, `task`, `qa`, `pgc`, `questions`
- `PromptFragment` dataclass with fields: `fragment_id`, `kind`, `version`, `content`, `name`, `intent`, `tags[]`
- `PromptFragment.from_path()` to load `meta.yaml` if present

**Step 1.2 — Add prompt fragment service**

Create `app/api/services/prompt_fragment_service.py`:
- `list_prompt_fragments(kind: Optional[PromptFragmentKind] = None)` → returns all fragments, optionally filtered by kind
- `get_prompt_fragment(fragment_id: str, version: str)` → returns fragment with content and metadata
- Discovery logic: scan `combine-config/prompts/roles/` for role fragments, derive task/qa/pgc from DCW packages

**Step 1.3 — Add API endpoints**

Add to `app/api/v1/routers/admin_workbench.py`:
- `GET /admin/workbench/prompt-fragments` → list all fragments with optional `?kind=` filter
- `GET /admin/workbench/prompt-fragments/{id}` → fragment detail with content and metadata

Response models:
```python
class PromptFragmentSummary(BaseModel):
    fragment_id: str
    kind: str
    version: str
    name: Optional[str] = None
    intent: Optional[str] = None
    tags: List[str] = []
    content_preview: Optional[str] = None

class PromptFragmentDetail(BaseModel):
    fragment_id: str
    kind: str
    version: str
    content: str
    name: Optional[str] = None
    intent: Optional[str] = None
    tags: List[str] = []
```

**Step 1.4 — Add workspace artifact support**

Extend `workspace_service.py` to handle prompt fragment artifacts:
- Artifact ID: `fragment:{id}:{version}:{kind}` where kind is `content` or `meta`
- Content path: `prompts/roles/{id}/releases/{version}/role.prompt.txt` (for roles)
- Meta path: `prompts/roles/{id}/releases/{version}/meta.yaml`

### Phase 2: Frontend — Kind Filter Component

Target: `spa/src/components/admin/`

**Step 2.1 — Create KindFilter component**

Create `spa/src/components/admin/KindFilter.jsx`:

Props:
- `kinds`: array of `{ id, label, count }` — available filter options
- `selectedKind`: string — current filter ('all' or specific kind)
- `onSelect`: function(kindId) — callback when filter changes

Render as horizontal pill/chip bar:
```
[ All (23) ] [ Roles (3) ] [ Tasks (7) ] [ QA (7) ] [ PGC (6) ]
```

Selected filter shows active styling (amber background or underline).

**Step 2.2 — Create usePromptFragments hook**

Create `spa/src/hooks/usePromptFragments.js`:
- Fetch fragments from `/admin/workbench/prompt-fragments`
- Provide `fragments`, `loading`, `error` state
- Provide `fragmentsByKind` computed grouping
- Provide `filterByKind(kind)` helper

### Phase 3: Frontend — Building Blocks Restructure

Target: `spa/src/components/admin/DocTypeBrowser.jsx`

**Step 3.1 — Replace Roles/Interactions with Prompt Fragments**

Replace current structure:
```
BUILDING BLOCKS
  ● Roles           3
  ● Interactions    7
  ● Schemas         7
  ● Templates       4
```

With new structure:
```
BUILDING BLOCKS
  ● Prompt Fragments  23
      [ All ] [ Roles ] [ Tasks ] [ QA ] [ PGC ]
      (filtered list of fragments)
  ● Templates          3
  ● Schemas            7
```

**Step 3.2 — Prompt Fragments section behavior**

When Prompt Fragments header is expanded:
1. Show KindFilter bar at top
2. Show flat list of fragments matching filter
3. Each fragment item displays: name (or fragment_id), kind badge, version
4. Click opens PromptFragmentEditor with the selected fragment
5. "+ New" button in header — opens creation dialog

**Step 3.3 — Preserve Templates section**

Templates remain a separate collapsible section:
- Uses existing `TemplateEditor.jsx` with metadata tab
- No kind filter (templates are a single kind)
- "+ New" button opens template creation dialog

**Step 3.4 — Preserve Schemas section**

Schemas remain a separate collapsible section:
- List extracted standalone schemas from `/admin/workbench/schemas`
- Click opens PromptEditor in schema-focused mode (existing behavior)
- JSON editor for content
- "+ New" button opens schema creation dialog

### Phase 4: Frontend — Prompt Fragment Editor

Target: `spa/src/components/admin/PromptFragmentEditor.jsx`

**Step 4.1 — Create PromptFragmentEditor component**

Create `spa/src/components/admin/PromptFragmentEditor.jsx`:

Props:
- `fragmentId`: string
- `version`: string
- `workspace`: workspace context for save operations

Features:
- Two tabs: **Metadata** and **Content**
- Metadata tab: name, intent (textarea), tags (chip input), kind (read-only badge)
- Content tab: CodeMirror editor with prompt content
- Auto-save with debounce (500ms) — matches existing pattern
- View-only mode when no workspace active

**Step 4.2 — Wire to AdminWorkbench**

Update `AdminWorkbench.jsx` to render `PromptFragmentEditor` when:
- `selection.type === 'prompt_fragment'`
- Pass `fragmentId`, `version`, `workspace` props

### Phase 5: Creation Flows

**Step 5.1 — New Prompt Fragment dialog**

When "+ New" clicked in Prompt Fragments section:
1. Modal dialog with fields: ID (slug), Kind (dropdown), Name
2. Validate ID is unique within kind
3. Create in workspace: `prompts/roles/{id}/releases/1.0.0/` (for role) with skeleton files
4. Navigate to new fragment in editor

**Step 5.2 — New Template dialog**

When "+ New" clicked in Templates section:
1. Modal dialog with fields: ID (slug), Name, Purpose (dropdown)
2. Create in workspace: `prompts/templates/{id}/releases/1.0.0/` with template.txt and meta.yaml
3. Navigate to new template in editor

**Step 5.3 — New Schema dialog**

When "+ New" clicked in Schemas section:
1. Modal dialog with fields: ID (slug), Name
2. Create in workspace: `schemas/{id}/releases/1.0.0/schema.json` with skeleton JSON Schema
3. Navigate to new schema in editor

---

## Prohibited Actions

- Do NOT change POW or DCW sections of the left rail
- Do NOT change the grouped tab bar structure
- Do NOT change `StepWorkflowEditor` or workflow editing behavior
- Do NOT change `GitStatusPanel` or workspace lifecycle
- Do NOT change how `selectedKind` state works in PromptEditor (DCW context)
- Do NOT introduce token replacement logic changes
- Do NOT create new CSS files — extend existing theme CSS
- Do NOT introduce external dependencies beyond existing

---

## Verification Checklist

### Backend

- [ ] `GET /admin/workbench/prompt-fragments` returns all fragments
- [ ] `GET /admin/workbench/prompt-fragments?kind=role` filters correctly
- [ ] `GET /admin/workbench/prompt-fragments/{id}` returns content and metadata
- [ ] Workspace artifact IDs `fragment:{id}:{version}:content` resolve correctly
- [ ] Workspace artifact IDs `fragment:{id}:{version}:meta` resolve correctly
- [ ] Role fragments discovered from `prompts/roles/`
- [ ] Task/QA/PGC fragments derived from DCW packages

### Left Rail

- [ ] Building Blocks shows three sections: Prompt Fragments, Templates, Schemas
- [ ] Prompt Fragments section is expandable with kind filter
- [ ] Kind filter pills show correct counts
- [ ] Selecting a kind filters the fragment list
- [ ] Fragment items show name, kind badge, version
- [ ] Clicking a fragment opens PromptFragmentEditor
- [ ] Templates section shows template list (unchanged behavior)
- [ ] Schemas section shows schema list (unchanged behavior)
- [ ] "+ New" buttons visible in each section header

### Editors

- [ ] PromptFragmentEditor displays with Metadata and Content tabs
- [ ] Metadata tab shows name, intent, tags, kind badge
- [ ] Content tab shows CodeMirror editor with prompt text
- [ ] Auto-save works (metadata and content)
- [ ] View-only mode works when no workspace active
- [ ] TemplateEditor still works (unchanged)
- [ ] Schema editing still works (unchanged)

### Creation Flows

- [ ] New Prompt Fragment creates skeleton files in workspace
- [ ] New Template creates template.txt and meta.yaml in workspace
- [ ] New Schema creates skeleton schema.json in workspace
- [ ] All creation flows navigate to new artifact after creation

### Visual

- [ ] Industrial theme renders correctly
- [ ] Light theme renders correctly
- [ ] Blueprint theme renders correctly
- [ ] Kind filter pills styled consistently with design system
- [ ] Count badges display correctly

---

## Definition of Done

1. All verification checklist items pass
2. No existing Admin Workbench functionality is lost or degraded
3. Building Blocks section matches unified Config Artifact model
4. Prompt fragments filterable by kind
5. All three themes render correctly
6. Creation flows work for all Building Block types
7. Human operator has visually verified the result

---

*End of Work Statement*
