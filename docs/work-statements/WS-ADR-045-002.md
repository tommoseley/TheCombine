# WS-ADR-045-002: POW Classification, Lineage, and Left Rail Grouping

**Status:** Complete
**Created:** 2026-02-04
**Scope:** Multi-commit (config + backend + frontend)
**ADR:** ADR-045 (Accepted)

---

## Purpose

Introduce structural classification for Project Orchestration Workflows (POWs) to prevent the inevitable "junk drawer" as the POW library grows. Add `pow_class`, derivation lineage, and tags to the POW definition schema. Group POWs by class in the Admin Workbench left rail.

This work establishes the metadata foundation that enables scaled POW management (hundreds of workflows across domains) without premature taxonomy. Instance storage (runtime, project-scoped POWs) is explicitly out of scope and covered by a separate ADR.

---

## Governing References

- **ADR-045**: System Ontology -- Primitives, Composites, and Configuration Taxonomy
- **ADR-044**: Admin Workbench with Git-Canonical Document Configuration
- **ADR-027**: Workflow Definition
- **WS-ADR-045-001**: Left Rail Restructure and Schema Extraction (Complete)

---

## Scope

### In Scope

- Extend POW definition schema with `pow_class`, `derived_from`, `source_version`, `tags`
- Mark existing `software_product_development` as `pow_class: reference`
- Update backend to parse, validate, and expose new POW metadata fields
- Update left rail to group POWs by class (Reference, Templates, Instances)
- Update "Create Workflow" flow to default to "Create Template from Reference"
- Update StepWorkflowEditor to display and edit new metadata fields

### Out of Scope

- Instance POW storage in database (separate ADR-046)
- Runtime project-workflow binding
- Drift detection / sync-with-reference features
- Tag normalization UI (autocomplete, alias merging) -- future enhancement
- Closed domain/intent/assurance enums -- tags cover this for now

---

## Preconditions

- [x] ADR-045 accepted
- [x] WS-ADR-045-001 complete (left rail restructured with Production Workflows group)
- [x] StepWorkflowEditor operational with create/delete/edit
- [x] `combine-config/workflows/` layout established

---

## Procedure

### Phase 1: POW Definition Schema Extension (Config + Backend)

**Goal:** Add classification and lineage fields to the POW definition schema.

**New fields in `definition.json`:**
```json
{
  "schema_version": "workflow.v2",
  "pow_class": "reference",
  "derived_from": null,
  "source_version": null,
  "tags": [],
  ...existing fields...
}
```

**Field definitions:**

| Field | Type | Required | Values | Description |
|-------|------|----------|--------|-------------|
| `pow_class` | string | Yes | `reference`, `template`, `instance` | Structural classification. `instance` included for forward compatibility but not valid in `combine-config/`. |
| `derived_from` | object or null | No | `{ "workflow_id": "...", "version": "..." }` | The POW this was forked from. Null for original reference POWs. |
| `source_version` | string or null | No | semver | The version of the source POW at fork time. |
| `tags` | string[] | No | free-form | Classification tags (domain, intent, etc.). No closed enum -- tags emerge from usage. |

**`schema_version` bump:** `workflow.v1` -> `workflow.v2`. Existing `v1` definitions are treated as `pow_class: reference` with no lineage (backward compatible).

**Steps:**
1. Update `software_product_development/releases/1.0.0/definition.json` with new fields
2. Update `list_orchestration_workflows()` in `admin_workbench_service.py` to include `pow_class`, `tags` in summaries
3. Update `get_workflow()` to expose all new fields
4. Add backward compatibility: if `pow_class` is missing, default to `reference`
5. Update admin workbench router response models with new fields

**Verification:**
- Existing workflow loads with `pow_class: reference`
- API returns new fields in list and detail responses
- Backend handles `v1` definitions without `pow_class` gracefully

---

### Phase 2: Left Rail Grouping by Class (Frontend)

**Goal:** Group POWs under Reference / Templates / Instances sub-sections in the left rail.

**Current structure:**
```
Production Workflows
  > Project Workflows
      Software Product Development
  > Document Workflows
      ...
```

**Target structure:**
```
Production Workflows
  > Reference Workflows
      Software Product Development
  > Template Workflows
      (none yet)
  > Document Workflows
      ...
```

Note: "Instances" sub-section is not shown until instance storage exists (Phase 4 / ADR-046). The sub-section will appear once instance POWs are loadable.

**Steps:**
1. Update `DocTypeBrowser.jsx` to split `workflows` array by `pow_class`
2. Render separate `SubSection` components for Reference, Templates (and Instances when non-empty)
3. Show `pow_class` badge or sublabel on each workflow item
4. Show `derived_from` lineage in sublabel for templates (e.g., "from Software Product Development v1.0.0")

**Verification:**
- Left rail shows "Reference Workflows" sub-section with existing workflow
- "Template Workflows" sub-section shows "(none)" or empty state
- Grouping is correct when multiple POWs exist with different classes

---

### Phase 3: Create Workflow UX (Frontend)

**Goal:** Make "Create Template from Reference" the default creation path.

**Current behavior:** "+ New" button on Project Workflows creates a blank workflow with only an ID.

**Target behavior:**
- Primary CTA: "Create Template from Reference" -- presents a picker of reference POWs, then forks with `derived_from` and `source_version` set
- Secondary CTA: "Create Blank (Advanced)" -- current behavior, sets `pow_class: template` by default
- Creating a reference POW requires editing `pow_class` manually (intentional friction)

**Steps:**
1. Replace the current "+ New" inline form with a creation dialog/dropdown
2. Add "From Reference" option that shows a list of reference POWs to fork
3. On fork: call existing create endpoint with `pow_class: template`, `derived_from`, `source_version` populated
4. Add "Blank Workflow" option (secondary) that creates with `pow_class: template`
5. Update workspace service create endpoint to accept new metadata fields

**Verification:**
- "From Reference" creates a template with correct lineage
- "Blank Workflow" creates a template with no lineage
- New workflows appear in the "Template Workflows" sub-section
- `derived_from` is visible in the editor metadata view

---

### Phase 4: Editor Metadata Display (Frontend)

**Goal:** Display and allow editing of POW classification and lineage in the StepWorkflowEditor.

**Steps:**
1. Add `pow_class` to the metadata view in StepWorkflowEditor (read-only for templates/instances, editable for new POWs)
2. Display `derived_from` with link/navigation to the source reference
3. Display `tags` as editable chip list
4. Display `source_version` in metadata view
5. Show visual indicator when viewing a reference POW ("Reference" badge in header)

**Verification:**
- Metadata view shows all new fields
- Tags can be added/removed
- `pow_class` badge visible in editor header
- `derived_from` navigates to source workflow when clicked

---

## Prohibited Actions

- Introducing instance POW storage in `combine-config/` or database (ADR-046 scope)
- Creating closed enums for domain, intent, or assurance level (tags only)
- Allowing `pow_class: instance` in `combine-config/` validation
- Removing backward compatibility for `workflow.v1` definitions
- Letting "Create POW" default to blank without an extra click

---

## Verification Checklist

- [x] `software_product_development` has `pow_class: reference` and `schema_version: workflow.v2`
- [x] Backend returns `pow_class`, `derived_from`, `source_version`, `tags` in workflow API responses
- [x] Backend defaults missing `pow_class` to `reference` for `v1` definitions
- [x] Left rail groups POWs by class (Reference, Templates)
- [x] "Create Template from Reference" is the primary creation path
- [x] "Create Blank" requires an extra step (secondary option)
- [x] New template POW has `derived_from` pointing to source reference
- [x] StepWorkflowEditor displays all new metadata fields
- [x] Tags are editable in the editor
- [x] All existing navigation and editing still works
- [x] 1900 tests pass (0 failures, 46 skipped)

---

## Definition of Done

- POW definition schema extended with `pow_class`, `derived_from`, `source_version`, `tags`
- Existing POW marked as `reference`
- Left rail groups POWs by class
- "Create from Reference" is the default creation path
- Editor displays and supports editing new metadata
- Backward compatibility preserved for `v1` definitions
- No regressions

---

## Dependencies

| Phase | Dependency |
|-------|------------|
| Phase 1: Schema Extension | None (can start immediately) |
| Phase 2: Left Rail Grouping | Phase 1 (needs `pow_class` in API response) |
| Phase 3: Create Workflow UX | Phase 1 (needs backend to accept new fields) |
| Phase 4: Editor Metadata | Phase 1 (needs fields available) |

Phases 2, 3, and 4 can proceed in parallel after Phase 1.

---

*End of WS-ADR-045-002*
