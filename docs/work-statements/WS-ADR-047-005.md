# WS-ADR-047-005: Concierge Intake Gate Refactoring

**Status:** In Progress (Phases 1-4 complete)
**Created:** 2026-02-07
**Scope:** Multi-commit (schemas + operations + workflow + cleanup)
**ADR:** ADR-047 (Accepted)

---

## Purpose

Refactor Concierge Intake from special-case handler code to a proper Gate Profile using the Mechanical Operations framework. The intake workflow should be explicitly composed of LLM passes, mechanical operations, and entry operations - no hidden logic.

---

## Governing References

- **ADR-047**: Mechanical Operations -- Non-LLM Building Blocks
- **WS-ADR-047-001**: Mechanical Operations Foundation (complete)
- **WS-ADR-047-004**: Handler Refactoring (complete)
- **POL-WS-001**: Standard Work Statements

---

## Background

Current Concierge Intake implementation has several issues:

1. **Mechanical masquerading as LLM**: `IntakeGateExecutor` uses regex pattern matching, not the `intake_gate` task prompt
2. **Missing schemas**: `concierge_entry` operation references `intake_classification.v1` and `intake_confirmation.v1` which don't exist
3. **Special-case code**: `plan_executor.py` lines 858-887 have manual phase tracking for intake
4. **Unused prompts**: Both `intake_gate` and `concierge_intent_reflection` task prompts exist but aren't used

Target architecture - Concierge Intake as a Gate Profile:

| Internal | Type | Purpose |
|----------|------|---------|
| Pass A | LLM | Classification (intake_gate task → intake_classification schema) |
| Extract | MECH | Extract audience, artifact_type, confidence from classification |
| Entry | UI | Concierge Entry - operator confirms/corrects |
| Pin | MECH | Lock confirmed intent into context_state |

---

## Scope

### In Scope

- Create missing schemas (intake_classification, intake_confirmation)
- Create intake extraction operation
- Create intake invariant pinner operation
- Update concierge_intake workflow definition to Gate structure
- Replace mechanical IntakeGateExecutor with LLM execution
- Remove special-case code from plan_executor.py
- Wire Entry operation to pause for operator confirmation

### Out of Scope

- Changes to downstream workflows (project_discovery, etc.)
- New UI components (Entry uses existing UI patterns)
- Changes to other Gate Profiles (PGC stays as-is)

---

## Preconditions

- [x] ADR-047 accepted
- [x] Entry operation type registered (WS-ADR-047-001)
- [x] EntryHandler implemented
- [x] concierge_entry operation exists (needs schema references fixed)
- [ ] Dev server running for testing

---

## Procedure

### Phase 1: Schema Definitions

**Goal:** Create the missing schemas that define data contracts.

**Schemas to create:**

#### 1.1 intake_classification.v1

Output of Pass A (LLM classification). Located at `combine-config/schemas/intake_classification/releases/1.0.0/schema.json`:

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://thecombine.ai/schemas/intake_classification.v1.json",
  "title": "Intake Classification",
  "description": "Output of LLM intake classification pass",
  "type": "object",
  "required": ["classification", "project_type", "intake_summary"],
  "properties": {
    "classification": {
      "type": "string",
      "enum": ["qualified", "needs_clarification", "out_of_scope"],
      "description": "Whether the intake is ready to proceed"
    },
    "project_type": {
      "type": "string",
      "enum": ["greenfield", "enhancement", "migration", "integration", "unknown"],
      "description": "Type of project being described"
    },
    "artifact_type": {
      "type": "string",
      "description": "Primary deliverable (web app, API, mobile app, etc.)"
    },
    "audience": {
      "type": "string",
      "description": "Who will use the artifact"
    },
    "intake_summary": {
      "type": "string",
      "description": "Concise summary of the intake request"
    },
    "confidence": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "LLM confidence in classification"
    },
    "missing_information": {
      "type": "array",
      "items": { "type": "string" },
      "description": "What information is missing for full qualification"
    },
    "classification_rationale": {
      "type": "string",
      "description": "Why this classification was chosen"
    }
  }
}
```

#### 1.2 intake_confirmation.v1

What the operator confirms/corrects. Located at `combine-config/schemas/intake_confirmation/releases/1.0.0/schema.json`:

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://thecombine.ai/schemas/intake_confirmation.v1.json",
  "title": "Intake Confirmation",
  "description": "Operator confirmation/correction of intake classification",
  "type": "object",
  "required": ["confirmed", "project_type", "artifact_type", "audience"],
  "properties": {
    "confirmed": {
      "type": "boolean",
      "description": "Whether operator confirms the classification as-is"
    },
    "project_type": {
      "type": "string",
      "enum": ["greenfield", "enhancement", "migration", "integration"],
      "description": "Confirmed project type"
    },
    "artifact_type": {
      "type": "string",
      "description": "Confirmed primary deliverable"
    },
    "audience": {
      "type": "string",
      "description": "Confirmed target audience"
    },
    "corrections": {
      "type": "object",
      "description": "Any corrections the operator made",
      "additionalProperties": { "type": "string" }
    },
    "notes": {
      "type": "string",
      "description": "Optional operator notes"
    }
  }
}
```

**Steps:**
1. Create `combine-config/schemas/intake_classification/releases/1.0.0/` directory
2. Create `schema.json` with intake_classification.v1 content
3. Create `combine-config/schemas/intake_confirmation/releases/1.0.0/` directory
4. Create `schema.json` with intake_confirmation.v1 content
5. Add both to `active_releases.json` under `schemas`
6. Verify schemas load via API

**Verification:**
- Schemas appear in `/admin/workbench/schemas` endpoint
- Schemas validate correctly

---

### Phase 2: Mechanical Operations

**Goal:** Create the intake-specific mechanical operations.

#### 2.1 intake_classification_extractor

Extract fields from LLM classification for downstream use.

Located at `combine-config/mechanical_ops/intake_classification_extractor/releases/1.0.0/operation.yaml`:

```yaml
$schema: https://thecombine.ai/schemas/mechanical-operation.v1.json
op_id: intake_classification_extractor
version: "1.0.0"
type: extractor
name: "Intake Classification Extractor"
description: "Extracts key fields from LLM intake classification"

config:
  source_type: intake_classification
  field_paths:
    - path: $.project_type
      as: project_type
    - path: $.artifact_type
      as: artifact_type
    - path: $.audience
      as: audience
    - path: $.intake_summary
      as: intake_summary
    - path: $.confidence
      as: confidence
  output_shape: extracted_intake_context

metadata:
  created_date: "2026-02-07"
  author: "system"
  tags:
    - intake
    - extraction
```

#### 2.2 intake_invariant_pinner

Pin confirmed intent fields as binding constraints.

Located at `combine-config/mechanical_ops/intake_invariant_pinner/releases/1.0.0/operation.yaml`:

```yaml
$schema: https://thecombine.ai/schemas/mechanical-operation.v1.json
op_id: intake_invariant_pinner
version: "1.0.0"
type: invariant_pinner
name: "Intake Invariant Pinner"
description: "Pins confirmed intake fields as binding constraints"

config:
  deduplicate: true
  source_field: "intake_confirmation"

metadata:
  created_date: "2026-02-07"
  author: "system"
  tags:
    - intake
    - invariant
    - pinning
```

**Steps:**
1. Create `intake_classification_extractor` operation directory and YAML
2. Create `intake_invariant_pinner` operation directory and YAML
3. Update `concierge_entry` operation to reference correct schema versions
4. Add operations to `active_releases.json`
5. Verify operations load via API

**Verification:**
- Operations appear in Building Blocks tray
- Operations load without errors

---

### Phase 3: Workflow Definition Update

**Goal:** Restructure concierge_intake workflow as a proper Gate Profile.

**Current structure (v1.3.0):**
- intake (intake_gate) → generation → qa → remediation → stabilized

**Target structure (v1.4.0):**
- intake_gate (Gate Profile):
  - pass_a: LLM classification
  - extract: MECH extraction
  - entry: UI confirmation
  - pin: MECH invariant pinning
- generation → qa → remediation → stabilized

**Steps:**
1. Create `combine-config/workflows/concierge_intake/releases/1.4.0/` directory
2. Create new `definition.json` with Gate Profile structure:
   ```json
   {
     "nodes": [
       {
         "node_id": "intake_gate",
         "type": "gate",
         "internals": {
           "pass_a": {
             "internal_type": "LLM",
             "task_ref": "prompt:task:intake_gate:1.0.0",
             "output_schema": "schema:intake_classification:1.0.0"
           },
           "extract": {
             "internal_type": "MECH",
             "op_ref": "mech:extractor:intake_classification_extractor:1.0.0"
           },
           "entry": {
             "internal_type": "UI",
             "op_ref": "mech:entry:concierge_entry:1.0.0"
           },
           "pin": {
             "internal_type": "MECH",
             "op_ref": "mech:invariant_pinner:intake_invariant_pinner:1.0.0"
           }
         }
       }
       // ... rest of workflow nodes
     ]
   }
   ```
3. Update `active_releases.json` to point to v1.4.0
4. Verify workflow loads and displays correctly in editor

**Verification:**
- Workflow definition validates against schema
- Gate node displays with 4 internals in editor
- Each internal shows correct type badge (LLM/MECH/UI)

---

### Phase 4: Executor Refactoring

**Goal:** Replace mechanical IntakeGateExecutor with proper Gate execution.

**Current behavior:**
- `IntakeGateExecutor` in `app/domain/workflow/nodes/intake_gate.py` does regex matching
- Returns `qualified` or asks clarifying questions mechanically

**Target behavior:**
- Gate executor processes internals in sequence
- pass_a: Invoke LLM with intake_gate task prompt
- extract: Execute intake_classification_extractor
- entry: Pause for operator (return pending_entry)
- pin: Execute intake_invariant_pinner after operator confirms
- Final outcome based on operator confirmation

**Steps:**
1. Create `GateExecutor` base class if not exists
2. Update `IntakeGateExecutor` to use Gate execution pattern
3. Wire LLM execution for pass_a using intake_gate task prompt
4. Wire mechanical operation execution for extract/pin
5. Wire Entry operation pause/resume for entry
6. Remove regex pattern matching logic
7. Write tests for new execution flow

**Verification:**
- Intake workflow executes through all Gate internals
- LLM classification matches intake_classification schema
- Entry pauses for operator
- Operator confirmation triggers pin execution
- Tests pass

---

### Phase 5: Cleanup

**Goal:** Remove special-case code and unused artifacts.

**Code to remove/refactor:**

1. **plan_executor.py lines 858-887**: Manual phase tracking for intake
   - Remove `_handle_intake_gate_phase()` or equivalent
   - Remove manual pause/advance logic
   - Let Gate execution handle it

2. **IntakeGateExecutor mechanical logic**:
   - Remove regex pattern matching
   - Remove manual clarifying question generation
   - Keep as thin wrapper for Gate execution

3. **Unused task prompts** (evaluate):
   - `concierge_intent_reflection` - keep or remove?
   - If intake_gate covers classification, may be redundant

**Steps:**
1. Identify all special-case intake code in plan_executor.py
2. Remove manual phase tracking
3. Remove mechanical sufficiency logic from IntakeGateExecutor
4. Run full test suite
5. Verify intake workflow works end-to-end

**Verification:**
- No special-case intake code remains
- All tests pass
- Intake workflow executes correctly with Gate Profile

---

## Prohibited Actions

- Modifying other Gate Profiles (PGC) during this refactoring
- Breaking existing intake workflow behavior before new flow is proven
- Removing task prompts without confirming they're unused
- Skipping test verification between phases

---

## Verification Checklist

- [x] intake_classification.v1 schema created and validates
- [x] intake_confirmation.v1 schema created and validates
- [x] intake_classification_extractor operation created
- [x] intake_invariant_pinner operation created
- [x] concierge_entry operation references correct schemas
- [x] Workflow definition updated to Gate Profile (v1.4.0)
- [x] GateNodeExecutor delegates to IntakeGateProfileExecutor for gates with internals
- [x] LLM classification executes with intake_gate task prompt (with fallback)
- [x] Entry operation pauses for operator confirmation
- [x] Invariant pinning executes after confirmation
- [ ] Special-case code removed from plan_executor.py (Phase 5)
- [x] All existing tests pass (38/38)
- [ ] End-to-end intake workflow works correctly (needs activation of v1.4.0)

---

## Definition of Done

- Concierge Intake is a Gate Profile with explicit internals
- All data flows through schemas (intake_classification, intake_confirmation)
- Mechanical operations handle extraction and pinning
- Entry operation pauses for operator confirmation
- No special-case intake code in plan_executor.py
- Workflow is visible and editable in Admin Workbench

---

## Dependencies

| Phase | Dependency |
|-------|------------|
| Phase 1: Schemas | None |
| Phase 2: Operations | Phase 1 (schemas must exist for references) |
| Phase 3: Workflow | Phase 2 (operations must exist) |
| Phase 4: Executor | Phase 3 (workflow must be updated) |
| Phase 5: Cleanup | Phase 4 (new execution must work first) |

All phases are sequential.

---

## Risk Notes

| Risk | Mitigation |
|------|------------|
| Breaking existing intake behavior | Keep old executor as fallback until new flow verified |
| Schema mismatch with task prompt output | Align schema with actual intake_gate task prompt output |
| Entry UI not rendering correctly | Test Entry with known-good data first |
| Missing test coverage | Write tests before refactoring each phase |

---

## Estimated Effort

| Phase | Effort |
|-------|--------|
| Phase 1: Schemas | Small - 2 JSON files |
| Phase 2: Operations | Small - 2 YAML files + updates |
| Phase 3: Workflow | Medium - restructure definition |
| Phase 4: Executor | Medium - significant code changes |
| Phase 5: Cleanup | Small - remove dead code |

---

*End of WS-ADR-047-005*
