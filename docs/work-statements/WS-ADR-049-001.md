# WS-ADR-049-001: DCW Decomposition -- Project Discovery

**Status:** Draft
**Created:** 2026-02-09
**Scope:** Multi-commit (workflow definition + gate configuration + UI verification)
**ADR:** ADR-049 (Accepted)

---

## Purpose

Decompose the `project_discovery` DCW from an opaque "Generate" step into explicit gates and passes, following the No Black Boxes principle. This is the first DCW decomposition that establishes the pattern for all others.

---

## Governing References

- **ADR-049**: No Black Boxes -- Explicit DCW Composition
- **ADR-047**: Mechanical Operations
- **ADR-045**: System Ontology -- Primitives, Composites, and Configuration Taxonomy
- **ADR-039**: Document Interaction Workflow Model
- **POL-WS-001**: Standard Work Statements

---

## Scope

### In Scope

- Decompose `project_discovery` DCW definition into explicit structure:
  - PGC Gate (question generation → entry → merge)
  - Generation Pass (LLM with full context)
  - QA Gate (evaluation → remediation loop)
- Create/update gate configurations for PGC and QA
- Verify Admin Workbench renders the decomposed structure
- Update CLAUDE.md with No Black Boxes principle reference
- Document the composition pattern for future DCW decompositions

### Out of Scope

- Decomposing `technical_architecture` (separate WS)
- Decomposing `implementation_plan` (separate WS)
- Workflow execution engine changes (DCW structure is already supported)
- New mechanical operations (use existing)
- UI collapse/expand enhancements (future work)

---

## Preconditions

- [x] ADR-049 accepted
- [x] ADR-047 mechanical operations infrastructure exists
- [x] Gate Profile pattern implemented (per WS-ADR-047-005)
- [x] `combine-config/workflows/project_discovery/` exists
- [x] Admin Workbench renders workflow definitions with internals

---

## Current State Analysis

**Current `project_discovery` structure (v1.8.0):**

The current definition likely has a simplified structure that doesn't expose internal gates. Need to examine the actual definition to understand what exists.

**Target structure:**

```
DCW: project_discovery (v2.0.0)
 │
 ├── node: pgc_gate (type: gate)
 │    ├── internal: pass_a (LLM) - Question Generation
 │    │    └── prompt_ref: prompt:task:pgc_discovery:1.0.0
 │    ├── internal: entry (UI) - Operator Answers
 │    │    └── schema_ref: schema:pgc_answers:1.0.0
 │    └── internal: merge (MECH) - Merge Answers
 │         └── op_ref: mech:merger:pgc_clarification_merge:1.0.0
 │
 ├── node: generation (type: task)
 │    └── internal: pass_a (LLM) - Document Generation
 │         └── prompt_ref: prompt:task:project_discovery:1.0.0
 │
 ├── node: qa_gate (type: gate)
 │    ├── internal: evaluate (LLM) - QA Evaluation
 │    │    └── prompt_ref: prompt:task:qa_discovery:1.0.0
 │    └── internal: remediate (conditional) - Remediation Loop
 │         └── max_attempts: 3
 │
 └── node: produce (type: end)
      └── outcome: stabilized
```

---

## Procedure

### Phase 1: Examine Current State

**Goal:** Understand current `project_discovery` DCW structure.

**Steps:**
1. Read current `project_discovery` definition from `combine-config/workflows/project_discovery/releases/`
2. Identify what exists vs what needs to be added
3. Document current prompts, schemas, and any existing gate structure
4. Identify required new artifacts (prompts, schemas, operations)

**Verification:**
- Current state documented
- Gap analysis complete

---

### Phase 2: Create Missing Artifacts

**Goal:** Create any missing prompts, schemas, or operations needed for explicit gates.

**Potential artifacts needed:**

| Artifact | Type | Purpose |
|----------|------|---------|
| `pgc_discovery` | Task prompt | PGC question generation for discovery |
| `qa_discovery` | Task prompt | QA evaluation for discovery documents |
| `pgc_answers` | Schema | Operator answer input schema |
| `qa_verdict_discovery` | Schema | QA verdict output schema |

**Steps:**
1. Identify which artifacts already exist (may be under different names)
2. Create missing task prompts in `combine-config/prompts/tasks/`
3. Create missing schemas in `combine-config/schemas/`
4. Update `active_releases.json` for new artifacts
5. Verify all artifacts load correctly

**Verification:**
- All required artifacts exist
- Artifacts pass schema validation
- PackageLoader resolves all references

---

### Phase 3: Update DCW Definition

**Goal:** Update `project_discovery` definition to v2.0.0 with explicit gate structure.

**Files to modify:**
- `combine-config/workflows/project_discovery/releases/2.0.0/definition.json` (create)
- `combine-config/workflows/_active/active_releases.json` (update)

**Definition structure:**

```json
{
  "schema_version": "workflow.v2",
  "workflow_id": "project_discovery",
  "revision": "dcwrev_2026_02_09_a",
  "effective_date": "2026-02-09",
  "name": "Project Discovery",
  "description": "Discovery document creation with PGC clarification and QA gates",
  "workflow_type": "dcw",

  "nodes": [
    {
      "node_id": "pgc_gate",
      "type": "gate",
      "name": "Clarification Gate",
      "internals": {
        "pass_a": {
          "internal_type": "LLM",
          "name": "Question Generation",
          "prompt_ref": "prompt:task:pgc_discovery:1.0.0",
          "schema_ref": "schema:pgc_questions:1.0.0"
        },
        "entry": {
          "internal_type": "UI",
          "name": "Operator Answers",
          "schema_ref": "schema:pgc_answers:1.0.0"
        },
        "merge": {
          "internal_type": "MECH",
          "name": "Merge Clarifications",
          "op_ref": "mech:merger:pgc_clarification_merge:1.0.0"
        }
      },
      "edges": [
        { "from": "pass_a", "to": "entry" },
        { "from": "entry", "to": "merge" }
      ]
    },
    {
      "node_id": "generation",
      "type": "task",
      "name": "Document Generation",
      "internal_type": "LLM",
      "prompt_ref": "prompt:task:project_discovery:1.0.0",
      "role_ref": "prompt:role:technical_architect:1.0.0",
      "schema_ref": "schema:project_discovery:1.0.0",
      "inputs": [
        { "from": "pgc_gate", "field": "clarifications" }
      ]
    },
    {
      "node_id": "qa_gate",
      "type": "gate",
      "name": "Quality Gate",
      "internals": {
        "evaluate": {
          "internal_type": "LLM",
          "name": "QA Evaluation",
          "prompt_ref": "prompt:task:qa_discovery:1.0.0",
          "schema_ref": "schema:qa_verdict:1.0.0"
        }
      },
      "remediation": {
        "enabled": true,
        "max_attempts": 3,
        "feedback_to": "generation"
      }
    },
    {
      "node_id": "produce",
      "type": "end",
      "name": "Stabilize Document",
      "produces": "project_discovery"
    }
  ],

  "edges": [
    { "from": "pgc_gate", "to": "generation", "outcome": "qualified" },
    { "from": "generation", "to": "qa_gate" },
    { "from": "qa_gate", "to": "produce", "outcome": "pass" },
    { "from": "qa_gate", "to": "generation", "outcome": "fail" }
  ],

  "entry_node": "pgc_gate",
  "terminal_outcomes": ["stabilized", "blocked", "abandoned"]
}
```

**Steps:**
1. Create v2.0.0 release directory
2. Write definition.json with explicit gate structure
3. Update active_releases.json to point to v2.0.0
4. Validate definition against workflow schema
5. Verify DCW loads correctly via API

**Verification:**
- Definition passes schema validation
- API returns decomposed structure
- All prompt/schema/op refs resolve

---

### Phase 4: Verify Admin Workbench Rendering

**Goal:** Confirm Admin Workbench correctly renders the decomposed DCW.

**Steps:**
1. Open Admin Workbench, navigate to Document Workflows
2. Select `project_discovery` v2.0.0
3. Verify:
   - PGC Gate shows with 3 internals (pass_a, entry, merge)
   - Generation node shows as LLM task
   - QA Gate shows with evaluate internal
   - Edges render correctly between nodes
4. Expand gate internals, verify internal details display
5. Screenshot or document any rendering issues

**Verification:**
- All nodes render
- Gate internals expand/collapse
- Internal types (LLM/MECH/UI) display correctly
- No console errors

---

### Phase 5: Update CLAUDE.md

**Goal:** Add No Black Boxes principle reference to CLAUDE.md.

**Add to Execution Constraints section:**

```markdown
- **No Black Boxes (ADR-049)**
  - Every DCW must be explicitly composed of gates, passes, and mechanical operations
  - "Generate" is deprecated as a step abstraction -- it hides too much
  - DCWs are first-class workflows, not opaque steps inside POWs
  - If a step does something non-trivial, it must show its passes
```

**Steps:**
1. Read current CLAUDE.md Execution Constraints section
2. Add No Black Boxes constraint
3. Verify formatting consistency

**Verification:**
- Constraint appears in CLAUDE.md
- Format matches existing constraints

---

## Prohibited Actions

- Modifying workflow execution engine mechanics
- Changing existing prompt content (only adding new prompts if needed)
- Removing backward compatibility for v1.x definitions
- Skipping schema validation
- Creating "stub" gates without real prompt/schema references
- Hardcoding values that should be configurable

---

## Verification Checklist

- [ ] Current `project_discovery` state documented
- [ ] All required prompts exist and load
- [ ] All required schemas exist and validate
- [ ] v2.0.0 definition created with explicit gates
- [ ] Definition passes workflow schema validation
- [ ] active_releases.json updated
- [ ] API returns decomposed structure
- [ ] Admin Workbench renders all nodes
- [ ] Gate internals expand correctly
- [ ] CLAUDE.md updated with No Black Boxes reference
- [ ] No regressions in existing functionality

---

## Definition of Done

- `project_discovery` v2.0.0 exists with explicit PGC Gate, Generation Pass, and QA Gate
- All artifact references (prompts, schemas, operations) resolve correctly
- Admin Workbench renders the decomposed structure
- CLAUDE.md includes No Black Boxes principle
- Pattern documented for subsequent DCW decompositions

---

## Subsequent Work Statements

This WS establishes the pattern. Following WSs will apply it to other DCWs:

- **WS-ADR-049-002**: Decompose `technical_architecture` (PGC + Gen + QA pattern)
- **WS-ADR-049-003**: Decompose `implementation_plan` (QA-only pattern)

---

*End of WS-ADR-049-001*
