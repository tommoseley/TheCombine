# WS-ADR-050-001: Tier 0 Verification Harness

## Status: Complete

## Governing References

- ADR-050 -- Work Statement Verification Constitution
- POL-WS-001 -- Standard Work Statements

## Verification Mode: A

---

## Purpose

Create a single-command Tier 0 harness that enforces baseline mechanical verification for all Combine work. This is the foundation that makes ADR-050 enforceable. Without it, the verification constitution is policy without teeth.

---

## Preconditions

- Combine repository is in a buildable state
- Backend test suite runs via pytest
- SPA builds via npm run build
- A linter is available or can be configured (ruff preferred)

---

## Scope

### Includes

- Tier 0 harness script (`ops/scripts/tier0.sh`)
- Backend test execution (pytest)
- Backend lint check
- Backend type check (if tooling available; otherwise document as bootstrap Mode B debt)
- Conditional frontend build (when frontend files touched or `--frontend` flag)
- File-scope validation (when `--scope` flag with allowed paths provided)
- Strict exit codes (non-zero on any failure)
- Structured output (pass/fail per check, summary)

### Excludes

- CI pipeline integration (future WS)
- Tier 1 test infrastructure
- Mode B tracking or Verification Debt artifacts
- B metrics instrumentation
- Dashboard or UI for results

---

## Tier 1 Verification Criteria

Tests must confirm the following. All tests must fail before implementation.

1. **Tier 0 returns non-zero when pytest fails**
   - Introduce a deliberately failing test, run harness, assert exit code != 0

2. **Tier 0 returns non-zero when lint fails**
   - Introduce a deliberate lint violation, run harness, assert exit code != 0

3. **Tier 0 returns non-zero when type check fails** (if type checker configured)
   - Introduce a deliberate type error, run harness, assert exit code != 0

4. **Tier 0 returns non-zero when frontend build fails** (when triggered)
   - Introduce a deliberate build error, run harness with `--frontend`, assert exit code != 0

5. **Tier 0 returns non-zero when scope validation fails**
   - Modify a file outside declared scope, run harness with `--scope`, assert exit code != 0

6. **Tier 0 returns zero on a clean repository**
   - Run harness with no violations present, assert exit code == 0

---

## Procedure

### Phase 1: Write Failing Tests

Write tests (or test scripts) that assert each Tier 1 criterion above. Verify all six fail because the harness does not yet exist.

Test approach: These may be shell-level integration tests or pytest tests that invoke the harness as a subprocess. The test mechanism is less important than the principle -- each criterion must have a failing assertion before implementation.

### Phase 2: Implement Harness

Create `ops/scripts/tier0.sh`:

1. **Backend tests**: Run `python -m pytest tests/ -x -q`. Capture exit code.
2. **Backend lint**: Run configured linter (e.g., `ruff check app/`). Capture exit code.
3. **Backend type check**: Run type checker if available (e.g., `mypy app/`). Capture exit code. If no type checker configured, skip with warning and document as Verification Debt.
4. **Frontend build** (conditional): If `--frontend` flag provided or frontend files detected in changed set, run `cd spa && npm run build`. Capture exit code.
5. **Scope validation** (conditional): If `--scope <allowed_paths>` provided, verify that only files within allowed paths have been modified (via git diff). Report violations. Capture exit code.
6. **Summary**: Print pass/fail for each check. Exit non-zero if any check failed.

Ensure the script:
- Is executable (`chmod +x`)
- Works from repository root
- Uses strict bash (`set -euo pipefail` for internal errors, but manages individual check exit codes explicitly)
- Prints clear output identifying which check(s) failed

### Phase 3: Verify Tier 1 Tests Pass

Run all six Tier 1 tests. All must now pass.

### Phase 4: Run Tier 0 on Clean Repo

Run the harness itself against the current repository state. It must return zero. If it does not, fix the baseline before considering the harness complete.

### Phase 5: Document

- Add harness usage to AI.md Quick Commands section
- Add brief README or inline comments in the script explaining each check

---

## Prohibited Actions

- Do not integrate into CI pipeline (that is a separate WS)
- Do not modify existing test infrastructure or test files (beyond the Tier 1 test additions)
- Do not add Python dependencies for the harness itself (shell script, not a Python tool)
- Do not create UI or dashboard for results
- Do not change any application code

---

## Verification Checklist

- [ ] All six Tier 1 tests fail before implementation
- [ ] Harness script exists at `ops/scripts/tier0.sh`
- [ ] Harness is executable and runs from repo root
- [ ] All six Tier 1 tests pass after implementation
- [ ] Harness returns zero on clean repo
- [ ] Harness usage documented in AI.md Quick Commands
- [ ] If type checker is not configured, a Verification Debt note is added to PROJECT_STATE.md

## Definition of Done

- Tier 0 harness exists, is documented, and returns correct exit codes for all defined failure and success conditions
- ADR-050 Section 5.1 is mechanically enforceable via a single command

---

_End of WS-ADR-050-001_
