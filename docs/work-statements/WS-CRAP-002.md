# WS-CRAP-002: Testability Refactoring -- API v1 Routers Batch 1

## Status: Draft (generated by crap-refactor skill)

## Parent Work Package
WP-CRAP-001: Testability Refactoring

## Target Functions

| # | CRAP | CC | Coverage | File | Function | Proposed Action |
|---|------|-----|----------|------|----------|-----------------|
| 1 | 2532.9 | 51 | 1.6% | app/api/v1/routers/projects.py:719 | get_document_render_model() | Extract render model assembly into service layer |
| 2 | 429.7 | 21 | 2.5% | app/api/v1/routers/projects.py:1089 | _repair_truncated_json() | Extract repair strategies into pure functions |
| 3 | 288.1 | 18 | 5.9% | app/api/v1/routers/projects.py:1237 | _resolve_answer_label() | Extract label resolution logic into pure function |
| 4 | 260.5 | 17 | 5.6% | app/api/v1/routers/projects.py:1171 | _build_pgc_from_context_state() | Extract PGC construction into standalone builder |
| 5 | 185.0 | 14 | 4.4% | app/api/v1/routers/interrupts.py:114 | resolve_interrupt() | Extract interrupt resolution logic from HTTP handling |
| 6 | 140.3 | 12 | 3.8% | app/api/v1/routers/production.py:205 | start_production() | Extract validation and orchestration setup |
| 7 | 112.9 | 11 | 5.6% | app/api/v1/routers/intake.py:140 | _extract_messages() | Extract message parsing into pure function |
| 8 | 99.2 | 12 | 15.4% | app/api/v1/routers/projects.py:1481 | list_work_packages() | Extract filtering and transformation logic |
| 9 | 95.0 | 10 | 5.3% | app/api/v1/routers/intake.py:177 | _build_state_response() | Extract state-to-response mapping |
| 10 | 91.3 | 10 | 6.7% | app/api/v1/routers/projects.py:541 | get_project_tree() | Extract tree construction into pure function |

## Refactoring Strategy

The API v1 Routers subsystem has the single worst function in the entire codebase:
get_document_render_model() at CC=51 and 1.6% coverage. The primary anti-pattern is
business logic embedded directly in route handlers rather than delegated to service classes.

For each target function:
- **get_document_render_model**: CC=51 is extreme. This function likely performs render model
  assembly, schema resolution, block mapping, and error handling all inline. Extract the core
  assembly logic into a dedicated service method that can be tested without HTTP context.
- **_repair_truncated_json**: JSON repair is inherently a pure function -- it takes a string
  and returns a string. Extract each repair strategy (bracket completion, quote balancing, etc.)
  into individually testable functions.
- **_resolve_answer_label / _build_pgc_from_context_state**: PGC-related transformations are
  pure data mapping. Extract from router into a PGC utility module.
- **resolve_interrupt**: Mix of interrupt type dispatch and HTTP error handling. Extract the
  dispatch logic.
- **start_production**: Validation and orchestration setup should be in the production service.
- **_extract_messages / _build_state_response**: Pure data transformations currently coupled
  to the request/response cycle.
- **list_work_packages**: Query filtering and result transformation should move to service.
- **get_project_tree**: Tree construction is a pure algorithm operating on document data.

## Acceptance Criteria
1. All target functions have CRAP score < 30 after refactoring
2. Test coverage for target functions is >= 70%
3. No behavioral changes (existing tests still pass)
4. Tier-0 green
5. New tests are Tier-1 (in-memory, no DB, no I/O)

## Prohibited Actions
- Do NOT change function signatures that are part of the public API
- Do NOT merge or delete existing test files
- Do NOT refactor functions not listed in Target Functions
- Do NOT add database dependencies to extracted functions

## Allowed Paths
- app/api/v1/routers/
- app/api/v1/services/
- tests/tier1/
