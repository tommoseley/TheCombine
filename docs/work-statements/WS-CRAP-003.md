# WS-CRAP-003: Testability Refactoring -- API Services Batch 1

## Status: Draft (generated by crap-refactor skill)

## Parent Work Package
WP-CRAP-001: Testability Refactoring

## Target Functions

| # | CRAP | CC | Coverage | File | Function | Proposed Action |
|---|------|-----|----------|------|----------|-----------------|
| 1 | 1020.7 | 32 | 1.2% | app/api/services/production_service.py:264 | get_production_tracks() | Split track assembly from data queries; extract track-building pure logic |
| 2 | 660.6 | 26 | 2.1% | app/api/services/admin_workbench_service.py:346 | AdminWorkbenchService.list_prompt_fragments() | Extract filtering, sorting, and enrichment into composable steps |
| 3 | 317.7 | 18 | 2.6% | app/api/services/mechanical_ops_service.py:200 | MechanicalOpsService.list_operations() | Extract operation classification and status derivation |
| 4 | 291.3 | 17 | 1.7% | app/api/services/qa_coverage_service.py:18 | get_qa_coverage() | Extract coverage computation into pure function |
| 5 | 250.7 | 16 | 2.9% | app/api/services/admin_workbench_service.py:813 | AdminWorkbenchService.list_orchestration_workflows() | Extract workflow enrichment and filtering logic |
| 6 | 249.4 | 16 | 3.0% | app/api/services/dashboard_service.py:40 | get_dashboard_summary() | Extract metric aggregation into testable functions |
| 7 | 247.2 | 16 | 3.3% | app/api/services/production_service.py:62 | _build_station_sequence_from_workflow() | Extract station sequencing algorithm |
| 8 | 197.5 | 14 | 2.2% | app/api/services/cost_service.py:21 | get_cost_dashboard_data() | Extract cost aggregation and formatting |
| 9 | 197.2 | 14 | 2.2% | app/api/services/transcript_service.py:86 | get_execution_transcript() | Extract transcript assembly from data fetching |
| 10 | 192.2 | 14 | 3.1% | app/api/services/admin_workbench_service.py:742 | AdminWorkbenchService.list_workflows() | Extract workflow filtering and enrichment |

## Refactoring Strategy

The API Services subsystem has 35 critical functions spread across production, admin workbench,
dashboard, and other services. The common pattern is service methods that perform both data
retrieval and complex transformation/aggregation inline.

For each target function:
- **get_production_tracks**: CC=32 indicates heavy conditional logic for track assembly.
  Separate data fetching (repository calls) from track-building (pure logic over dicts/lists).
- **list_prompt_fragments**: Complex filtering, sorting, and enrichment. Each can be a
  standalone pure function composed in a pipeline.
- **list_operations**: Operation status derivation from workflow state is pure logic.
- **get_qa_coverage**: Coverage computation is inherently a pure function on document data.
- **list_orchestration_workflows / list_workflows**: Repeated pattern of fetch + enrich + filter.
  Extract enrichment and filtering as reusable pure transforms.
- **get_dashboard_summary**: Metric aggregation over collections is testable without DB.
- **_build_station_sequence_from_workflow**: Graph/sequencing algorithm should be pure.
- **get_cost_dashboard_data**: Cost aggregation is arithmetic on structured data.
- **get_execution_transcript**: Transcript assembly from execution records is a pure transform.

## Acceptance Criteria
1. All target functions have CRAP score < 30 after refactoring
2. Test coverage for target functions is >= 70%
3. No behavioral changes (existing tests still pass)
4. Tier-0 green
5. New tests are Tier-1 (in-memory, no DB, no I/O)

## Prohibited Actions
- Do NOT change function signatures that are part of the public API
- Do NOT merge or delete existing test files
- Do NOT refactor functions not listed in Target Functions
- Do NOT add database dependencies to extracted functions

## Allowed Paths
- app/api/services/
- tests/tier1/
