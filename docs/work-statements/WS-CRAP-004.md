# WS-CRAP-004: Testability Refactoring -- Document Handlers Batch 1

## Status: Draft (generated by crap-refactor skill)

## Parent Work Package
WP-CRAP-001: Testability Refactoring

## Target Functions

| # | CRAP | CC | Coverage | File | Function | Proposed Action |
|---|------|-----|----------|------|----------|-----------------|
| 1 | 506.0 | 22 | 0.0% | app/api/services/mech_handlers/invariant_pinner.py:34 | InvariantPinnerHandler.execute() | Extract pinning logic into pure function; add first tests |
| 2 | 356.5 | 19 | 2.2% | app/domain/handlers/project_discovery_handler.py:129 | ProjectDiscoveryHandler.render() | Extract section rendering into composable pure functions |
| 3 | 272.0 | 16 | 0.0% | app/api/services/mech_handlers/exclusion_filter.py:35 | ExclusionFilterHandler.execute() | Extract filter predicates and item matching |
| 4 | 210.0 | 14 | 0.0% | app/api/services/mech_handlers/spawner.py:51 | SpawnerHandler.execute() | Extract spawn decision logic from document creation |
| 5 | 192.7 | 14 | 3.0% | app/domain/handlers/pipeline_run_handler.py:30 | PipelineRunHandler.render() | Extract pipeline status derivation and section assembly |
| 6 | 185.5 | 14 | 4.3% | app/domain/handlers/architecture_spec_handler.py:80 | ArchitectureSpecHandler.transform() | Extract transformation rules into pure functions |
| 7 | 156.0 | 12 | 0.0% | app/api/services/mech_handlers/merger.py:51 | MergerHandler.execute() | Extract merge strategy selection and value merging |
| 8 | 132.0 | 11 | 0.0% | app/api/services/mech_handlers/validator.py:122 | ValidatorHandler._validate_field() | Extract field validation rules into pure predicates |
| 9 | 110.0 | 10 | 0.0% | app/api/services/mech_handlers/router.py:52 | RouterHandler.execute() | Extract routing logic from handler lifecycle |
| 10 | 110.0 | 10 | 0.0% | app/api/services/mech_handlers/extractor.py:48 | ExtractorHandler.execute() | Extract extraction logic from handler lifecycle |

## Refactoring Strategy

The Document Handlers subsystem has a severe coverage gap: 10 of the 31 critical functions have
0.0% test coverage, all in the mech_handlers directory. These mechanical handlers perform
deterministic data transformations that are ideal candidates for pure-function extraction.

For each target function:
- **InvariantPinnerHandler.execute**: Pinning invariants to documents is fundamentally a
  data transformation. Extract the pinning logic (what gets pinned, where, with what value)
  into a pure function that takes inputs and returns outputs.
- **ProjectDiscoveryHandler.render**: Large rendering method that builds multiple sections.
  Each section builder should be an independently testable function.
- **ExclusionFilterHandler.execute**: Filter predicate application is inherently pure.
  Extract the predicate matching and item filtering.
- **SpawnerHandler.execute**: Spawn decisions (which documents to create, with what params)
  are deterministic based on input data.
- **PipelineRunHandler.render**: Pipeline status derivation and section assembly are separable.
- **ArchitectureSpecHandler.transform**: Transformation rules can be extracted as pure functions.
- **MergerHandler.execute / _merge_values**: Merge strategies are pure data operations.
- **ValidatorHandler._validate_field**: Field validation rules are pure predicates.
- **RouterHandler.execute / ExtractorHandler.execute**: Core routing/extraction logic is
  independent of handler lifecycle.

Note: All mech_handlers at 0% coverage represent the highest-ROI refactoring targets.
Adding any tests at all will dramatically reduce CRAP scores.

## Acceptance Criteria
1. All target functions have CRAP score < 30 after refactoring
2. Test coverage for target functions is >= 70%
3. No behavioral changes (existing tests still pass)
4. Tier-0 green
5. New tests are Tier-1 (in-memory, no DB, no I/O)

## Prohibited Actions
- Do NOT change function signatures that are part of the public API
- Do NOT merge or delete existing test files
- Do NOT refactor functions not listed in Target Functions
- Do NOT add database dependencies to extracted functions

## Allowed Paths
- app/domain/handlers/
- app/api/services/mech_handlers/
- tests/tier1/
