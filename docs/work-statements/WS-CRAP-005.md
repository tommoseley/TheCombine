# WS-CRAP-005: Testability Refactoring -- Domain Services Batch 1

## Status: Draft (generated by crap-refactor skill)

## Parent Work Package
WP-CRAP-001: Testability Refactoring

## Target Functions

| # | CRAP | CC | Coverage | File | Function | Proposed Action |
|---|------|-----|----------|------|----------|-----------------|
| 1 | 229.8 | 15 | 1.5% | app/domain/services/document_builder.py:417 | DocumentBuilder.build_stream() | Extract stream chunking and assembly from LLM calls |
| 2 | 167.5 | 13 | 2.9% | app/domain/services/prompt_assembler.py:86 | PromptAssembler.assemble() | Extract fragment resolution and template rendering |
| 3 | 140.6 | 12 | 3.7% | app/domain/services/render_model_builder.py:745 | RenderModelBuilder._process_derived_section() | Extract derivation rules into pure function |
| 4 | 116.2 | 11 | 4.5% | app/domain/services/render_model_builder.py:448 | RenderModelBuilder._compute_schema_bundle_sha256() | Extract hash computation into standalone pure function |
| 5 | 98.9 | 10 | 3.8% | app/domain/services/render_model_builder.py:666 | RenderModelBuilder._process_container_with_repeat() | Extract repeat logic from container processing |
| 6 | 98.5 | 10 | 4.0% | app/domain/services/render_model_builder.py:298 | RenderModelBuilder.build() | Extract shape dispatch table from orchestration |
| 7 | 97.5 | 10 | 4.3% | app/domain/services/render_model_builder.py:586 | RenderModelBuilder._process_nested_list_shape() | Extract list flattening and nesting logic |
| 8 | 83.1 | 9 | 2.9% | app/domain/services/document_builder.py:356 | DocumentBuilder.build() | Extract build orchestration from side effects |
| 9 | 78.4 | 9 | 5.0% | app/domain/services/render_model_builder.py:813 | RenderModelBuilder._resolve_pointer() | Extract JSON pointer resolution into pure function |
| 10 | 77.2 | 9 | 5.6% | app/domain/services/render_model_builder.py:710 | RenderModelBuilder._build_parent_as_data() | Extract parent data assembly |

## Refactoring Strategy

The Domain Services subsystem has two main concentrations of CRAP debt:
RenderModelBuilder (9 critical functions) and DocumentBuilder (5 critical functions).

For RenderModelBuilder:
- 7 of the 10 target functions are in this class. The primary pattern is shape-processing
  methods that mix schema traversal with block construction. Each shape processor
  (_process_derived_section, _process_container_with_repeat, _process_nested_list_shape, etc.)
  should have its core logic extracted into a pure function that takes schema + data and
  returns block definitions.
- **_compute_schema_bundle_sha256**: Hash computation is inherently pure. Extract it.
- **_resolve_pointer**: JSON pointer resolution is a well-defined algorithm.
- **build()**: The main orchestration method mixes shape dispatch with lifecycle management.
  Extract the dispatch table.

For DocumentBuilder:
- **build_stream()**: Streaming adds complexity on top of the core build logic. Separate
  stream chunking from content assembly.
- **build()**: Extract the orchestration sequence from side effects (persistence, logging).

For PromptAssembler:
- **assemble()**: Fragment resolution and Jinja template rendering are independently testable
  concerns. Extract each.

## Acceptance Criteria
1. All target functions have CRAP score < 30 after refactoring
2. Test coverage for target functions is >= 70%
3. No behavioral changes (existing tests still pass)
4. Tier-0 green
5. New tests are Tier-1 (in-memory, no DB, no I/O)

## Prohibited Actions
- Do NOT change function signatures that are part of the public API
- Do NOT merge or delete existing test files
- Do NOT refactor functions not listed in Target Functions
- Do NOT add database dependencies to extracted functions

## Allowed Paths
- app/domain/services/
- tests/tier1/
