# WS-CRAP-006: Testability Refactoring -- Web Routes Batch 1

## Status: Draft (generated by crap-refactor skill)

## Parent Work Package
WP-CRAP-001: Testability Refactoring

## Target Functions

| # | CRAP | CC | Coverage | File | Function | Proposed Action |
|---|------|-----|----------|------|----------|-----------------|
| 1 | 333.0 | 19 | 4.5% | app/web/routes/public/intake_workflow_routes.py:708 | _build_completion_context() | Extract completion data assembly into pure function |
| 2 | 237.9 | 16 | 4.7% | app/web/routes/public/document_routes.py:253 | get_document() | Extract document retrieval logic from template rendering |
| 3 | 218.9 | 15 | 3.2% | app/web/routes/public/intake_workflow_routes.py:491 | _build_template_context() | Extract context building into composable pure functions |
| 4 | 143.3 | 12 | 3.0% | app/web/routes/public/workflow_build_routes.py:172 | _render_workflow_state() | Extract state-to-template-vars mapping |
| 5 | 82.9 | 9 | 3.0% | app/web/routes/public/view_routes.py:89 | FragmentRenderer._resolve_fragment() | Extract fragment resolution logic |
| 6 | 73.9 | 9 | 7.1% | app/web/routes/public/project_routes.py:213 | get_project_documents_status() | Extract status derivation from HTTP handling |
| 7 | 72.7 | 9 | 7.7% | app/web/routes/public/project_routes.py:424 | soft_delete_project() | Extract deletion validation logic |
| 8 | 58.3 | 8 | 7.7% | app/web/routes/public/intake_workflow_routes.py:433 | get_intake_status() | Extract status computation from response building |
| 9 | 49.9 | 7 | 4.3% | app/web/routes/public/workflow_build_routes.py:101 | _parse_pgc_form() | Extract form parsing into pure function |
| 10 | 46.5 | 7 | 6.9% | app/web/routes/public/intake_workflow_routes.py:80 | start_intake_workflow() | Extract workflow initialization from HTTP handling |

## Refactoring Strategy

The Web Routes subsystem has 19 critical functions concentrated in four route modules:
intake_workflow_routes (6), project_routes (4), workflow_build_routes (4), and
document_routes (2). The pervasive anti-pattern is template context construction logic
embedded directly in route handlers.

For each target function:
- **_build_completion_context / _build_template_context**: These are context-builder functions
  that should already be pure, but their high CC suggests they contain conditional logic
  that varies context based on state. Extract the conditional branches into smaller,
  focused context-building functions.
- **get_document**: Mixes document retrieval, format detection, and template selection.
  Extract format detection and template context building.
- **_render_workflow_state**: State-to-template-variable mapping is a pure transformation.
  Extract the mapping table/logic.
- **FragmentRenderer._resolve_fragment**: Fragment resolution algorithm should be extractable
  as a pure function operating on fragment definitions.
- **get_project_documents_status**: Status derivation from document collections is pure logic.
- **soft_delete_project**: Deletion validation (can this project be deleted?) is a pure
  predicate on project state.
- **get_intake_status**: Status computation from workflow state is pure.
- **_parse_pgc_form**: Form parsing is inherently a pure data transformation.
- **start_intake_workflow**: Workflow initialization logic vs HTTP response building.

## Acceptance Criteria
1. All target functions have CRAP score < 30 after refactoring
2. Test coverage for target functions is >= 70%
3. No behavioral changes (existing tests still pass)
4. Tier-0 green
5. New tests are Tier-1 (in-memory, no DB, no I/O)

## Prohibited Actions
- Do NOT change function signatures that are part of the public API
- Do NOT merge or delete existing test files
- Do NOT refactor functions not listed in Target Functions
- Do NOT add database dependencies to extracted functions

## Allowed Paths
- app/web/routes/
- app/web/bff/
- tests/tier1/
